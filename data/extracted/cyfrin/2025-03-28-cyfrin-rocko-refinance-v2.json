{
  "doc_id": "cyfrin_2025-03-28-cyfrin-rocko-refinance-v2.0",
  "source_pdf": "2025-03-28-cyfrin-rocko-refinance-v2.0.md",
  "source_mtime": "2025-11-01T12:04:59+00:00",
  "extracted_at": "2025-11-16T22:12:10.180596+00:00",
  "extractor_version": "poc-0.4-md-no-llm",
  "repositories": [
    {
      "url": "https://github.com/OpenZeppelin/openzeppelin-contracts",
      "org": "OpenZeppelin",
      "repo": "openzeppelin-contracts",
      "commit": "fda6b85f2c65d146b86d513a604554d15abd6679",
      "evidence": {
        "page": null,
        "snippet": "Consider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/..."
      }
    },
    {
      "url": "https://github.com/Vectorized/solady",
      "org": "Vectorized",
      "repo": "solady",
      "commit": "c9e079c0ca836dcc52777a1fa7227ef28e3537b3",
      "evidence": {
        "page": null,
        "snippet": "Consider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/..."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "a59ba0e7958c544ad95788ce29923a342a2ea35a",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a)."
      }
    },
    {
      "url": "https://github.com/OpenZeppelin/openzeppelin-contracts",
      "org": "OpenZeppelin",
      "repo": "openzeppelin-contracts",
      "commit": null,
      "evidence": {
        "page": null,
        "snippet": "**Recommended Mitigation:** Replace all uses of `IERC20::approve` with [`SafeERC20::forceApprove`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeER..."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "751e906b7c2df6cb587e709b12de25593eb02c75",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "ec9f5be20f9249cd20fcc1e173192361ecd97ef5",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [ec9f5be](https://github.com/getrocko/onchain/commit/ec9f5be20f9249cd20fcc1e173192361ecd97ef5)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "f5c9c8051d5ba1bf04774ae6e8aa407aeddbcde1",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [f5c9c80](https://github.com/getrocko/onchain/commit/f5c9c8051d5ba1bf04774ae6e8aa407aeddbcde1)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "99a73dc20fce34811c224fdd46b7e173748bfeb8",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [99a73dc](https://github.com/getrocko/onchain/commit/99a73dc20fce34811c224fdd46b7e173748bfeb8)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "5ef86b44063a988afed93fe3f69074be757768bd",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [5ef86b4](https://github.com/getrocko/onchain/commit/5ef86b44063a988afed93fe3f69074be757768bd)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "1da67d7f3ae8076a6cc135ef9a6e5595ad6e29a2",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [1da67d7](https://github.com/getrocko/onchain/commit/1da67d7f3ae8076a6cc135ef9a6e5595ad6e29a2)."
      }
    },
    {
      "url": "https://github.com/aave/aave-v3-core",
      "org": "aave",
      "repo": "aave-v3-core",
      "commit": "782f51917056a53a2c228701058a6c3fb233684a",
      "evidence": {
        "page": null,
        "snippet": "Instead of all this, simply use Aave's API function [`IPool::getReserveData`](https://github.com/aave/aave-v3-core/blob/782f51917056a53a2c228701058a6c3fb233684a/contracts/interfaces/IPool.sol#L582) to..."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "d793f960598240fa3eacdc6a4ec67d55dcfa2a75",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [d793f96](https://github.com/getrocko/onchain/commit/d793f960598240fa3eacdc6a4ec67d55dcfa2a75)."
      }
    },
    {
      "url": "https://github.com/aave/aave-v3-core",
      "org": "aave",
      "repo": "aave-v3-core",
      "commit": null,
      "evidence": {
        "page": null,
        "snippet": "For Aave, users must allow the refinance contract to spend the [AToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/AToken.sol) to close the position and to spend ..."
      }
    },
    {
      "url": "https://github.com/compound-finance/comet",
      "org": "compound-finance",
      "repo": "comet",
      "commit": "68cd639c67626c86e890e5aac775ad4b6405d923",
      "evidence": {
        "page": null,
        "snippet": "For Compound (Comet), users must allow the refinance contract by calling the [allow function](https://github.com/compound-finance/comet/blob/68cd639c67626c86e890e5aac775ad4b6405d923/contracts/CometExt..."
      }
    },
    {
      "url": "https://github.com/morpho-org/morpho-blue",
      "org": "morpho-org",
      "repo": "morpho-blue",
      "commit": "9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c",
      "evidence": {
        "page": null,
        "snippet": "For Morpho, users must authorize the refinance protocol by calling the [setAuthorization](https://github.com/morpho-org/morpho-blue/blob/9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c/src/Morpho.sol#L437C14..."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "675f4b2e59cddf6c3f9f2e866f4401564bd0a006",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [675f4b2](https://github.com/getrocko/onchain/commit/675f4b2e59cddf6c3f9f2e866f4401564bd0a006)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "2c50838a5cc5e498a14874a5d3348da20087e6bc",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [2c50838](https://github.com/getrocko/onchain/commit/2c50838a5cc5e498a14874a5d3348da20087e6bc)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "5a9aa7d3cfb80150448608854440c285ea08fa53",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [5a9aa7d](https://github.com/getrocko/onchain/commit/5a9aa7d3cfb80150448608854440c285ea08fa53)."
      }
    },
    {
      "url": "https://github.com/getrocko/onchain",
      "org": "getrocko",
      "repo": "onchain",
      "commit": "a8efb43b10673508e1fd184aec23a5373f73cd5d",
      "evidence": {
        "page": null,
        "snippet": "**Rocko:** Fixed in commit [a8efb43](https://github.com/getrocko/onchain/commit/a8efb43b10673508e1fd184aec23a5373f73cd5d)."
      }
    }
  ],
  "report_schema": [
    {
      "key": "Severity",
      "meaning": "How serious the impact of this finding is.",
      "expected_values": "Informational / Low / Medium / High"
    },
    {
      "key": "Difficulty",
      "meaning": "How hard it is to exploit this vulnerability.",
      "expected_values": "Low / Medium / High"
    },
    {
      "key": "Type",
      "meaning": "The category or nature of the vulnerability.",
      "expected_values": "String describing the type of vulnerability (e.g., Data Validation, Reentrancy)"
    },
    {
      "key": "Finding ID",
      "meaning": "A unique identifier for the specific finding.",
      "expected_values": "String with a consistent format (e.g., TOB-ELA-1)"
    },
    {
      "key": "Target",
      "meaning": "The location of the vulnerability in the codebase.",
      "expected_values": "Path to affected file / contract"
    }
  ],
  "vulnerability_sections": [
    {
      "index": 1,
      "page_start": null,
      "heading": "1. Protocol fee should round up in favor of the protocol",
      "markdown": "### Protocol fee should round up in favor of the protocol\n\n**Description:** Protocol fee should round up in favor of the protocol in `onMorphoFlashLoan`:\n```solidity\nuint256 rockoFeeBP = ROCKO_FEE_BP;\nif (rockoFeeBP > 0) {\n    unchecked {\n        feeAmount = (flashBorrowAmount * rockoFeeBP) / BASIS_POINTS_DIVISOR;\n        borrowAmountWithFee += feeAmount;\n    }\n}\n```\n\nConsider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/contracts/utils/math/Math.sol#L280) with the rounding parameter or Solady [`FixedPointMathLib::fullMulDivUp`](https://github.com/Vectorized/solady/blob/c9e079c0ca836dcc52777a1fa7227ef28e3537b3/src/utils/FixedPointMathLib.sol#L548).\n\nAnother benefit of using these libraries is that intermediate overflow from the multiplication of `flashBorrowAmount * rockoFeeBP` is avoided.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Low",
      "start_line": 15,
      "end_line": 37,
      "markdown_raw": "### Protocol fee should round up in favor of the protocol\n\n**Description:** Protocol fee should round up in favor of the protocol in `onMorphoFlashLoan`:\n```solidity\nuint256 rockoFeeBP = ROCKO_FEE_BP;\nif (rockoFeeBP > 0) {\n    unchecked {\n        feeAmount = (flashBorrowAmount * rockoFeeBP) / BASIS_POINTS_DIVISOR;\n        borrowAmountWithFee += feeAmount;\n    }\n}\n```\n\nConsider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/contracts/utils/math/Math.sol#L280) with the rounding parameter or Solady [`FixedPointMathLib::fullMulDivUp`](https://github.com/Vectorized/solady/blob/c9e079c0ca836dcc52777a1fa7227ef28e3537b3/src/utils/FixedPointMathLib.sol#L548).\n\nAnother benefit of using these libraries is that intermediate overflow from the multiplication of `flashBorrowAmount * rockoFeeBP` is avoided.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Protocol fee should round up in favor of the protocol in `onMorphoFlashLoan`:\n```solidity\nuint256 rockoFeeBP = ROCKO_FEE_BP;\nif (rockoFeeBP > 0) {\n    unchecked {\n        feeAmount = (flashBorrowAmount * rockoFeeBP) / BASIS_POINTS_DIVISOR;\n        borrowAmountWithFee += feeAmount;\n    }\n}\n```\n\nConsider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/contracts/utils/math/Math.sol#L280) with the rounding parameter or Solady [`FixedPointMathLib::fullMulDivUp`](https://github.com/Vectorized/solady/blob/c9e079c0ca836dcc52777a1fa7227ef28e3537b3/src/utils/FixedPointMathLib.sol#L548).\n\nAnother benefit of using these libraries is that intermediate overflow from the multiplication of `flashBorrowAmount * rockoFeeBP` is avoided.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Protocol fee should round up in favor of the protocol in `onMorphoFlashLoan`:\n```solidity\nuint256 rockoFeeBP = ROCKO_FEE_BP;\nif (rockoFeeBP > 0) {\n    unchecked {\n        feeAmount = (flashBorrowAmount * rockoFeeBP) / BASIS_POINTS_DIVISOR;\n        borrowAmountWithFee += feeAmount;\n    }\n}\n```\n\nConsider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/contracts/utils/math/Math.sol#L280) with the rounding parameter or Solady [`FixedPointMathLib::fullMulDivUp`](https://github.com/Vectorized/solady/blob/c9e079c0ca836dcc52777a1fa7227ef28e3537b3/src/utils/FixedPointMathLib.sol#L548).\n\nAnother benefit of using these libraries is that intermediate overflow from the multiplication of `flashBorrowAmount * rockoFeeBP` is avoided.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Protocol fee should round up in favor of the protocol in `onMorphoFlashLoan`:\n```solidity\nuint256 rockoFeeBP = ROCKO_FEE_BP;\nif (rockoFeeBP > 0) {\n    unchecked {\n        feeAmount = (flashBorrowAmount * rockoFeeBP) / BASIS_POINTS_DIVISOR;\n        borrowAmountWithFee += feeAmount;\n    }\n}\n```\n\nConsider [using](https://x.com/DevDacian/status/1892529633104396479) OpenZeppelin [`Math::mulDiv`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/fda6b85f2c65d146b86d513a604554d15abd6679/contracts/utils/math/Math.sol#L280) with the rounding parameter or Solady [`FixedPointMathLib::fullMulDivUp`](https://github.com/Vectorized/solady/blob/c9e079c0ca836dcc52777a1fa7227ef28e3537b3/src/utils/FixedPointMathLib.sol#L548).\n\nAnother benefit of using these libraries is that intermediate overflow from the multiplication of `flashBorrowAmount * rockoFeeBP` is avoided.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Low",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Protocol fee should round up in favor of the protocol"
    },
    {
      "index": 2,
      "page_start": null,
      "heading": "2. Refinancing reverts for USDT debt token",
      "markdown": "### Refinancing reverts for `USDT` debt token\n\n**Description:** Refinancing reverts for `USDT` debt token due to the way protocol uses standard `IERC20::approve` and `transfer` functions.\n\n**Impact:** Refinancing is bricked for `USDT` debt tokens. Marked as Low severity as officially only `USDC` is supported at this time. Note the implementation of `USDT` is different across chains; the protocol \"as-is\" would work with `USDT` on Base but not on Ethereum mainnet.\n\n**Proof of Concept:** As part of the audit we have provided a fork fuzz testing suite; run this command: `forge test --fork-url ETH_RPC_URL --fork-block-number 22000000 --match-test test_FuzzRefinance_AaveToCompound_DepWeth_BorUsdt -vvv`\n\n**Recommended Mitigation:** Replace all uses of `IERC20::approve` with [`SafeERC20::forceApprove`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L101-L108) and `IERC20::transfer` with `SafeERC20::safeTransfer` at L738, then re-run the PoC test and it now passes.\n\nIdeally for added safety to prevent front-running of changes to existing approvals, use [`SafeERC20::safeIncreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L68-L71) and [`safeDecreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L82-L90) where suitable (for example in `_revokeTokenSpendApprovals` when the previous allowance amount is known could instead use `safeDecreaseAllowance`).\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n",
      "finding_id": null,
      "severity": "Low",
      "start_line": 37,
      "end_line": 54,
      "markdown_raw": "### Refinancing reverts for `USDT` debt token\n\n**Description:** Refinancing reverts for `USDT` debt token due to the way protocol uses standard `IERC20::approve` and `transfer` functions.\n\n**Impact:** Refinancing is bricked for `USDT` debt tokens. Marked as Low severity as officially only `USDC` is supported at this time. Note the implementation of `USDT` is different across chains; the protocol \"as-is\" would work with `USDT` on Base but not on Ethereum mainnet.\n\n**Proof of Concept:** As part of the audit we have provided a fork fuzz testing suite; run this command: `forge test --fork-url ETH_RPC_URL --fork-block-number 22000000 --match-test test_FuzzRefinance_AaveToCompound_DepWeth_BorUsdt -vvv`\n\n**Recommended Mitigation:** Replace all uses of `IERC20::approve` with [`SafeERC20::forceApprove`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L101-L108) and `IERC20::transfer` with `SafeERC20::safeTransfer` at L738, then re-run the PoC test and it now passes.\n\nIdeally for added safety to prevent front-running of changes to existing approvals, use [`SafeERC20::safeIncreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L68-L71) and [`safeDecreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L82-L90) where suitable (for example in `_revokeTokenSpendApprovals` when the previous allowance amount is known could instead use `safeDecreaseAllowance`).\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n",
      "sections": {
        "description": "**Description:** Refinancing reverts for `USDT` debt token due to the way protocol uses standard `IERC20::approve` and `transfer` functions.\n",
        "impact": "**Impact:** Refinancing is bricked for `USDT` debt tokens. Marked as Low severity as officially only `USDC` is supported at this time. Note the implementation of `USDT` is different across chains; the protocol \"as-is\" would work with `USDT` on Base but not on Ethereum mainnet.\n",
        "recommendation": "**Recommended Mitigation:** Replace all uses of `IERC20::approve` with [`SafeERC20::forceApprove`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L101-L108) and `IERC20::transfer` with `SafeERC20::safeTransfer` at L738, then re-run the PoC test and it now passes.\n\nIdeally for added safety to prevent front-running of changes to existing approvals, use [`SafeERC20::safeIncreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L68-L71) and [`safeDecreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L82-L90) where suitable (for example in `_revokeTokenSpendApprovals` when the previous allowance amount is known could instead use `safeDecreaseAllowance`).\n",
        "poc": "**Proof of Concept:** As part of the audit we have provided a fork fuzz testing suite; run this command: `forge test --fork-url ETH_RPC_URL --fork-block-number 22000000 --match-test test_FuzzRefinance_AaveToCompound_DepWeth_BorUsdt -vvv`\n",
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n"
      },
      "description": "**Description:** Refinancing reverts for `USDT` debt token due to the way protocol uses standard `IERC20::approve` and `transfer` functions.\n",
      "markdown_body": "**Description:** Refinancing reverts for `USDT` debt token due to the way protocol uses standard `IERC20::approve` and `transfer` functions.\n\n**Impact:** Refinancing is bricked for `USDT` debt tokens. Marked as Low severity as officially only `USDC` is supported at this time. Note the implementation of `USDT` is different across chains; the protocol \"as-is\" would work with `USDT` on Base but not on Ethereum mainnet.\n\n**Proof of Concept:** As part of the audit we have provided a fork fuzz testing suite; run this command: `forge test --fork-url ETH_RPC_URL --fork-block-number 22000000 --match-test test_FuzzRefinance_AaveToCompound_DepWeth_BorUsdt -vvv`\n\n**Recommended Mitigation:** Replace all uses of `IERC20::approve` with [`SafeERC20::forceApprove`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L101-L108) and `IERC20::transfer` with `SafeERC20::safeTransfer` at L738, then re-run the PoC test and it now passes.\n\nIdeally for added safety to prevent front-running of changes to existing approvals, use [`SafeERC20::safeIncreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L68-L71) and [`safeDecreaseAllowance`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/utils/SafeERC20.sol#L82-L90) where suitable (for example in `_revokeTokenSpendApprovals` when the previous allowance amount is known could instead use `safeDecreaseAllowance`).\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n",
      "metadata": {
        "Severity": "Low",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Refinancing reverts for USDT debt token"
    },
    {
      "index": 3,
      "page_start": null,
      "heading": "3. Error messages hardcode USDC but other debt tokens may be used",
      "markdown": "### Error messages hardcode `USDC` but other debt tokens may be used\n\n**Description:** Error messages hardcode `USDC` but other token may be used, eg:\n```solidity\nfunction _closeLoanPositionAndReturnCollateralBalance(\n    // @audit debt token can be other tokens apart from USDC but error\n    // message hardcodes USDC\n    require(\n        debtBalance <= IERC20(debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT),\n        \"Insufficient USDC available in the flash contract\"\n    );\n```\n\nThis code in `onMorphoFlashLoan` also assumes the debt token will be USDC:\n```solidity\nuint256 usdcBalance = IERC20(ctx.debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT);\nbool feeAmountAvailable = usdcBalance >= feeAmount;\n```\n\n**Rocko:** Fixed in commit [ec9f5be](https://github.com/getrocko/onchain/commit/ec9f5be20f9249cd20fcc1e173192361ecd97ef5).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 57,
      "end_line": 81,
      "markdown_raw": "### Error messages hardcode `USDC` but other debt tokens may be used\n\n**Description:** Error messages hardcode `USDC` but other token may be used, eg:\n```solidity\nfunction _closeLoanPositionAndReturnCollateralBalance(\n    // @audit debt token can be other tokens apart from USDC but error\n    // message hardcodes USDC\n    require(\n        debtBalance <= IERC20(debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT),\n        \"Insufficient USDC available in the flash contract\"\n    );\n```\n\nThis code in `onMorphoFlashLoan` also assumes the debt token will be USDC:\n```solidity\nuint256 usdcBalance = IERC20(ctx.debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT);\nbool feeAmountAvailable = usdcBalance >= feeAmount;\n```\n\n**Rocko:** Fixed in commit [ec9f5be](https://github.com/getrocko/onchain/commit/ec9f5be20f9249cd20fcc1e173192361ecd97ef5).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Error messages hardcode `USDC` but other token may be used, eg:\n```solidity\nfunction _closeLoanPositionAndReturnCollateralBalance(\n    // @audit debt token can be other tokens apart from USDC but error\n    // message hardcodes USDC\n    require(\n        debtBalance <= IERC20(debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT),\n        \"Insufficient USDC available in the flash contract\"\n    );\n```\n\nThis code in `onMorphoFlashLoan` also assumes the debt token will be USDC:\n```solidity\nuint256 usdcBalance = IERC20(ctx.debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT);\nbool feeAmountAvailable = usdcBalance >= feeAmount;\n```\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [ec9f5be](https://github.com/getrocko/onchain/commit/ec9f5be20f9249cd20fcc1e173192361ecd97ef5).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Error messages hardcode `USDC` but other token may be used, eg:\n```solidity\nfunction _closeLoanPositionAndReturnCollateralBalance(\n    // @audit debt token can be other tokens apart from USDC but error\n    // message hardcodes USDC\n    require(\n        debtBalance <= IERC20(debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT),\n        \"Insufficient USDC available in the flash contract\"\n    );\n```\n\nThis code in `onMorphoFlashLoan` also assumes the debt token will be USDC:\n```solidity\nuint256 usdcBalance = IERC20(ctx.debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT);\nbool feeAmountAvailable = usdcBalance >= feeAmount;\n```\n\n**Rocko:** Fixed in commit [ec9f5be](https://github.com/getrocko/onchain/commit/ec9f5be20f9249cd20fcc1e173192361ecd97ef5).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Error messages hardcode `USDC` but other token may be used, eg:\n```solidity\nfunction _closeLoanPositionAndReturnCollateralBalance(\n    // @audit debt token can be other tokens apart from USDC but error\n    // message hardcodes USDC\n    require(\n        debtBalance <= IERC20(debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT),\n        \"Insufficient USDC available in the flash contract\"\n    );\n```\n\nThis code in `onMorphoFlashLoan` also assumes the debt token will be USDC:\n```solidity\nuint256 usdcBalance = IERC20(ctx.debtTokenAddress).balanceOf(FLASH_LOAN_CONTRACT);\nbool feeAmountAvailable = usdcBalance >= feeAmount;\n```\n\n**Rocko:** Fixed in commit [ec9f5be](https://github.com/getrocko/onchain/commit/ec9f5be20f9249cd20fcc1e173192361ecd97ef5).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Error messages hardcode USDC but other debt tokens may be used"
    },
    {
      "index": 4,
      "page_start": null,
      "heading": "4. Events missing indexed parameters",
      "markdown": "### Events missing indexed parameters\n\n**Description:** Events in Solidity can have up to three indexed parameters, which are stored as topics in the event log. Indexed parameters allow for efficient filtering and searching of events by off-chain services. Without indexed parameters, it becomes more difficult and resource-intensive for applications to filter for specific events.\n\nThere are instances of events missing indexed parameters that could be improved.\n```solidity\n    event LogRefinanceLoanCall(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        uint256 debtBalance,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        Id morphoMarketId\n    );\n    event LogFlashLoanCallback(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        uint256 flashBorrowAmount,\n        bytes data,\n        Id morphoMarketId\n    );\n```\n\n**Recommended Mitigation:** Add the `indexed` keyword to important parameters in the event that would commonly be used for filtering, such as `rockoWallet`, `debtTokenAddress`, and `collateralTokenAddress`.\n\n**Rocko:** Fixed in commit [f5c9c80](https://github.com/getrocko/onchain/commit/f5c9c8051d5ba1bf04774ae6e8aa407aeddbcde1).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 81,
      "end_line": 119,
      "markdown_raw": "### Events missing indexed parameters\n\n**Description:** Events in Solidity can have up to three indexed parameters, which are stored as topics in the event log. Indexed parameters allow for efficient filtering and searching of events by off-chain services. Without indexed parameters, it becomes more difficult and resource-intensive for applications to filter for specific events.\n\nThere are instances of events missing indexed parameters that could be improved.\n```solidity\n    event LogRefinanceLoanCall(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        uint256 debtBalance,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        Id morphoMarketId\n    );\n    event LogFlashLoanCallback(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        uint256 flashBorrowAmount,\n        bytes data,\n        Id morphoMarketId\n    );\n```\n\n**Recommended Mitigation:** Add the `indexed` keyword to important parameters in the event that would commonly be used for filtering, such as `rockoWallet`, `debtTokenAddress`, and `collateralTokenAddress`.\n\n**Rocko:** Fixed in commit [f5c9c80](https://github.com/getrocko/onchain/commit/f5c9c8051d5ba1bf04774ae6e8aa407aeddbcde1).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Events in Solidity can have up to three indexed parameters, which are stored as topics in the event log. Indexed parameters allow for efficient filtering and searching of events by off-chain services. Without indexed parameters, it becomes more difficult and resource-intensive for applications to filter for specific events.\n\nThere are instances of events missing indexed parameters that could be improved.\n```solidity\n    event LogRefinanceLoanCall(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        uint256 debtBalance,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        Id morphoMarketId\n    );\n    event LogFlashLoanCallback(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        uint256 flashBorrowAmount,\n        bytes data,\n        Id morphoMarketId\n    );\n```\n",
        "impact": null,
        "recommendation": "**Recommended Mitigation:** Add the `indexed` keyword to important parameters in the event that would commonly be used for filtering, such as `rockoWallet`, `debtTokenAddress`, and `collateralTokenAddress`.\n",
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [f5c9c80](https://github.com/getrocko/onchain/commit/f5c9c8051d5ba1bf04774ae6e8aa407aeddbcde1).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Events in Solidity can have up to three indexed parameters, which are stored as topics in the event log. Indexed parameters allow for efficient filtering and searching of events by off-chain services. Without indexed parameters, it becomes more difficult and resource-intensive for applications to filter for specific events.\n\nThere are instances of events missing indexed parameters that could be improved.\n```solidity\n    event LogRefinanceLoanCall(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        uint256 debtBalance,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        Id morphoMarketId\n    );\n    event LogFlashLoanCallback(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        uint256 flashBorrowAmount,\n        bytes data,\n        Id morphoMarketId\n    );\n```\n",
      "markdown_body": "**Description:** Events in Solidity can have up to three indexed parameters, which are stored as topics in the event log. Indexed parameters allow for efficient filtering and searching of events by off-chain services. Without indexed parameters, it becomes more difficult and resource-intensive for applications to filter for specific events.\n\nThere are instances of events missing indexed parameters that could be improved.\n```solidity\n    event LogRefinanceLoanCall(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        uint256 debtBalance,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        Id morphoMarketId\n    );\n    event LogFlashLoanCallback(\n        string logType,\n        address rockoWallet,\n        string from,\n        string to,\n        address debtTokenAddress,\n        address collateralTokenAddress,\n        address aCollateralTokenAddress,\n        uint256 flashBorrowAmount,\n        bytes data,\n        Id morphoMarketId\n    );\n```\n\n**Recommended Mitigation:** Add the `indexed` keyword to important parameters in the event that would commonly be used for filtering, such as `rockoWallet`, `debtTokenAddress`, and `collateralTokenAddress`.\n\n**Rocko:** Fixed in commit [f5c9c80](https://github.com/getrocko/onchain/commit/f5c9c8051d5ba1bf04774ae6e8aa407aeddbcde1).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Events missing indexed parameters"
    },
    {
      "index": 5,
      "page_start": null,
      "heading": "5. Unnecessary event emission when configuration values do not change",
      "markdown": "### Unnecessary event emission when configuration values do not change\n\n**Description:** `RockoFlashRefinance::updateFee` updates the `ROCKO_FEE_BP` variable and emits a `FeeUpdated` event regardless of whether the new fee value is different from the current one. This leads to unnecessary event emissions when the owner calls the function with the same fee value that is already set.\nThe function `pauseContract` can be improved similarly too.\n\n**Rocko:** Fixed in commit [99a73dc](https://github.com/getrocko/onchain/commit/99a73dc20fce34811c224fdd46b7e173748bfeb8).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 119,
      "end_line": 129,
      "markdown_raw": "### Unnecessary event emission when configuration values do not change\n\n**Description:** `RockoFlashRefinance::updateFee` updates the `ROCKO_FEE_BP` variable and emits a `FeeUpdated` event regardless of whether the new fee value is different from the current one. This leads to unnecessary event emissions when the owner calls the function with the same fee value that is already set.\nThe function `pauseContract` can be improved similarly too.\n\n**Rocko:** Fixed in commit [99a73dc](https://github.com/getrocko/onchain/commit/99a73dc20fce34811c224fdd46b7e173748bfeb8).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::updateFee` updates the `ROCKO_FEE_BP` variable and emits a `FeeUpdated` event regardless of whether the new fee value is different from the current one. This leads to unnecessary event emissions when the owner calls the function with the same fee value that is already set.\nThe function `pauseContract` can be improved similarly too.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [99a73dc](https://github.com/getrocko/onchain/commit/99a73dc20fce34811c224fdd46b7e173748bfeb8).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** `RockoFlashRefinance::updateFee` updates the `ROCKO_FEE_BP` variable and emits a `FeeUpdated` event regardless of whether the new fee value is different from the current one. This leads to unnecessary event emissions when the owner calls the function with the same fee value that is already set.\nThe function `pauseContract` can be improved similarly too.\n\n**Rocko:** Fixed in commit [99a73dc](https://github.com/getrocko/onchain/commit/99a73dc20fce34811c224fdd46b7e173748bfeb8).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::updateFee` updates the `ROCKO_FEE_BP` variable and emits a `FeeUpdated` event regardless of whether the new fee value is different from the current one. This leads to unnecessary event emissions when the owner calls the function with the same fee value that is already set.\nThe function `pauseContract` can be improved similarly too.\n\n**Rocko:** Fixed in commit [99a73dc](https://github.com/getrocko/onchain/commit/99a73dc20fce34811c224fdd46b7e173748bfeb8).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Unnecessary event emission when configuration values do not change"
    },
    {
      "index": 6,
      "page_start": null,
      "heading": "6. Inconsistent implementation approach for retrieving collateral balance from Morpho",
      "markdown": "### Inconsistent implementation approach for retrieving collateral balance from Morpho\n\n**Description:** `RockoFlashRefinance::_collateralBalanceOfMorpho` uses direct storage slot access to retrieve a user's collateral balance from Morpho, while similar functionality for debt retrieval is implemented using `MorphoLib`. This inconsistency in the implementation approach makes the code less readable and maintainable.\n```solidity\n    function _collateralBalanceOfMorpho(\n        Id morphoMarketId,\n        address rockoWallet\n    ) private view returns (uint256 totalCollateralAssets) {//@audit-issue use MorphoLib::collateral instead\n        bytes32[] memory slots = new bytes32[](1);\n        slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n        bytes32[] memory values = MORPHO.extSloads(slots);\n        totalCollateralAssets = uint256(values[0] >> 128);\n    }\n\n    function _getMorphoDebtAndShares(Id marketId, address rockoWallet) private returns (uint256 debt, uint256 shares) {\n        MarketParams memory marketParams = MORPHO.idToMarketParams(marketId);\n        MORPHO.accrueInterest(marketParams);\n\n        uint256 totalBorrowAssets = MORPHO.totalBorrowAssets(marketId);\n        uint256 totalBorrowShares = MORPHO.totalBorrowShares(marketId);\n        shares = MORPHO.borrowShares(marketId, rockoWallet);\n        debt = shares.toAssetsUp(totalBorrowAssets, totalBorrowShares);\n    }\n```\n\n**Recommended Mitigation:** Refactor `_collateralBalanceOfMorpho` to use `MorphoLib::collateral` for consistency with other parts of the codebase:\n\n```diff\nfunction _collateralBalanceOfMorpho(\n    Id morphoMarketId,\n    address rockoWallet\n) private view returns (uint256 totalCollateralAssets) {\n-    bytes32[] memory slots = new bytes32[](1);\n-    slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n-    bytes32[] memory values = MORPHO.extSloads(slots);\n-    totalCollateralAssets = uint256(values[0] >> 128);\n+    totalCollateralAssets = MorphoLib.collateral(MORPHO, morphoMarketId, rockoWallet);\n}\n```\n\n**Rocko:** Fixed in commit [5ef86b4](https://github.com/getrocko/onchain/commit/5ef86b44063a988afed93fe3f69074be757768bd).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 129,
      "end_line": 174,
      "markdown_raw": "### Inconsistent implementation approach for retrieving collateral balance from Morpho\n\n**Description:** `RockoFlashRefinance::_collateralBalanceOfMorpho` uses direct storage slot access to retrieve a user's collateral balance from Morpho, while similar functionality for debt retrieval is implemented using `MorphoLib`. This inconsistency in the implementation approach makes the code less readable and maintainable.\n```solidity\n    function _collateralBalanceOfMorpho(\n        Id morphoMarketId,\n        address rockoWallet\n    ) private view returns (uint256 totalCollateralAssets) {//@audit-issue use MorphoLib::collateral instead\n        bytes32[] memory slots = new bytes32[](1);\n        slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n        bytes32[] memory values = MORPHO.extSloads(slots);\n        totalCollateralAssets = uint256(values[0] >> 128);\n    }\n\n    function _getMorphoDebtAndShares(Id marketId, address rockoWallet) private returns (uint256 debt, uint256 shares) {\n        MarketParams memory marketParams = MORPHO.idToMarketParams(marketId);\n        MORPHO.accrueInterest(marketParams);\n\n        uint256 totalBorrowAssets = MORPHO.totalBorrowAssets(marketId);\n        uint256 totalBorrowShares = MORPHO.totalBorrowShares(marketId);\n        shares = MORPHO.borrowShares(marketId, rockoWallet);\n        debt = shares.toAssetsUp(totalBorrowAssets, totalBorrowShares);\n    }\n```\n\n**Recommended Mitigation:** Refactor `_collateralBalanceOfMorpho` to use `MorphoLib::collateral` for consistency with other parts of the codebase:\n\n```diff\nfunction _collateralBalanceOfMorpho(\n    Id morphoMarketId,\n    address rockoWallet\n) private view returns (uint256 totalCollateralAssets) {\n-    bytes32[] memory slots = new bytes32[](1);\n-    slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n-    bytes32[] memory values = MORPHO.extSloads(slots);\n-    totalCollateralAssets = uint256(values[0] >> 128);\n+    totalCollateralAssets = MorphoLib.collateral(MORPHO, morphoMarketId, rockoWallet);\n}\n```\n\n**Rocko:** Fixed in commit [5ef86b4](https://github.com/getrocko/onchain/commit/5ef86b44063a988afed93fe3f69074be757768bd).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::_collateralBalanceOfMorpho` uses direct storage slot access to retrieve a user's collateral balance from Morpho, while similar functionality for debt retrieval is implemented using `MorphoLib`. This inconsistency in the implementation approach makes the code less readable and maintainable.\n```solidity\n    function _collateralBalanceOfMorpho(\n        Id morphoMarketId,\n        address rockoWallet\n    ) private view returns (uint256 totalCollateralAssets) {//@audit-issue use MorphoLib::collateral instead\n        bytes32[] memory slots = new bytes32[](1);\n        slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n        bytes32[] memory values = MORPHO.extSloads(slots);\n        totalCollateralAssets = uint256(values[0] >> 128);\n    }\n\n    function _getMorphoDebtAndShares(Id marketId, address rockoWallet) private returns (uint256 debt, uint256 shares) {\n        MarketParams memory marketParams = MORPHO.idToMarketParams(marketId);\n        MORPHO.accrueInterest(marketParams);\n\n        uint256 totalBorrowAssets = MORPHO.totalBorrowAssets(marketId);\n        uint256 totalBorrowShares = MORPHO.totalBorrowShares(marketId);\n        shares = MORPHO.borrowShares(marketId, rockoWallet);\n        debt = shares.toAssetsUp(totalBorrowAssets, totalBorrowShares);\n    }\n```\n",
        "impact": null,
        "recommendation": "**Recommended Mitigation:** Refactor `_collateralBalanceOfMorpho` to use `MorphoLib::collateral` for consistency with other parts of the codebase:\n\n```diff\nfunction _collateralBalanceOfMorpho(\n    Id morphoMarketId,\n    address rockoWallet\n) private view returns (uint256 totalCollateralAssets) {\n-    bytes32[] memory slots = new bytes32[](1);\n-    slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n-    bytes32[] memory values = MORPHO.extSloads(slots);\n-    totalCollateralAssets = uint256(values[0] >> 128);\n+    totalCollateralAssets = MorphoLib.collateral(MORPHO, morphoMarketId, rockoWallet);\n}\n```\n",
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [5ef86b4](https://github.com/getrocko/onchain/commit/5ef86b44063a988afed93fe3f69074be757768bd).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** `RockoFlashRefinance::_collateralBalanceOfMorpho` uses direct storage slot access to retrieve a user's collateral balance from Morpho, while similar functionality for debt retrieval is implemented using `MorphoLib`. This inconsistency in the implementation approach makes the code less readable and maintainable.\n```solidity\n    function _collateralBalanceOfMorpho(\n        Id morphoMarketId,\n        address rockoWallet\n    ) private view returns (uint256 totalCollateralAssets) {//@audit-issue use MorphoLib::collateral instead\n        bytes32[] memory slots = new bytes32[](1);\n        slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n        bytes32[] memory values = MORPHO.extSloads(slots);\n        totalCollateralAssets = uint256(values[0] >> 128);\n    }\n\n    function _getMorphoDebtAndShares(Id marketId, address rockoWallet) private returns (uint256 debt, uint256 shares) {\n        MarketParams memory marketParams = MORPHO.idToMarketParams(marketId);\n        MORPHO.accrueInterest(marketParams);\n\n        uint256 totalBorrowAssets = MORPHO.totalBorrowAssets(marketId);\n        uint256 totalBorrowShares = MORPHO.totalBorrowShares(marketId);\n        shares = MORPHO.borrowShares(marketId, rockoWallet);\n        debt = shares.toAssetsUp(totalBorrowAssets, totalBorrowShares);\n    }\n```\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::_collateralBalanceOfMorpho` uses direct storage slot access to retrieve a user's collateral balance from Morpho, while similar functionality for debt retrieval is implemented using `MorphoLib`. This inconsistency in the implementation approach makes the code less readable and maintainable.\n```solidity\n    function _collateralBalanceOfMorpho(\n        Id morphoMarketId,\n        address rockoWallet\n    ) private view returns (uint256 totalCollateralAssets) {//@audit-issue use MorphoLib::collateral instead\n        bytes32[] memory slots = new bytes32[](1);\n        slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n        bytes32[] memory values = MORPHO.extSloads(slots);\n        totalCollateralAssets = uint256(values[0] >> 128);\n    }\n\n    function _getMorphoDebtAndShares(Id marketId, address rockoWallet) private returns (uint256 debt, uint256 shares) {\n        MarketParams memory marketParams = MORPHO.idToMarketParams(marketId);\n        MORPHO.accrueInterest(marketParams);\n\n        uint256 totalBorrowAssets = MORPHO.totalBorrowAssets(marketId);\n        uint256 totalBorrowShares = MORPHO.totalBorrowShares(marketId);\n        shares = MORPHO.borrowShares(marketId, rockoWallet);\n        debt = shares.toAssetsUp(totalBorrowAssets, totalBorrowShares);\n    }\n```\n\n**Recommended Mitigation:** Refactor `_collateralBalanceOfMorpho` to use `MorphoLib::collateral` for consistency with other parts of the codebase:\n\n```diff\nfunction _collateralBalanceOfMorpho(\n    Id morphoMarketId,\n    address rockoWallet\n) private view returns (uint256 totalCollateralAssets) {\n-    bytes32[] memory slots = new bytes32[](1);\n-    slots[0] = MorphoStorageLib.positionBorrowSharesAndCollateralSlot(morphoMarketId, rockoWallet);\n-    bytes32[] memory values = MORPHO.extSloads(slots);\n-    totalCollateralAssets = uint256(values[0] >> 128);\n+    totalCollateralAssets = MorphoLib.collateral(MORPHO, morphoMarketId, rockoWallet);\n}\n```\n\n**Rocko:** Fixed in commit [5ef86b4](https://github.com/getrocko/onchain/commit/5ef86b44063a988afed93fe3f69074be757768bd).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Inconsistent implementation approach for retrieving collateral balance from Morpho"
    },
    {
      "index": 7,
      "page_start": null,
      "heading": "7. Insufficient data length validation in onMorphoFlashLoan",
      "markdown": "### Insufficient data length validation in `onMorphoFlashLoan`\n\n**Description:** `RockoFlashRefinance::onMorphoFlashLoan` performs a basic check on the length of the `data` parameter, requiring it to be at least 20 bytes. However, this check is insufficient as the actual data being sent is much larger, containing multiple addresses, strings, and an Id parameter. The minimum expected data length should be at least 256 bytes plus additional bytes for dynamic string data.\n\n**Recommended Mitigation:**\n```diff\n-        require(data.length >= 20, \"Invalid data\");\n+        require(data.length >= 256, \"Invalid data\");\n```\n\n**Rocko:** Fixed in commit [1da67d7](https://github.com/getrocko/onchain/commit/1da67d7f3ae8076a6cc135ef9a6e5595ad6e29a2).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 174,
      "end_line": 189,
      "markdown_raw": "### Insufficient data length validation in `onMorphoFlashLoan`\n\n**Description:** `RockoFlashRefinance::onMorphoFlashLoan` performs a basic check on the length of the `data` parameter, requiring it to be at least 20 bytes. However, this check is insufficient as the actual data being sent is much larger, containing multiple addresses, strings, and an Id parameter. The minimum expected data length should be at least 256 bytes plus additional bytes for dynamic string data.\n\n**Recommended Mitigation:**\n```diff\n-        require(data.length >= 20, \"Invalid data\");\n+        require(data.length >= 256, \"Invalid data\");\n```\n\n**Rocko:** Fixed in commit [1da67d7](https://github.com/getrocko/onchain/commit/1da67d7f3ae8076a6cc135ef9a6e5595ad6e29a2).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::onMorphoFlashLoan` performs a basic check on the length of the `data` parameter, requiring it to be at least 20 bytes. However, this check is insufficient as the actual data being sent is much larger, containing multiple addresses, strings, and an Id parameter. The minimum expected data length should be at least 256 bytes plus additional bytes for dynamic string data.\n",
        "impact": null,
        "recommendation": "**Recommended Mitigation:**\n```diff\n-        require(data.length >= 20, \"Invalid data\");\n+        require(data.length >= 256, \"Invalid data\");\n```\n",
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [1da67d7](https://github.com/getrocko/onchain/commit/1da67d7f3ae8076a6cc135ef9a6e5595ad6e29a2).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** `RockoFlashRefinance::onMorphoFlashLoan` performs a basic check on the length of the `data` parameter, requiring it to be at least 20 bytes. However, this check is insufficient as the actual data being sent is much larger, containing multiple addresses, strings, and an Id parameter. The minimum expected data length should be at least 256 bytes plus additional bytes for dynamic string data.\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::onMorphoFlashLoan` performs a basic check on the length of the `data` parameter, requiring it to be at least 20 bytes. However, this check is insufficient as the actual data being sent is much larger, containing multiple addresses, strings, and an Id parameter. The minimum expected data length should be at least 256 bytes plus additional bytes for dynamic string data.\n\n**Recommended Mitigation:**\n```diff\n-        require(data.length >= 20, \"Invalid data\");\n+        require(data.length >= 256, \"Invalid data\");\n```\n\n**Rocko:** Fixed in commit [1da67d7](https://github.com/getrocko/onchain/commit/1da67d7f3ae8076a6cc135ef9a6e5595ad6e29a2).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Insufficient data length validation in onMorphoFlashLoan"
    },
    {
      "index": 8,
      "page_start": null,
      "heading": "8. In _withdrawAaveCollateral fetch aTokenAddress from Aave instead of receiving as input in refinance as passing it to morpho and back again",
      "markdown": "### In `_withdrawAaveCollateral` fetch `aTokenAddress` from Aave instead of receiving as input in `refinance` as passing it to morpho and back again\n\n**Description:** Aave's `aTokenAddress` is only required when withdrawing collateral in `_withdrawAaveCollateral`, but currently it is:\n* passed in as input to `refinance`\n* has some validation performed on it\n* encoded along with other data and sent to `Morpho::flashLoan`\n* then Morpho passes it back when calling `onMorphoFlashLoan`\n* where it is decoded again and passed around some more\n\nInstead of all this, simply use Aave's API function [`IPool::getReserveData`](https://github.com/aave/aave-v3-core/blob/782f51917056a53a2c228701058a6c3fb233684a/contracts/interfaces/IPool.sol#L582) to get the correct `aTokenAddress` inside `_withdrawAaveCollateral` where it is required:\n```solidity\n    function _withdrawAaveCollateral(\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        DataTypes.ReserveData memory reserveData = AAVE.getReserveData(collateralAddress);\n\n        // Rocko Wallet needs to send aToken here after debt is paid off\n        // Be sure that Rocko Wallet has approved this contract to spend aTokens for > `collateralBalance` tokens\n        _pullTokensFromCallerWallet(reserveData.aTokenAddress, rockoWallet, collateralBalance);\n\n        // function withdraw(address asset, uint256 amount, address to)\n        AAVE.withdraw(collateralAddress, collateralBalance, FLASH_LOAN_CONTRACT);\n    }\n```\n\nFetching this parameter via Aave's API removes unnecessary code/validations also decreases the attack surface.\n\n**Rocko:** Fixed in commit [d793f96](https://github.com/getrocko/onchain/commit/d793f960598240fa3eacdc6a4ec67d55dcfa2a75).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 189,
      "end_line": 223,
      "markdown_raw": "### In `_withdrawAaveCollateral` fetch `aTokenAddress` from Aave instead of receiving as input in `refinance` as passing it to morpho and back again\n\n**Description:** Aave's `aTokenAddress` is only required when withdrawing collateral in `_withdrawAaveCollateral`, but currently it is:\n* passed in as input to `refinance`\n* has some validation performed on it\n* encoded along with other data and sent to `Morpho::flashLoan`\n* then Morpho passes it back when calling `onMorphoFlashLoan`\n* where it is decoded again and passed around some more\n\nInstead of all this, simply use Aave's API function [`IPool::getReserveData`](https://github.com/aave/aave-v3-core/blob/782f51917056a53a2c228701058a6c3fb233684a/contracts/interfaces/IPool.sol#L582) to get the correct `aTokenAddress` inside `_withdrawAaveCollateral` where it is required:\n```solidity\n    function _withdrawAaveCollateral(\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        DataTypes.ReserveData memory reserveData = AAVE.getReserveData(collateralAddress);\n\n        // Rocko Wallet needs to send aToken here after debt is paid off\n        // Be sure that Rocko Wallet has approved this contract to spend aTokens for > `collateralBalance` tokens\n        _pullTokensFromCallerWallet(reserveData.aTokenAddress, rockoWallet, collateralBalance);\n\n        // function withdraw(address asset, uint256 amount, address to)\n        AAVE.withdraw(collateralAddress, collateralBalance, FLASH_LOAN_CONTRACT);\n    }\n```\n\nFetching this parameter via Aave's API removes unnecessary code/validations also decreases the attack surface.\n\n**Rocko:** Fixed in commit [d793f96](https://github.com/getrocko/onchain/commit/d793f960598240fa3eacdc6a4ec67d55dcfa2a75).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Aave's `aTokenAddress` is only required when withdrawing collateral in `_withdrawAaveCollateral`, but currently it is:\n* passed in as input to `refinance`\n* has some validation performed on it\n* encoded along with other data and sent to `Morpho::flashLoan`\n* then Morpho passes it back when calling `onMorphoFlashLoan`\n* where it is decoded again and passed around some more\n\nInstead of all this, simply use Aave's API function [`IPool::getReserveData`](https://github.com/aave/aave-v3-core/blob/782f51917056a53a2c228701058a6c3fb233684a/contracts/interfaces/IPool.sol#L582) to get the correct `aTokenAddress` inside `_withdrawAaveCollateral` where it is required:\n```solidity\n    function _withdrawAaveCollateral(\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        DataTypes.ReserveData memory reserveData = AAVE.getReserveData(collateralAddress);\n\n        // Rocko Wallet needs to send aToken here after debt is paid off\n        // Be sure that Rocko Wallet has approved this contract to spend aTokens for > `collateralBalance` tokens\n        _pullTokensFromCallerWallet(reserveData.aTokenAddress, rockoWallet, collateralBalance);\n\n        // function withdraw(address asset, uint256 amount, address to)\n        AAVE.withdraw(collateralAddress, collateralBalance, FLASH_LOAN_CONTRACT);\n    }\n```\n\nFetching this parameter via Aave's API removes unnecessary code/validations also decreases the attack surface.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [d793f96](https://github.com/getrocko/onchain/commit/d793f960598240fa3eacdc6a4ec67d55dcfa2a75).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Aave's `aTokenAddress` is only required when withdrawing collateral in `_withdrawAaveCollateral`, but currently it is:\n* passed in as input to `refinance`\n* has some validation performed on it\n* encoded along with other data and sent to `Morpho::flashLoan`\n* then Morpho passes it back when calling `onMorphoFlashLoan`\n* where it is decoded again and passed around some more\n\nInstead of all this, simply use Aave's API function [`IPool::getReserveData`](https://github.com/aave/aave-v3-core/blob/782f51917056a53a2c228701058a6c3fb233684a/contracts/interfaces/IPool.sol#L582) to get the correct `aTokenAddress` inside `_withdrawAaveCollateral` where it is required:\n```solidity\n    function _withdrawAaveCollateral(\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        DataTypes.ReserveData memory reserveData = AAVE.getReserveData(collateralAddress);\n\n        // Rocko Wallet needs to send aToken here after debt is paid off\n        // Be sure that Rocko Wallet has approved this contract to spend aTokens for > `collateralBalance` tokens\n        _pullTokensFromCallerWallet(reserveData.aTokenAddress, rockoWallet, collateralBalance);\n\n        // function withdraw(address asset, uint256 amount, address to)\n        AAVE.withdraw(collateralAddress, collateralBalance, FLASH_LOAN_CONTRACT);\n    }\n```\n\nFetching this parameter via Aave's API removes unnecessary code/validations also decreases the attack surface.\n\n**Rocko:** Fixed in commit [d793f96](https://github.com/getrocko/onchain/commit/d793f960598240fa3eacdc6a4ec67d55dcfa2a75).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Aave's `aTokenAddress` is only required when withdrawing collateral in `_withdrawAaveCollateral`, but currently it is:\n* passed in as input to `refinance`\n* has some validation performed on it\n* encoded along with other data and sent to `Morpho::flashLoan`\n* then Morpho passes it back when calling `onMorphoFlashLoan`\n* where it is decoded again and passed around some more\n\nInstead of all this, simply use Aave's API function [`IPool::getReserveData`](https://github.com/aave/aave-v3-core/blob/782f51917056a53a2c228701058a6c3fb233684a/contracts/interfaces/IPool.sol#L582) to get the correct `aTokenAddress` inside `_withdrawAaveCollateral` where it is required:\n```solidity\n    function _withdrawAaveCollateral(\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        DataTypes.ReserveData memory reserveData = AAVE.getReserveData(collateralAddress);\n\n        // Rocko Wallet needs to send aToken here after debt is paid off\n        // Be sure that Rocko Wallet has approved this contract to spend aTokens for > `collateralBalance` tokens\n        _pullTokensFromCallerWallet(reserveData.aTokenAddress, rockoWallet, collateralBalance);\n\n        // function withdraw(address asset, uint256 amount, address to)\n        AAVE.withdraw(collateralAddress, collateralBalance, FLASH_LOAN_CONTRACT);\n    }\n```\n\nFetching this parameter via Aave's API removes unnecessary code/validations also decreases the attack surface.\n\n**Rocko:** Fixed in commit [d793f96](https://github.com/getrocko/onchain/commit/d793f960598240fa3eacdc6a4ec67d55dcfa2a75).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "In _withdrawAaveCollateral fetch aTokenAddress from Aave instead of receiving as input in refinance as passing it to morpho and back again"
    },
    {
      "index": 9,
      "page_start": null,
      "heading": "9. Provide a way for users to revoke all approvals",
      "markdown": "### Provide a way for users to revoke all approvals\n\n**Description:** `RockoFlashRefinance` is designed to move existing loan positions from one lending protocol to another. On behalf of the user the contract must be able to:\n* close the loan from the previous lending provider\n* open a new loan on the new lending provider\n\nFor Aave, users must allow the refinance contract to spend the [AToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/AToken.sol) to close the position and to spend the [VariableDebtToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/VariableDebtToken.sol) to open a new position.\n\nFor Compound (Comet), users must allow the refinance contract by calling the [allow function](https://github.com/compound-finance/comet/blob/68cd639c67626c86e890e5aac775ad4b6405d923/contracts/CometExt.sol#L162C14-L162C19).\n\nFor Morpho, users must authorize the refinance protocol by calling the [setAuthorization](https://github.com/morpho-org/morpho-blue/blob/9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c/src/Morpho.sol#L437C14-L437C30) function.\n\nThe protocol team provided their frontend source related to these approvals and there were only \"approving\" support, not revoking. It is recommended to provide an easy way for users to revoke all these approvals.\n\n**Rocko:** Users revokes will be included in the batch transaction when called from the Rocko app.\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 223,
      "end_line": 240,
      "markdown_raw": "### Provide a way for users to revoke all approvals\n\n**Description:** `RockoFlashRefinance` is designed to move existing loan positions from one lending protocol to another. On behalf of the user the contract must be able to:\n* close the loan from the previous lending provider\n* open a new loan on the new lending provider\n\nFor Aave, users must allow the refinance contract to spend the [AToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/AToken.sol) to close the position and to spend the [VariableDebtToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/VariableDebtToken.sol) to open a new position.\n\nFor Compound (Comet), users must allow the refinance contract by calling the [allow function](https://github.com/compound-finance/comet/blob/68cd639c67626c86e890e5aac775ad4b6405d923/contracts/CometExt.sol#L162C14-L162C19).\n\nFor Morpho, users must authorize the refinance protocol by calling the [setAuthorization](https://github.com/morpho-org/morpho-blue/blob/9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c/src/Morpho.sol#L437C14-L437C30) function.\n\nThe protocol team provided their frontend source related to these approvals and there were only \"approving\" support, not revoking. It is recommended to provide an easy way for users to revoke all these approvals.\n\n**Rocko:** Users revokes will be included in the batch transaction when called from the Rocko app.\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance` is designed to move existing loan positions from one lending protocol to another. On behalf of the user the contract must be able to:\n* close the loan from the previous lending provider\n* open a new loan on the new lending provider\n\nFor Aave, users must allow the refinance contract to spend the [AToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/AToken.sol) to close the position and to spend the [VariableDebtToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/VariableDebtToken.sol) to open a new position.\n\nFor Compound (Comet), users must allow the refinance contract by calling the [allow function](https://github.com/compound-finance/comet/blob/68cd639c67626c86e890e5aac775ad4b6405d923/contracts/CometExt.sol#L162C14-L162C19).\n\nFor Morpho, users must authorize the refinance protocol by calling the [setAuthorization](https://github.com/morpho-org/morpho-blue/blob/9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c/src/Morpho.sol#L437C14-L437C30) function.\n\nThe protocol team provided their frontend source related to these approvals and there were only \"approving\" support, not revoking. It is recommended to provide an easy way for users to revoke all these approvals.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Users revokes will be included in the batch transaction when called from the Rocko app.\n"
      },
      "description": "**Description:** `RockoFlashRefinance` is designed to move existing loan positions from one lending protocol to another. On behalf of the user the contract must be able to:\n* close the loan from the previous lending provider\n* open a new loan on the new lending provider\n\nFor Aave, users must allow the refinance contract to spend the [AToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/AToken.sol) to close the position and to spend the [VariableDebtToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/VariableDebtToken.sol) to open a new position.\n\nFor Compound (Comet), users must allow the refinance contract by calling the [allow function](https://github.com/compound-finance/comet/blob/68cd639c67626c86e890e5aac775ad4b6405d923/contracts/CometExt.sol#L162C14-L162C19).\n\nFor Morpho, users must authorize the refinance protocol by calling the [setAuthorization](https://github.com/morpho-org/morpho-blue/blob/9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c/src/Morpho.sol#L437C14-L437C30) function.\n\nThe protocol team provided their frontend source related to these approvals and there were only \"approving\" support, not revoking. It is recommended to provide an easy way for users to revoke all these approvals.\n\n**Rocko:** Users revokes will be included in the batch transaction when called from the Rocko app.\n",
      "markdown_body": "**Description:** `RockoFlashRefinance` is designed to move existing loan positions from one lending protocol to another. On behalf of the user the contract must be able to:\n* close the loan from the previous lending provider\n* open a new loan on the new lending provider\n\nFor Aave, users must allow the refinance contract to spend the [AToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/AToken.sol) to close the position and to spend the [VariableDebtToken](https://github.com/aave/aave-v3-core/blob/master/contracts/protocol/tokenization/VariableDebtToken.sol) to open a new position.\n\nFor Compound (Comet), users must allow the refinance contract by calling the [allow function](https://github.com/compound-finance/comet/blob/68cd639c67626c86e890e5aac775ad4b6405d923/contracts/CometExt.sol#L162C14-L162C19).\n\nFor Morpho, users must authorize the refinance protocol by calling the [setAuthorization](https://github.com/morpho-org/morpho-blue/blob/9e2b0755b47bbe5b09bf1be8f00e060d4eab6f1c/src/Morpho.sol#L437C14-L437C30) function.\n\nThe protocol team provided their frontend source related to these approvals and there were only \"approving\" support, not revoking. It is recommended to provide an easy way for users to revoke all these approvals.\n\n**Rocko:** Users revokes will be included in the batch transaction when called from the Rocko app.\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Provide a way for users to revoke all approvals"
    },
    {
      "index": 10,
      "page_start": null,
      "heading": "10. Consider allowing update to AAVE_DATA_PROVIDER",
      "markdown": "### Consider allowing update to `AAVE_DATA_PROVIDER`\n\n**Description:** `RockoFlashRefinance::AAVE_DATA_PROVIDER` immutably stores the address of `AaveProtocolDataProvider`. However `AaveProtocolDataProvider` is not upgradeable and the \"current\" one on mainnet was deployed 43 days ago to address 0x497a1994c46d4f6C864904A9f1fac6328Cb7C8a6.\n\nHence consider whether `AAVE_DATA_PROVIDER` should not be `immutable` and an `onlyOwner` function should exist to allow updating it in the future.\n\nSince `RockoFlashRefinance` has no relevant internal state it can just be re-deloyed. The trade-off is having  `immutable` `AAVE_DATA_PROVIDER` means user transactions involving it cost slightly less gas but the contract needs to be re-deployed to update it.\n\n**Rocko:** Acknowledged; prefer the current setup for lower user gas costs.\n\n\\clearpage\n",
      "finding_id": null,
      "severity": "Informational",
      "start_line": 240,
      "end_line": 251,
      "markdown_raw": "### Consider allowing update to `AAVE_DATA_PROVIDER`\n\n**Description:** `RockoFlashRefinance::AAVE_DATA_PROVIDER` immutably stores the address of `AaveProtocolDataProvider`. However `AaveProtocolDataProvider` is not upgradeable and the \"current\" one on mainnet was deployed 43 days ago to address 0x497a1994c46d4f6C864904A9f1fac6328Cb7C8a6.\n\nHence consider whether `AAVE_DATA_PROVIDER` should not be `immutable` and an `onlyOwner` function should exist to allow updating it in the future.\n\nSince `RockoFlashRefinance` has no relevant internal state it can just be re-deloyed. The trade-off is having  `immutable` `AAVE_DATA_PROVIDER` means user transactions involving it cost slightly less gas but the contract needs to be re-deployed to update it.\n\n**Rocko:** Acknowledged; prefer the current setup for lower user gas costs.\n\n\\clearpage\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::AAVE_DATA_PROVIDER` immutably stores the address of `AaveProtocolDataProvider`. However `AaveProtocolDataProvider` is not upgradeable and the \"current\" one on mainnet was deployed 43 days ago to address 0x497a1994c46d4f6C864904A9f1fac6328Cb7C8a6.\n\nHence consider whether `AAVE_DATA_PROVIDER` should not be `immutable` and an `onlyOwner` function should exist to allow updating it in the future.\n\nSince `RockoFlashRefinance` has no relevant internal state it can just be re-deloyed. The trade-off is having  `immutable` `AAVE_DATA_PROVIDER` means user transactions involving it cost slightly less gas but the contract needs to be re-deployed to update it.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Acknowledged; prefer the current setup for lower user gas costs.\n\n\\clearpage\n"
      },
      "description": "**Description:** `RockoFlashRefinance::AAVE_DATA_PROVIDER` immutably stores the address of `AaveProtocolDataProvider`. However `AaveProtocolDataProvider` is not upgradeable and the \"current\" one on mainnet was deployed 43 days ago to address 0x497a1994c46d4f6C864904A9f1fac6328Cb7C8a6.\n\nHence consider whether `AAVE_DATA_PROVIDER` should not be `immutable` and an `onlyOwner` function should exist to allow updating it in the future.\n\nSince `RockoFlashRefinance` has no relevant internal state it can just be re-deloyed. The trade-off is having  `immutable` `AAVE_DATA_PROVIDER` means user transactions involving it cost slightly less gas but the contract needs to be re-deployed to update it.\n\n**Rocko:** Acknowledged; prefer the current setup for lower user gas costs.\n\n\\clearpage\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::AAVE_DATA_PROVIDER` immutably stores the address of `AaveProtocolDataProvider`. However `AaveProtocolDataProvider` is not upgradeable and the \"current\" one on mainnet was deployed 43 days ago to address 0x497a1994c46d4f6C864904A9f1fac6328Cb7C8a6.\n\nHence consider whether `AAVE_DATA_PROVIDER` should not be `immutable` and an `onlyOwner` function should exist to allow updating it in the future.\n\nSince `RockoFlashRefinance` has no relevant internal state it can just be re-deloyed. The trade-off is having  `immutable` `AAVE_DATA_PROVIDER` means user transactions involving it cost slightly less gas but the contract needs to be re-deployed to update it.\n\n**Rocko:** Acknowledged; prefer the current setup for lower user gas costs.\n\n\\clearpage\n",
      "metadata": {
        "Severity": "Informational",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Consider allowing update to AAVE_DATA_PROVIDER"
    },
    {
      "index": 11,
      "page_start": null,
      "heading": "11. Use ReentrancyGuardTransient instead of ReentrancyGuard or more gas-efficient nonReentrant modifiers",
      "markdown": "### Use `ReentrancyGuardTransient` instead of `ReentrancyGuard` or more gas-efficient `nonReentrant` modifiers\n\n**Description:** Use [`ReentrancyGuardTransient`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/ReentrancyGuardTransient.sol) instead of `ReentrancyGuard` for more gas-efficient `nonReentrant` modifiers. The OpenZeppelin version would need to be bumped to 5.1.\n\n**Rocko:** Fixed in commit [675f4b2](https://github.com/getrocko/onchain/commit/675f4b2e59cddf6c3f9f2e866f4401564bd0a006).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 254,
      "end_line": 263,
      "markdown_raw": "### Use `ReentrancyGuardTransient` instead of `ReentrancyGuard` or more gas-efficient `nonReentrant` modifiers\n\n**Description:** Use [`ReentrancyGuardTransient`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/ReentrancyGuardTransient.sol) instead of `ReentrancyGuard` for more gas-efficient `nonReentrant` modifiers. The OpenZeppelin version would need to be bumped to 5.1.\n\n**Rocko:** Fixed in commit [675f4b2](https://github.com/getrocko/onchain/commit/675f4b2e59cddf6c3f9f2e866f4401564bd0a006).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Use [`ReentrancyGuardTransient`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/ReentrancyGuardTransient.sol) instead of `ReentrancyGuard` for more gas-efficient `nonReentrant` modifiers. The OpenZeppelin version would need to be bumped to 5.1.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [675f4b2](https://github.com/getrocko/onchain/commit/675f4b2e59cddf6c3f9f2e866f4401564bd0a006).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Use [`ReentrancyGuardTransient`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/ReentrancyGuardTransient.sol) instead of `ReentrancyGuard` for more gas-efficient `nonReentrant` modifiers. The OpenZeppelin version would need to be bumped to 5.1.\n\n**Rocko:** Fixed in commit [675f4b2](https://github.com/getrocko/onchain/commit/675f4b2e59cddf6c3f9f2e866f4401564bd0a006).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Use [`ReentrancyGuardTransient`](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/ReentrancyGuardTransient.sol) instead of `ReentrancyGuard` for more gas-efficient `nonReentrant` modifiers. The OpenZeppelin version would need to be bumped to 5.1.\n\n**Rocko:** Fixed in commit [675f4b2](https://github.com/getrocko/onchain/commit/675f4b2e59cddf6c3f9f2e866f4401564bd0a006).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Use ReentrancyGuardTransient instead of ReentrancyGuard or more gas-efficient nonReentrant modifiers"
    },
    {
      "index": 12,
      "page_start": null,
      "heading": "12. Remove obsolete check in updateFee",
      "markdown": "### Remove obsolete check in `updateFee`\n\n**Description:** Remove obsolete check in `updateFee`:\n```diff\n-        require(newFee >= 0, \"Fee must not be negative\");\n```\n\nThis check is obsolete since `newFee` is declared as `uint256` therefore cannot be negative.\n\n**Rocko:** Fixed in commit [2c50838](https://github.com/getrocko/onchain/commit/2c50838a5cc5e498a14874a5d3348da20087e6bc).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 263,
      "end_line": 277,
      "markdown_raw": "### Remove obsolete check in `updateFee`\n\n**Description:** Remove obsolete check in `updateFee`:\n```diff\n-        require(newFee >= 0, \"Fee must not be negative\");\n```\n\nThis check is obsolete since `newFee` is declared as `uint256` therefore cannot be negative.\n\n**Rocko:** Fixed in commit [2c50838](https://github.com/getrocko/onchain/commit/2c50838a5cc5e498a14874a5d3348da20087e6bc).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Remove obsolete check in `updateFee`:\n```diff\n-        require(newFee >= 0, \"Fee must not be negative\");\n```\n\nThis check is obsolete since `newFee` is declared as `uint256` therefore cannot be negative.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [2c50838](https://github.com/getrocko/onchain/commit/2c50838a5cc5e498a14874a5d3348da20087e6bc).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Remove obsolete check in `updateFee`:\n```diff\n-        require(newFee >= 0, \"Fee must not be negative\");\n```\n\nThis check is obsolete since `newFee` is declared as `uint256` therefore cannot be negative.\n\n**Rocko:** Fixed in commit [2c50838](https://github.com/getrocko/onchain/commit/2c50838a5cc5e498a14874a5d3348da20087e6bc).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Remove obsolete check in `updateFee`:\n```diff\n-        require(newFee >= 0, \"Fee must not be negative\");\n```\n\nThis check is obsolete since `newFee` is declared as `uint256` therefore cannot be negative.\n\n**Rocko:** Fixed in commit [2c50838](https://github.com/getrocko/onchain/commit/2c50838a5cc5e498a14874a5d3348da20087e6bc).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Remove obsolete check in updateFee"
    },
    {
      "index": 13,
      "page_start": null,
      "heading": "13. Use msg.sender instead of owner() inside onlyOwner functions",
      "markdown": "### Use `msg.sender` instead of `owner()` inside `onlyOwner` functions\n\n**Description:** Using `msg.sender` instead of `owner()` inside `onlyOwner` functions is more efficient as it eliminates reading from storage. It is also safe since the `onlyOwner` modifier ensures that `msg.sender` is the owner:\n```solidity\n757:        IERC20(tokenAddress).safeTransfer(owner(), amount);\n766:        (bool success, ) = owner().call{ value: amount }(\"\");\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 277,
      "end_line": 290,
      "markdown_raw": "### Use `msg.sender` instead of `owner()` inside `onlyOwner` functions\n\n**Description:** Using `msg.sender` instead of `owner()` inside `onlyOwner` functions is more efficient as it eliminates reading from storage. It is also safe since the `onlyOwner` modifier ensures that `msg.sender` is the owner:\n```solidity\n757:        IERC20(tokenAddress).safeTransfer(owner(), amount);\n766:        (bool success, ) = owner().call{ value: amount }(\"\");\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Using `msg.sender` instead of `owner()` inside `onlyOwner` functions is more efficient as it eliminates reading from storage. It is also safe since the `onlyOwner` modifier ensures that `msg.sender` is the owner:\n```solidity\n757:        IERC20(tokenAddress).safeTransfer(owner(), amount);\n766:        (bool success, ) = owner().call{ value: amount }(\"\");\n```\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Using `msg.sender` instead of `owner()` inside `onlyOwner` functions is more efficient as it eliminates reading from storage. It is also safe since the `onlyOwner` modifier ensures that `msg.sender` is the owner:\n```solidity\n757:        IERC20(tokenAddress).safeTransfer(owner(), amount);\n766:        (bool success, ) = owner().call{ value: amount }(\"\");\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Using `msg.sender` instead of `owner()` inside `onlyOwner` functions is more efficient as it eliminates reading from storage. It is also safe since the `onlyOwner` modifier ensures that `msg.sender` is the owner:\n```solidity\n757:        IERC20(tokenAddress).safeTransfer(owner(), amount);\n766:        (bool success, ) = owner().call{ value: amount }(\"\");\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Use msg.sender instead of owner() inside onlyOwner functions"
    },
    {
      "index": 14,
      "page_start": null,
      "heading": "14. Prevent repetitive hashing of identical strings",
      "markdown": "### Prevent repetitive hashing of identical strings\n\n**Description:** `RockoFlashRefinance::_compareStrings` is often called with the same values resulting in duplicate unnecessary work. A simple and more efficient way to prevent this is by first performing the conversion using `_parseProtocol` for both `from`/`to` inputs then simply comparing the enums as needed in functions like `refinance` and `_revokeTokenSpendApprovals`.\n\nIf string comparisons are required:\n* hard-code the hash result as `bytes32` constants for common expected strings such as \"aave\", \"morpho\", \"compound\" and using these hard-coded constants inside `_parseProtocol` and other functions\n* in functions such as `RockoFlashRefinance::refinance`, cache the hash of the `from`/`to` inputs in local `bytes32` variables and use the cached hashes and the hard-coded constants for the comparisons\n\nOne simple way to achieve this is by:\n* defining a function to return the hash of a string:\n```solidity\n    function _hashString(string calldata input) private pure returns (bytes32 output) {\n        output = keccak256(bytes(input));\n    }\n```\n* changing `_compareStrings` to take two `bytes32` as input:\n```solidity\n    function _compareStrings(bytes32 a, bytes32 b) private pure returns (bool) {\n        return a == b;\n    }\n```\n\nConsider OpenZeppelin's string equality [implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol#L134-L136) as well.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 290,
      "end_line": 319,
      "markdown_raw": "### Prevent repetitive hashing of identical strings\n\n**Description:** `RockoFlashRefinance::_compareStrings` is often called with the same values resulting in duplicate unnecessary work. A simple and more efficient way to prevent this is by first performing the conversion using `_parseProtocol` for both `from`/`to` inputs then simply comparing the enums as needed in functions like `refinance` and `_revokeTokenSpendApprovals`.\n\nIf string comparisons are required:\n* hard-code the hash result as `bytes32` constants for common expected strings such as \"aave\", \"morpho\", \"compound\" and using these hard-coded constants inside `_parseProtocol` and other functions\n* in functions such as `RockoFlashRefinance::refinance`, cache the hash of the `from`/`to` inputs in local `bytes32` variables and use the cached hashes and the hard-coded constants for the comparisons\n\nOne simple way to achieve this is by:\n* defining a function to return the hash of a string:\n```solidity\n    function _hashString(string calldata input) private pure returns (bytes32 output) {\n        output = keccak256(bytes(input));\n    }\n```\n* changing `_compareStrings` to take two `bytes32` as input:\n```solidity\n    function _compareStrings(bytes32 a, bytes32 b) private pure returns (bool) {\n        return a == b;\n    }\n```\n\nConsider OpenZeppelin's string equality [implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol#L134-L136) as well.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::_compareStrings` is often called with the same values resulting in duplicate unnecessary work. A simple and more efficient way to prevent this is by first performing the conversion using `_parseProtocol` for both `from`/`to` inputs then simply comparing the enums as needed in functions like `refinance` and `_revokeTokenSpendApprovals`.\n\nIf string comparisons are required:\n* hard-code the hash result as `bytes32` constants for common expected strings such as \"aave\", \"morpho\", \"compound\" and using these hard-coded constants inside `_parseProtocol` and other functions\n* in functions such as `RockoFlashRefinance::refinance`, cache the hash of the `from`/`to` inputs in local `bytes32` variables and use the cached hashes and the hard-coded constants for the comparisons\n\nOne simple way to achieve this is by:\n* defining a function to return the hash of a string:\n```solidity\n    function _hashString(string calldata input) private pure returns (bytes32 output) {\n        output = keccak256(bytes(input));\n    }\n```\n* changing `_compareStrings` to take two `bytes32` as input:\n```solidity\n    function _compareStrings(bytes32 a, bytes32 b) private pure returns (bool) {\n        return a == b;\n    }\n```\n\nConsider OpenZeppelin's string equality [implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol#L134-L136) as well.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** `RockoFlashRefinance::_compareStrings` is often called with the same values resulting in duplicate unnecessary work. A simple and more efficient way to prevent this is by first performing the conversion using `_parseProtocol` for both `from`/`to` inputs then simply comparing the enums as needed in functions like `refinance` and `_revokeTokenSpendApprovals`.\n\nIf string comparisons are required:\n* hard-code the hash result as `bytes32` constants for common expected strings such as \"aave\", \"morpho\", \"compound\" and using these hard-coded constants inside `_parseProtocol` and other functions\n* in functions such as `RockoFlashRefinance::refinance`, cache the hash of the `from`/`to` inputs in local `bytes32` variables and use the cached hashes and the hard-coded constants for the comparisons\n\nOne simple way to achieve this is by:\n* defining a function to return the hash of a string:\n```solidity\n    function _hashString(string calldata input) private pure returns (bytes32 output) {\n        output = keccak256(bytes(input));\n    }\n```\n* changing `_compareStrings` to take two `bytes32` as input:\n```solidity\n    function _compareStrings(bytes32 a, bytes32 b) private pure returns (bool) {\n        return a == b;\n    }\n```\n\nConsider OpenZeppelin's string equality [implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol#L134-L136) as well.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::_compareStrings` is often called with the same values resulting in duplicate unnecessary work. A simple and more efficient way to prevent this is by first performing the conversion using `_parseProtocol` for both `from`/`to` inputs then simply comparing the enums as needed in functions like `refinance` and `_revokeTokenSpendApprovals`.\n\nIf string comparisons are required:\n* hard-code the hash result as `bytes32` constants for common expected strings such as \"aave\", \"morpho\", \"compound\" and using these hard-coded constants inside `_parseProtocol` and other functions\n* in functions such as `RockoFlashRefinance::refinance`, cache the hash of the `from`/`to` inputs in local `bytes32` variables and use the cached hashes and the hard-coded constants for the comparisons\n\nOne simple way to achieve this is by:\n* defining a function to return the hash of a string:\n```solidity\n    function _hashString(string calldata input) private pure returns (bytes32 output) {\n        output = keccak256(bytes(input));\n    }\n```\n* changing `_compareStrings` to take two `bytes32` as input:\n```solidity\n    function _compareStrings(bytes32 a, bytes32 b) private pure returns (bool) {\n        return a == b;\n    }\n```\n\nConsider OpenZeppelin's string equality [implementation](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Strings.sol#L134-L136) as well.\n\n**Rocko:** Fixed in commit [a59ba0e](https://github.com/getrocko/onchain/commit/a59ba0e7958c544ad95788ce29923a342a2ea35a).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Prevent repetitive hashing of identical strings"
    },
    {
      "index": 15,
      "page_start": null,
      "heading": "15. Don't initialize to default values",
      "markdown": "### Don't initialize to default values\n\n**Description:** Don't initialize to default values as Solidity already does this:\n```solidity\n78:        ROCKO_FEE_BP = 0;\n597:        uint256 debtBalance = 0;\n598:        uint256 morphoDebtShares = 0;\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 319,
      "end_line": 333,
      "markdown_raw": "### Don't initialize to default values\n\n**Description:** Don't initialize to default values as Solidity already does this:\n```solidity\n78:        ROCKO_FEE_BP = 0;\n597:        uint256 debtBalance = 0;\n598:        uint256 morphoDebtShares = 0;\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Don't initialize to default values as Solidity already does this:\n```solidity\n78:        ROCKO_FEE_BP = 0;\n597:        uint256 debtBalance = 0;\n598:        uint256 morphoDebtShares = 0;\n```\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Don't initialize to default values as Solidity already does this:\n```solidity\n78:        ROCKO_FEE_BP = 0;\n597:        uint256 debtBalance = 0;\n598:        uint256 morphoDebtShares = 0;\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Don't initialize to default values as Solidity already does this:\n```solidity\n78:        ROCKO_FEE_BP = 0;\n597:        uint256 debtBalance = 0;\n598:        uint256 morphoDebtShares = 0;\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Don't initialize to default values"
    },
    {
      "index": 16,
      "page_start": null,
      "heading": "16. Use named return variables to eliminate redundant local variables and return statements",
      "markdown": "### Use named return variables to eliminate redundant local variables and `return` statements\n\n**Description:** Use named return variables to eliminate redundant local variables and `return` statements:\n```diff\n// _closeLoanPositionAndReturnCollateralBalance L457\n-    ) private returns (uint256) {\n+    ) private returns (uint256 collateralBalance) {\n\n// L464\n-        uint256 collateralBalance;\n\n// L480\n-        return collateralBalance;\n```\n\nSame idea can be applied to `_collateralBalanceOfAave`, `_getDebtBalanceOfAave`.\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 333,
      "end_line": 355,
      "markdown_raw": "### Use named return variables to eliminate redundant local variables and `return` statements\n\n**Description:** Use named return variables to eliminate redundant local variables and `return` statements:\n```diff\n// _closeLoanPositionAndReturnCollateralBalance L457\n-    ) private returns (uint256) {\n+    ) private returns (uint256 collateralBalance) {\n\n// L464\n-        uint256 collateralBalance;\n\n// L480\n-        return collateralBalance;\n```\n\nSame idea can be applied to `_collateralBalanceOfAave`, `_getDebtBalanceOfAave`.\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Use named return variables to eliminate redundant local variables and `return` statements:\n```diff\n// _closeLoanPositionAndReturnCollateralBalance L457\n-    ) private returns (uint256) {\n+    ) private returns (uint256 collateralBalance) {\n\n// L464\n-        uint256 collateralBalance;\n\n// L480\n-        return collateralBalance;\n```\n\nSame idea can be applied to `_collateralBalanceOfAave`, `_getDebtBalanceOfAave`.\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Use named return variables to eliminate redundant local variables and `return` statements:\n```diff\n// _closeLoanPositionAndReturnCollateralBalance L457\n-    ) private returns (uint256) {\n+    ) private returns (uint256 collateralBalance) {\n\n// L464\n-        uint256 collateralBalance;\n\n// L480\n-        return collateralBalance;\n```\n\nSame idea can be applied to `_collateralBalanceOfAave`, `_getDebtBalanceOfAave`.\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Use named return variables to eliminate redundant local variables and `return` statements:\n```diff\n// _closeLoanPositionAndReturnCollateralBalance L457\n-    ) private returns (uint256) {\n+    ) private returns (uint256 collateralBalance) {\n\n// L464\n-        uint256 collateralBalance;\n\n// L480\n-        return collateralBalance;\n```\n\nSame idea can be applied to `_collateralBalanceOfAave`, `_getDebtBalanceOfAave`.\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Use named return variables to eliminate redundant local variables and return statements"
    },
    {
      "index": 17,
      "page_start": null,
      "heading": "17. Remove redundant onBehalfOf variables",
      "markdown": "### Remove redundant `onBehalfOf` variables\n\n**Description:** Remove redundant `onBehalfOf` variables:\n```diff\n    function _supplyToAave(address collateralAddress, uint256 collateralBalance, address rockoWallet) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.supply(collateralAddress, collateralBalance, onBehalfOf, AAVE_REFERRAL_CODE);\n+       AAVE.supply(collateralAddress, collateralBalance, rockoWallet, AAVE_REFERRAL_CODE);\n    }\n    function _borrowFromAave(address rockoWallet, address token, uint256 borrowAmount) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, onBehalfOf);\n+       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, rockoWallet);\n    }\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 355,
      "end_line": 376,
      "markdown_raw": "### Remove redundant `onBehalfOf` variables\n\n**Description:** Remove redundant `onBehalfOf` variables:\n```diff\n    function _supplyToAave(address collateralAddress, uint256 collateralBalance, address rockoWallet) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.supply(collateralAddress, collateralBalance, onBehalfOf, AAVE_REFERRAL_CODE);\n+       AAVE.supply(collateralAddress, collateralBalance, rockoWallet, AAVE_REFERRAL_CODE);\n    }\n    function _borrowFromAave(address rockoWallet, address token, uint256 borrowAmount) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, onBehalfOf);\n+       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, rockoWallet);\n    }\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** Remove redundant `onBehalfOf` variables:\n```diff\n    function _supplyToAave(address collateralAddress, uint256 collateralBalance, address rockoWallet) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.supply(collateralAddress, collateralBalance, onBehalfOf, AAVE_REFERRAL_CODE);\n+       AAVE.supply(collateralAddress, collateralBalance, rockoWallet, AAVE_REFERRAL_CODE);\n    }\n    function _borrowFromAave(address rockoWallet, address token, uint256 borrowAmount) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, onBehalfOf);\n+       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, rockoWallet);\n    }\n```\n",
        "impact": null,
        "recommendation": null,
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** Remove redundant `onBehalfOf` variables:\n```diff\n    function _supplyToAave(address collateralAddress, uint256 collateralBalance, address rockoWallet) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.supply(collateralAddress, collateralBalance, onBehalfOf, AAVE_REFERRAL_CODE);\n+       AAVE.supply(collateralAddress, collateralBalance, rockoWallet, AAVE_REFERRAL_CODE);\n    }\n    function _borrowFromAave(address rockoWallet, address token, uint256 borrowAmount) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, onBehalfOf);\n+       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, rockoWallet);\n    }\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "markdown_body": "**Description:** Remove redundant `onBehalfOf` variables:\n```diff\n    function _supplyToAave(address collateralAddress, uint256 collateralBalance, address rockoWallet) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.supply(collateralAddress, collateralBalance, onBehalfOf, AAVE_REFERRAL_CODE);\n+       AAVE.supply(collateralAddress, collateralBalance, rockoWallet, AAVE_REFERRAL_CODE);\n    }\n    function _borrowFromAave(address rockoWallet, address token, uint256 borrowAmount) private {\n-       address onBehalfOf = rockoWallet;\n-       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, onBehalfOf);\n+       AAVE.borrow(token, borrowAmount, AAVE_INTERESTE_RATE_MODE, AAVE_REFERRAL_CODE, rockoWallet);\n    }\n```\n\n**Rocko:** Fixed in commit [751e906](https://github.com/getrocko/onchain/commit/751e906b7c2df6cb587e709b12de25593eb02c75).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Remove redundant onBehalfOf variables"
    },
    {
      "index": 18,
      "page_start": null,
      "heading": "18. Remove redundant morphoMarketId validation checks in _closeLoanMorphoWithShares and _openLoanPosition",
      "markdown": "### Remove redundant `morphoMarketId` validation checks in `_closeLoanMorphoWithShares` and `_openLoanPosition`\n\n**Description:** `RockoFlashRefinance::_closeLoanMorphoWithShares` and `_openLoanPosition` contain redundant validation `morphoMarketId`. The reasons why this validation is redundant:\n\n* `RockoFlashRefinance::refinance` already validates the input `morphoMarketId`, encodes it into the `data` payload then calls `Morpho::flashLoan` with the `data` payload:\n```solidity\nif (_compareStrings(to, \"morpho\") || _compareStrings(from, \"morpho\")) {\n    require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n}\n\nbytes memory data = abi.encode(\n    rockoWallet,\n    from,\n    to,\n    debtTokenAddress,\n    collateralTokenAddress,\n    aCollateralTokenAddress,\n    morphoMarketId,\n    morphoDebtShares\n);\n\nMORPHO.flashLoan(debtTokenAddress, debtBalance, data);\n```\n\n* `Morpho::flashLoan` always passes the unmodified `data` payload to `RockoFlashRefinance::onMorphoFlashLoan`:\n```solidity\nfunction flashLoan(address token, uint256 assets, bytes calldata data) external {\n    require(assets != 0, ErrorsLib.ZERO_ASSETS);\n\n    emit EventsLib.FlashLoan(msg.sender, token, assets);\n\n    IERC20(token).safeTransfer(msg.sender, assets);\n\n    // @audit passing unmodified `data` payload to `onMorphoFlashLoan`\n    IMorphoFlashLoanCallback(msg.sender).onMorphoFlashLoan(assets, data);\n\n    IERC20(token).safeTransferFrom(msg.sender, address(this), assets);\n}\n```\n\n*`RockoFlashRefinance::onMorphoFlashLoan` decodes the unmodified `data` payload and calls `_closeLoanMorphoWithShares` and `_openLoanPosition` using the decoded `morphoMarketId` which has already been validated in `RockoFlashRefinance::refinance`.\n\n**Recommended Mitigation:** Remove the redundant `morphoMarketId` validation checks at:\n```solidity\n325: require(_isValidId(morphoMarketId), \"Invalid Morpho Market ID\");\n\n503: require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n```\n\n**Rocko:** Fixed in commit [5a9aa7d](https://github.com/getrocko/onchain/commit/5a9aa7d3cfb80150448608854440c285ea08fa53).\n\n**Cyfrin:** Verified.\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 376,
      "end_line": 430,
      "markdown_raw": "### Remove redundant `morphoMarketId` validation checks in `_closeLoanMorphoWithShares` and `_openLoanPosition`\n\n**Description:** `RockoFlashRefinance::_closeLoanMorphoWithShares` and `_openLoanPosition` contain redundant validation `morphoMarketId`. The reasons why this validation is redundant:\n\n* `RockoFlashRefinance::refinance` already validates the input `morphoMarketId`, encodes it into the `data` payload then calls `Morpho::flashLoan` with the `data` payload:\n```solidity\nif (_compareStrings(to, \"morpho\") || _compareStrings(from, \"morpho\")) {\n    require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n}\n\nbytes memory data = abi.encode(\n    rockoWallet,\n    from,\n    to,\n    debtTokenAddress,\n    collateralTokenAddress,\n    aCollateralTokenAddress,\n    morphoMarketId,\n    morphoDebtShares\n);\n\nMORPHO.flashLoan(debtTokenAddress, debtBalance, data);\n```\n\n* `Morpho::flashLoan` always passes the unmodified `data` payload to `RockoFlashRefinance::onMorphoFlashLoan`:\n```solidity\nfunction flashLoan(address token, uint256 assets, bytes calldata data) external {\n    require(assets != 0, ErrorsLib.ZERO_ASSETS);\n\n    emit EventsLib.FlashLoan(msg.sender, token, assets);\n\n    IERC20(token).safeTransfer(msg.sender, assets);\n\n    // @audit passing unmodified `data` payload to `onMorphoFlashLoan`\n    IMorphoFlashLoanCallback(msg.sender).onMorphoFlashLoan(assets, data);\n\n    IERC20(token).safeTransferFrom(msg.sender, address(this), assets);\n}\n```\n\n*`RockoFlashRefinance::onMorphoFlashLoan` decodes the unmodified `data` payload and calls `_closeLoanMorphoWithShares` and `_openLoanPosition` using the decoded `morphoMarketId` which has already been validated in `RockoFlashRefinance::refinance`.\n\n**Recommended Mitigation:** Remove the redundant `morphoMarketId` validation checks at:\n```solidity\n325: require(_isValidId(morphoMarketId), \"Invalid Morpho Market ID\");\n\n503: require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n```\n\n**Rocko:** Fixed in commit [5a9aa7d](https://github.com/getrocko/onchain/commit/5a9aa7d3cfb80150448608854440c285ea08fa53).\n\n**Cyfrin:** Verified.\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::_closeLoanMorphoWithShares` and `_openLoanPosition` contain redundant validation `morphoMarketId`. The reasons why this validation is redundant:\n\n* `RockoFlashRefinance::refinance` already validates the input `morphoMarketId`, encodes it into the `data` payload then calls `Morpho::flashLoan` with the `data` payload:\n```solidity\nif (_compareStrings(to, \"morpho\") || _compareStrings(from, \"morpho\")) {\n    require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n}\n\nbytes memory data = abi.encode(\n    rockoWallet,\n    from,\n    to,\n    debtTokenAddress,\n    collateralTokenAddress,\n    aCollateralTokenAddress,\n    morphoMarketId,\n    morphoDebtShares\n);\n\nMORPHO.flashLoan(debtTokenAddress, debtBalance, data);\n```\n\n* `Morpho::flashLoan` always passes the unmodified `data` payload to `RockoFlashRefinance::onMorphoFlashLoan`:\n```solidity\nfunction flashLoan(address token, uint256 assets, bytes calldata data) external {\n    require(assets != 0, ErrorsLib.ZERO_ASSETS);\n\n    emit EventsLib.FlashLoan(msg.sender, token, assets);\n\n    IERC20(token).safeTransfer(msg.sender, assets);\n\n    // @audit passing unmodified `data` payload to `onMorphoFlashLoan`\n    IMorphoFlashLoanCallback(msg.sender).onMorphoFlashLoan(assets, data);\n\n    IERC20(token).safeTransferFrom(msg.sender, address(this), assets);\n}\n```\n\n*`RockoFlashRefinance::onMorphoFlashLoan` decodes the unmodified `data` payload and calls `_closeLoanMorphoWithShares` and `_openLoanPosition` using the decoded `morphoMarketId` which has already been validated in `RockoFlashRefinance::refinance`.\n",
        "impact": null,
        "recommendation": "**Recommended Mitigation:** Remove the redundant `morphoMarketId` validation checks at:\n```solidity\n325: require(_isValidId(morphoMarketId), \"Invalid Morpho Market ID\");\n\n503: require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n```\n",
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [5a9aa7d](https://github.com/getrocko/onchain/commit/5a9aa7d3cfb80150448608854440c285ea08fa53).\n\n**Cyfrin:** Verified.\n"
      },
      "description": "**Description:** `RockoFlashRefinance::_closeLoanMorphoWithShares` and `_openLoanPosition` contain redundant validation `morphoMarketId`. The reasons why this validation is redundant:\n\n* `RockoFlashRefinance::refinance` already validates the input `morphoMarketId`, encodes it into the `data` payload then calls `Morpho::flashLoan` with the `data` payload:\n```solidity\nif (_compareStrings(to, \"morpho\") || _compareStrings(from, \"morpho\")) {\n    require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n}\n\nbytes memory data = abi.encode(\n    rockoWallet,\n    from,\n    to,\n    debtTokenAddress,\n    collateralTokenAddress,\n    aCollateralTokenAddress,\n    morphoMarketId,\n    morphoDebtShares\n);\n\nMORPHO.flashLoan(debtTokenAddress, debtBalance, data);\n```\n\n* `Morpho::flashLoan` always passes the unmodified `data` payload to `RockoFlashRefinance::onMorphoFlashLoan`:\n```solidity\nfunction flashLoan(address token, uint256 assets, bytes calldata data) external {\n    require(assets != 0, ErrorsLib.ZERO_ASSETS);\n\n    emit EventsLib.FlashLoan(msg.sender, token, assets);\n\n    IERC20(token).safeTransfer(msg.sender, assets);\n\n    // @audit passing unmodified `data` payload to `onMorphoFlashLoan`\n    IMorphoFlashLoanCallback(msg.sender).onMorphoFlashLoan(assets, data);\n\n    IERC20(token).safeTransferFrom(msg.sender, address(this), assets);\n}\n```\n\n*`RockoFlashRefinance::onMorphoFlashLoan` decodes the unmodified `data` payload and calls `_closeLoanMorphoWithShares` and `_openLoanPosition` using the decoded `morphoMarketId` which has already been validated in `RockoFlashRefinance::refinance`.\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::_closeLoanMorphoWithShares` and `_openLoanPosition` contain redundant validation `morphoMarketId`. The reasons why this validation is redundant:\n\n* `RockoFlashRefinance::refinance` already validates the input `morphoMarketId`, encodes it into the `data` payload then calls `Morpho::flashLoan` with the `data` payload:\n```solidity\nif (_compareStrings(to, \"morpho\") || _compareStrings(from, \"morpho\")) {\n    require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n}\n\nbytes memory data = abi.encode(\n    rockoWallet,\n    from,\n    to,\n    debtTokenAddress,\n    collateralTokenAddress,\n    aCollateralTokenAddress,\n    morphoMarketId,\n    morphoDebtShares\n);\n\nMORPHO.flashLoan(debtTokenAddress, debtBalance, data);\n```\n\n* `Morpho::flashLoan` always passes the unmodified `data` payload to `RockoFlashRefinance::onMorphoFlashLoan`:\n```solidity\nfunction flashLoan(address token, uint256 assets, bytes calldata data) external {\n    require(assets != 0, ErrorsLib.ZERO_ASSETS);\n\n    emit EventsLib.FlashLoan(msg.sender, token, assets);\n\n    IERC20(token).safeTransfer(msg.sender, assets);\n\n    // @audit passing unmodified `data` payload to `onMorphoFlashLoan`\n    IMorphoFlashLoanCallback(msg.sender).onMorphoFlashLoan(assets, data);\n\n    IERC20(token).safeTransferFrom(msg.sender, address(this), assets);\n}\n```\n\n*`RockoFlashRefinance::onMorphoFlashLoan` decodes the unmodified `data` payload and calls `_closeLoanMorphoWithShares` and `_openLoanPosition` using the decoded `morphoMarketId` which has already been validated in `RockoFlashRefinance::refinance`.\n\n**Recommended Mitigation:** Remove the redundant `morphoMarketId` validation checks at:\n```solidity\n325: require(_isValidId(morphoMarketId), \"Invalid Morpho Market ID\");\n\n503: require(_isValidId(morphoMarketId), \"Morpho Market ID required for Morpho refinance\");\n```\n\n**Rocko:** Fixed in commit [5a9aa7d](https://github.com/getrocko/onchain/commit/5a9aa7d3cfb80150448608854440c285ea08fa53).\n\n**Cyfrin:** Verified.\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Remove redundant morphoMarketId validation checks in _closeLoanMorphoWithShares and _openLoanPosition"
    },
    {
      "index": 19,
      "page_start": null,
      "heading": "19. Redundant collateral balance check in _openLoanMorpho",
      "markdown": "### Redundant collateral balance check in `_openLoanMorpho`\n\n**Description:** `RockoFlashRefinance::_openLoanMorpho` contains a redundant check for collateral balance availability. The function verifies that the flash loan contract has sufficient collateral balance, but this check is already performed in the calling `_openLoanPosition` function.\n\n**Recommended Mitigation:**\n```diff\n    function _openLoanMorpho(\n        Id morphoMarketId,\n        uint256 borrowAmount,\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        _checkAllowanceAndApproveContract(address(MORPHO), collateralAddress, collateralBalance);\n        MarketParams memory marketParams = MORPHO.idToMarketParams(morphoMarketId);\n-       uint256 flashLoanContractBalance = IERC20(collateralAddress).balanceOf(FLASH_LOAN_CONTRACT);\n-       // emit LogBalance(\"Flash Loan Contract Balance\", flashLoanContractBalance);\n-       require(\n-           flashLoanContractBalance >= collateralBalance,\n-           \"Insufficient collateral available in the flash contract\"\n-       );\n```\n\n**Rocko:** Fixed in commit [a8efb43](https://github.com/getrocko/onchain/commit/a8efb43b10673508e1fd184aec23a5373f73cd5d).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n",
      "finding_id": null,
      "severity": "Gas",
      "start_line": 430,
      "end_line": 458,
      "markdown_raw": "### Redundant collateral balance check in `_openLoanMorpho`\n\n**Description:** `RockoFlashRefinance::_openLoanMorpho` contains a redundant check for collateral balance availability. The function verifies that the flash loan contract has sufficient collateral balance, but this check is already performed in the calling `_openLoanPosition` function.\n\n**Recommended Mitigation:**\n```diff\n    function _openLoanMorpho(\n        Id morphoMarketId,\n        uint256 borrowAmount,\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        _checkAllowanceAndApproveContract(address(MORPHO), collateralAddress, collateralBalance);\n        MarketParams memory marketParams = MORPHO.idToMarketParams(morphoMarketId);\n-       uint256 flashLoanContractBalance = IERC20(collateralAddress).balanceOf(FLASH_LOAN_CONTRACT);\n-       // emit LogBalance(\"Flash Loan Contract Balance\", flashLoanContractBalance);\n-       require(\n-           flashLoanContractBalance >= collateralBalance,\n-           \"Insufficient collateral available in the flash contract\"\n-       );\n```\n\n**Rocko:** Fixed in commit [a8efb43](https://github.com/getrocko/onchain/commit/a8efb43b10673508e1fd184aec23a5373f73cd5d).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n",
      "sections": {
        "description": "**Description:** `RockoFlashRefinance::_openLoanMorpho` contains a redundant check for collateral balance availability. The function verifies that the flash loan contract has sufficient collateral balance, but this check is already performed in the calling `_openLoanPosition` function.\n",
        "impact": null,
        "recommendation": "**Recommended Mitigation:**\n```diff\n    function _openLoanMorpho(\n        Id morphoMarketId,\n        uint256 borrowAmount,\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        _checkAllowanceAndApproveContract(address(MORPHO), collateralAddress, collateralBalance);\n        MarketParams memory marketParams = MORPHO.idToMarketParams(morphoMarketId);\n-       uint256 flashLoanContractBalance = IERC20(collateralAddress).balanceOf(FLASH_LOAN_CONTRACT);\n-       // emit LogBalance(\"Flash Loan Contract Balance\", flashLoanContractBalance);\n-       require(\n-           flashLoanContractBalance >= collateralBalance,\n-           \"Insufficient collateral available in the flash contract\"\n-       );\n```\n",
        "poc": null,
        "fix_status": null,
        "other": "**Rocko:** Fixed in commit [a8efb43](https://github.com/getrocko/onchain/commit/a8efb43b10673508e1fd184aec23a5373f73cd5d).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n"
      },
      "description": "**Description:** `RockoFlashRefinance::_openLoanMorpho` contains a redundant check for collateral balance availability. The function verifies that the flash loan contract has sufficient collateral balance, but this check is already performed in the calling `_openLoanPosition` function.\n",
      "markdown_body": "**Description:** `RockoFlashRefinance::_openLoanMorpho` contains a redundant check for collateral balance availability. The function verifies that the flash loan contract has sufficient collateral balance, but this check is already performed in the calling `_openLoanPosition` function.\n\n**Recommended Mitigation:**\n```diff\n    function _openLoanMorpho(\n        Id morphoMarketId,\n        uint256 borrowAmount,\n        address collateralAddress,\n        uint256 collateralBalance,\n        address rockoWallet\n    ) private {\n        _checkAllowanceAndApproveContract(address(MORPHO), collateralAddress, collateralBalance);\n        MarketParams memory marketParams = MORPHO.idToMarketParams(morphoMarketId);\n-       uint256 flashLoanContractBalance = IERC20(collateralAddress).balanceOf(FLASH_LOAN_CONTRACT);\n-       // emit LogBalance(\"Flash Loan Contract Balance\", flashLoanContractBalance);\n-       require(\n-           flashLoanContractBalance >= collateralBalance,\n-           \"Insufficient collateral available in the flash contract\"\n-       );\n```\n\n**Rocko:** Fixed in commit [a8efb43](https://github.com/getrocko/onchain/commit/a8efb43b10673508e1fd184aec23a5373f73cd5d).\n\n**Cyfrin:** Verified.\n\n\\clearpage\n",
      "metadata": {
        "Severity": "Gas",
        "Difficulty": null,
        "Type": null,
        "Finding ID": null,
        "Target": null
      },
      "heading_cleaned": "Redundant collateral balance check in _openLoanMorpho"
    }
  ]
}