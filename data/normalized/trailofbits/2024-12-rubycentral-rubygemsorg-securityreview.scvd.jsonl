{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-001", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 1, "page_start": 21, "title": "Docker Compose ports exposed on all interfaces", "short_summary": null, "description_md": "#### Description\n\nTo specify Docker ports, docker-compose.yml configuration files use the ports configuration option of, for example, 5432:5432 for the Postgres container (figure 1.1). This means that these ports are accessible not just to other processes running on the same computer, but also from other computers on the same network.\n\n```\ndb:\n  image: postgres:13.14\n  ports:\n    - \"5432:5432\"\n  environment:\n    - POSTGRES_HOST_AUTH_METHOD=trust\n```\n\n*Figure 1.1: Ports exposed on all interfaces ([rubygems.org/docker-compose.yml:2–7](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/docker-compose.yml#L2-L7))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "| 1. Docker Compose ports exposed on all interfaces |                             |  |\n|------------------------------------------------------------------------|-----------------------------|--|\n| Severity: Low                                                       | Diffi culty: High     |  |\n| Type: Configuration                                                 | Finding ID: TOB-RGM-1 |  |\n\nTarget: rubygems.org/docker-compose.yml\n\n#### Description\n\nTo specify Docker ports, docker-compose.yml configuration files use the ports configuration option of, for example, 5432:5432 for the Postgres container (figure 1.1). This means that these ports are accessible not just to other processes running on the same computer, but also from other computers on the same network.\n\n```\ndb:\n  image: postgres:13.14\n  ports:\n    - \"5432:5432\"\n  environment:\n    - POSTGRES_HOST_AUTH_METHOD=trust\n```\n\n*Figure 1.1: Ports exposed on all interfaces ([rubygems.org/docker-compose.yml:2–7](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/docker-compose.yml#L2-L7))*\n\n#### Exploit Scenario\n\nA Ruby Central developer runs this docker-compose.yml file while on a public Wi-Fi network. An attacker on the same network connects to the Postgres database running on the developer's computer; this database is available on port 5432 and uses the default password postgres. The attacker can then read and modify any data in the developer's database.\n\n#### Recommendations\n\nShort term, modify these configuration values, setting them to 127.0.0.1:5432:5432 instead of 5432:5432.\n\nLong term, use the [port-all-interfaces](https://github.com/trailofbits/semgrep-rules/blob/main/yaml/docker-compose/port-all-interfaces.yaml) Semgrep static analysis rule to detect and flag instances of this configuration pattern.\n\n#### References\n\n● [Compose file version](https://docs.docker.com/compose/compose-file/compose-file-v3/#ports) 3 reference: ports\n", "severity": "Low", "difficulty": "High", "type": "Configuration", "finding_id": "TOB-RGM-1", "target": {"path": "rubygems.org/docker-compose.yml", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems.org", "org": "rubygems", "name": "rubygems.org", "commit": "21895a522076d15a3cb8d072229e2cfdbdb873e8", "branch": null, "relative_file": "rubygems.org/docker-compose.yml", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Configuration", "Finding ID": "TOB-RGM-1", "Target": "rubygems.org/docker-compose.yml"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-002", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 2, "page_start": 22, "title": "Rails cookies lack SameSite protections", "short_summary": null, "description_md": "## Description\n\nAs [stated](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value) in MDN, the SameSite cookie attribute provides the following functionality:\n\nControls whether or not a cookie is sent with cross-site requests, providing some protection against cross-site request forgery attacks (CSRF).\n\nRubyGems disables strict SameSite protections in a number of locations by setting the attributes value to Lax. For example, the following location sets this value explicitly:\n\n```\ndef log_in_as(user:, expires: 1.hour)\n  cookies.encrypted[admin_cookie_name] = {\n    value: user.id,\n    expires: expires,\n    same_site: :lax\n  }\nend\n```\n\n*Figure 2.1: Admin cookie setting SameSite=Lax ([rubygems.org/lib/github\\\\_oauthable.rb#72–78](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/lib/github_oauthable.rb#L72-L78))*\n\nThis value is also implicitly set on the Rails session cookie in the following location:\n\n```\nRails.application.config.session_store :cookie_store, key: '_rubygems_session'\n               Figure 2.2: Session cookie implicitly setting SameSite=Lax\n           (rubygems.org/config/initializers/session_store.rb#8)\n```\n\nBy default, when using cookie\\_store, the session cookie will set [SameSite](https://guides.rubyonrails.org/configuring.html#config-action-dispatch-cookies-same-site-protection)=Lax. This is better than setting the value to None, but it still ultimately introduces the risk of CSRF attacks. Because Rails provides built-in CSRF protections, this is a defense-in-depth improvement; this finding's severity is therefore low.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 2. Rails cookies lack SameSite protections\n\n| Severity: Low                                                                                      | Diffi culty: High     |\n|-------------------------------------------------------------------------------------------------------|-----------------------------|\n| Type: Configuration                                                                                | Finding ID: TOB-RGM-2 |\n| Target: rubygems.org/lib/github_oauthable.rb, rubygems.org/config/initializers/session_store.rb |                             |\n\n## Description\n\nAs [stated](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#samesitesamesite-value) in MDN, the SameSite cookie attribute provides the following functionality:\n\nControls whether or not a cookie is sent with cross-site requests, providing some protection against cross-site request forgery attacks (CSRF).\n\nRubyGems disables strict SameSite protections in a number of locations by setting the attributes value to Lax. For example, the following location sets this value explicitly:\n\n```\ndef log_in_as(user:, expires: 1.hour)\n  cookies.encrypted[admin_cookie_name] = {\n    value: user.id,\n    expires: expires,\n    same_site: :lax\n  }\nend\n```\n\n*Figure 2.1: Admin cookie setting SameSite=Lax ([rubygems.org/lib/github\\\\_oauthable.rb#72–78](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/lib/github_oauthable.rb#L72-L78))*\n\nThis value is also implicitly set on the Rails session cookie in the following location:\n\n```\nRails.application.config.session_store :cookie_store, key: '_rubygems_session'\n               Figure 2.2: Session cookie implicitly setting SameSite=Lax\n           (rubygems.org/config/initializers/session_store.rb#8)\n```\n\nBy default, when using cookie\\_store, the session cookie will set [SameSite](https://guides.rubyonrails.org/configuring.html#config-action-dispatch-cookies-same-site-protection)=Lax. This is better than setting the value to None, but it still ultimately introduces the risk of CSRF attacks. Because Rails provides built-in CSRF protections, this is a defense-in-depth improvement; this finding's severity is therefore low.\n\n#### Exploit Scenario\n\nAn attacker discovers a GET-based CSRF vulnerability in the RubyGems application. They then discover a bypass for built-in protections, or discover a controller that has set\n\n\n\n[skip\\\\_forgery\\\\_protection](https://api.rubyonrails.org/classes/ActionController/RequestForgeryProtection/ClassMethods.html#method-i-skip_forgery_protection). They are then able to carry out the CSRF attack due to a lack of SameSite protections on RubyGems cookies.\n\n#### Recommendations\n\nShort term, configure SameSite=Strict on all application cookies.\n\nLong term, incorporate the rails-cookie-attributes Semgrep rule from [appendix](#page-89-0) E.2 into your CI systems.\n", "severity": "Low", "difficulty": "High", "type": "Configuration", "finding_id": "TOB-RGM-2", "target": {"path": "rubygems.org/lib/github_oauthable.rb, rubygems.org/config/initializers/session_store.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems.org", "org": "rubygems", "name": "rubygems.org", "commit": "21895a522076d15a3cb8d072229e2cfdbdb873e8", "branch": null, "relative_file": "rubygems.org/lib/github_oauthable.rb, rubygems.org/config/initializers/session_store.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Configuration", "Finding ID": "TOB-RGM-2", "Target": "rubygems.org/lib/github_oauthable.rb, rubygems.org/config/initializers/session_store.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-003", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 3, "page_start": 24, "title": "Memcached cache store may allow Marshal deserialization", "short_summary": null, "description_md": "#### Description\n\nDeserialization of attacker-controlled [Marshal](https://ruby-doc.org/3.3.4/Marshal.html#module-Marshal-label-Security+considerations) data may result in remote code execution. The RubyGems application uses Memcached as its cache store in the following location:\n\n```\nconfig.cache_store = :mem_cache_store, ENV['MEMCACHED_ENDPOINT'], {\n  failover: true,\n  socket_timeout: 1.5,\n  socket_failure_delay: 0.2,\n  compress: true,\n  compression_min_size: 524_288,\n  value_max_bytes: 2_097_152 # 2MB\n}\n```\n\n*Figure 3.1: Rails Memcached cache store ([rubygems.org/config/environments/production.rb#116–123](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/environments/production.rb#L116-L123))*\n\nThe :mem\\_cache\\_store symbol maps to the [MemCacheStore](https://api.rubyonrails.org/v7.1.3.4/classes/ActiveSupport/Cache/MemCacheStore.html), which subclasses [ActiveSupport::Cache::Store](https://api.rubyonrails.org/v7.1.3.4/classes/ActiveSupport/Cache/Store.html). This parent class allows a [serializer](https://api.rubyonrails.org/v7.1.3.4/classes/ActiveSupport/Cache/Store.html#method-c-new) to be configured. The default serializer for Rails 7.1 is [:marshal\\\\_7\\\\_1](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache.rb#L775). The serializer can be configured as [:message\\\\_pack](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache/serializer_with_fallback.rb#L166-L172), which will default to a more secure serialization format; however, it will [fallback](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache/serializer_with_fallback.rb#L141) to the insecure Marshal format if it receives Marshal data. A custom serializer is needed to completely mitigate this attack vector.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 3. Memcached cache store may allow Marshal deserialization\n\n| Severity: Informational                                | Diffi culty: High     |\n|-----------------------------------------------------------|-----------------------------|\n| Type: Data Validation                               | Finding ID: TOB-RGM-3 |\n| Target: rubygems.org/config/environments/production.rb |                             |\n\n#### Description\n\nDeserialization of attacker-controlled [Marshal](https://ruby-doc.org/3.3.4/Marshal.html#module-Marshal-label-Security+considerations) data may result in remote code execution. The RubyGems application uses Memcached as its cache store in the following location:\n\n```\nconfig.cache_store = :mem_cache_store, ENV['MEMCACHED_ENDPOINT'], {\n  failover: true,\n  socket_timeout: 1.5,\n  socket_failure_delay: 0.2,\n  compress: true,\n  compression_min_size: 524_288,\n  value_max_bytes: 2_097_152 # 2MB\n}\n```\n\n*Figure 3.1: Rails Memcached cache store ([rubygems.org/config/environments/production.rb#116–123](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/environments/production.rb#L116-L123))*\n\nThe :mem\\_cache\\_store symbol maps to the [MemCacheStore](https://api.rubyonrails.org/v7.1.3.4/classes/ActiveSupport/Cache/MemCacheStore.html), which subclasses [ActiveSupport::Cache::Store](https://api.rubyonrails.org/v7.1.3.4/classes/ActiveSupport/Cache/Store.html). This parent class allows a [serializer](https://api.rubyonrails.org/v7.1.3.4/classes/ActiveSupport/Cache/Store.html#method-c-new) to be configured. The default serializer for Rails 7.1 is [:marshal\\\\_7\\\\_1](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache.rb#L775). The serializer can be configured as [:message\\\\_pack](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache/serializer_with_fallback.rb#L166-L172), which will default to a more secure serialization format; however, it will [fallback](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache/serializer_with_fallback.rb#L141) to the insecure Marshal format if it receives Marshal data. A custom serializer is needed to completely mitigate this attack vector.\n\n#### Exploit Scenario\n\nAn attacker gains unauthorized access to the Memcached instance(s) used by the RubyGems application. This could occur due a separate vulnerability such as server-side request forgery (SSRF), or improper access controls configured on the Memcached instance(s). The attacker could then add malicious, serialized Marshal objects to the instance(s) that are later deserialized by the application, resulting in code execution.\n\nAt this time, we are unaware of any entrypoints to add malicious Marshal objects to production Memcached instance(s), so we have marked this finding as informational. However, similar attack chains have been observed. For example, GitHub Enterprise saw a similar vulnerability chain presented in A New Era of SSRF, included in the References section below.\n\n\n#### Recommendations\n\nShort term, create a custom JSON or MessagePack serializer that does not fallback on deserializing Marshal data. ActiveSupport::Cache::Store supports specifying a custom [serializer](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache.rb#L327-L328) module. Something similar to [MessagePackWithFallback](https://github.com/rails/rails/blob/v7.1.4/activesupport/lib/active_support/cache/serializer_with_fallback.rb#L140-L164) can be used, except without the fallback.\n\nLong term, incorporate the rails-cache-store-marshal Semgrep rule from [appendix](#page-89-0) [E.2](#page-89-0) into your CI systems.\n\n#### References\n\n● A New Era of SSRF - Exploiting URL Parser in Trending [Programming](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf) Languages!\n", "severity": "Informational", "difficulty": "High", "type": "Data Validation", "finding_id": "TOB-RGM-3", "target": {"path": "rubygems.org/config/environments/production.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems.org", "org": "rubygems", "name": "rubygems.org", "commit": "21895a522076d15a3cb8d072229e2cfdbdb873e8", "branch": null, "relative_file": "rubygems.org/config/environments/production.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Data Validation", "Finding ID": "TOB-RGM-3", "Target": "rubygems.org/config/environments/production.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-004", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 4, "page_start": 26, "title": "HSTS includeSubDomains disabled in production environment", "short_summary": null, "description_md": "#### Description\n\nThe HTTP [Strict-Transport-Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) (HSTS) response header ensures that subsequent connections to a site are encrypted. Additionally, the [includeSubDomains](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security#includesubdomains) directive applies the same configuration to all of a domain's subdomains. The production environment disables this functionality in the following location:\n\n```\n# Force all access to the app over SSL, use Strict-Transport-Security, and use\nsecure cookies.\nconfig.force_ssl = true\nconfig.ssl_options = {\n  hsts: { expires: 365.days, subdomains: false },\n  redirect: {\n    exclude: ->(request) { request.path.start_with?('/internal') }\n  }\n}\n```\n\n*Figure 4.1: HSTS includeSubDomains disabled ([rubygems.org/config/environments/production.rb#53–60](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/environments/production.rb#L53-L60))*\n\nNote that the staging environment repeats this configuration.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 4. HSTS includeSubDomains disabled in production environment\n\n| Severity: Low                                          | Diffi culty: High     |\n|-----------------------------------------------------------|-----------------------------|\n| Type: Cryptography                                     | Finding ID: TOB-RGM-4 |\n| Target: rubygems.org/config/environments/production.rb |                             |\n\n#### Description\n\nThe HTTP [Strict-Transport-Security](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security) (HSTS) response header ensures that subsequent connections to a site are encrypted. Additionally, the [includeSubDomains](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Strict-Transport-Security#includesubdomains) directive applies the same configuration to all of a domain's subdomains. The production environment disables this functionality in the following location:\n\n```\n# Force all access to the app over SSL, use Strict-Transport-Security, and use\nsecure cookies.\nconfig.force_ssl = true\nconfig.ssl_options = {\n  hsts: { expires: 365.days, subdomains: false },\n  redirect: {\n    exclude: ->(request) { request.path.start_with?('/internal') }\n  }\n}\n```\n\n*Figure 4.1: HSTS includeSubDomains disabled ([rubygems.org/config/environments/production.rb#53–60](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/environments/production.rb#L53-L60))*\n\nNote that the staging environment repeats this configuration.\n\n#### Exploit Scenario\n\nAn attacker can perform a downgrade attack against a target connecting to a subdomain of RubyGems.org. They may also passively intercept subsequent HTTP connections after an initial HTTPS connection to subdomains of RubyGems.org.\n\n#### Recommendations\n\nShort term, enable the includeSubDomains directive for HSTS response headers.\n\nLong term, incorporate the action-dispatch-insecure-ssl Semgrep rule from [appendix](#page-89-0) E.2 into your CI systems.\n", "severity": "Low", "difficulty": "High", "type": "Cryptography", "finding_id": "TOB-RGM-4", "target": {"path": "rubygems.org/config/environments/production.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems.org", "org": "rubygems", "name": "rubygems.org", "commit": "21895a522076d15a3cb8d072229e2cfdbdb873e8", "branch": null, "relative_file": "rubygems.org/config/environments/production.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Cryptography", "Finding ID": "TOB-RGM-4", "Target": "rubygems.org/config/environments/production.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-005", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 5, "page_start": 27, "title": "SMTP mailer may fallback on unencrypted communication", "short_summary": null, "description_md": "#### Description\n\nRails uses ActionMailer to dynamically send emails. It uses the smtp\\_settings option to configure its SMTP deliveries. The RubyGems application configures these settings in the following location:\n\n```\nunless Rails.env.local?\n ActionMailer::Base.smtp_settings = {\n   address: 'smtp.sendgrid.net',\n   port: 587,\n   user_name: ENV['SENDGRID_USERNAME'],\n   password: ENV['SENDGRID_PASSWORD'],\n   domain: 'mailer.rubygems.org',\n   authentication: :plain,\n   enable_starttls_auto: true\n }\n ActionMailer::Base.delivery_method = :smtp\nend\n```\n\n*Figure 5.1: Rails SMTP configuration ([rubygems.org/config/initializers/sendgrid.rb#1–13](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/initializers/sendgrid.rb))*\n\nThe StartTLS protocol command is used to establish encrypted communication with the SMTP server. The enable\\_starttls\\_auto setting attempts to establish an encrypted channel, but falls back on unencrypted communication if it fails. However, the [enable\\\\_starttls](https://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration) setting requires a successful StartTLS and fails if it is unsupported.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 5. SMTP mailer may fallback on unencrypted communication\n\n| Severity: High                                       | Diffi culty: High     |\n|---------------------------------------------------------|-----------------------------|\n| Type: Cryptography                                   | Finding ID: TOB-RGM-5 |\n| Target: rubygems.org/config/initializers/sendgrid.rb |                             |\n\n#### Description\n\nRails uses ActionMailer to dynamically send emails. It uses the smtp\\_settings option to configure its SMTP deliveries. The RubyGems application configures these settings in the following location:\n\n```\nunless Rails.env.local?\n ActionMailer::Base.smtp_settings = {\n   address: 'smtp.sendgrid.net',\n   port: 587,\n   user_name: ENV['SENDGRID_USERNAME'],\n   password: ENV['SENDGRID_PASSWORD'],\n   domain: 'mailer.rubygems.org',\n   authentication: :plain,\n   enable_starttls_auto: true\n }\n ActionMailer::Base.delivery_method = :smtp\nend\n```\n\n*Figure 5.1: Rails SMTP configuration ([rubygems.org/config/initializers/sendgrid.rb#1–13](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/initializers/sendgrid.rb))*\n\nThe StartTLS protocol command is used to establish encrypted communication with the SMTP server. The enable\\_starttls\\_auto setting attempts to establish an encrypted channel, but falls back on unencrypted communication if it fails. However, the [enable\\\\_starttls](https://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration) setting requires a successful StartTLS and fails if it is unsupported.\n\n#### Exploit Scenario\n\nAn attacker is in a privileged network position between the RubyGems application server and the remote SMTP server. When the application server attempts to connect to the SMTP server, the attacker removes StartTLS commands during the initial handshake. They then return an unsupported error to the application server to downgrade the connection to an unencrypted stream.\n\n#### Recommendations\n\nShort term, change the enable\\_starttls\\_auto setting to enable\\_starttls.\n\n\n\nLong term, incorporate the action-mailer-insecure-tls Semgrep rule from [appendix](#page-89-0) [E.2](#page-89-0) into your CI systems.\n", "severity": "High", "difficulty": "High", "type": "Cryptography", "finding_id": "TOB-RGM-5", "target": {"path": "rubygems.org/config/initializers/sendgrid.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rails/rails", "org": "rails", "name": "rails", "commit": null, "branch": null, "relative_file": "rubygems.org/config/initializers/sendgrid.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "High", "Difficulty": "High", "Type": "Cryptography", "Finding ID": "TOB-RGM-5", "Target": "rubygems.org/config/initializers/sendgrid.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-006", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 6, "page_start": 29, "title": "Avo controller sets Content-Security-Policy unsafe\\_inline", "short_summary": null, "description_md": "#### Description\n\nThe Content-Security-Policy HTTP header allows web servers to specify content that the web page will load. It is often used to protect against attacks like XSS and clickjacking. The RubyGems application configures the Avo controller's style-src to include unsafe\\_inline:\n\n```\nAvo::ApplicationController.content_security_policy do |policy|\n  policy.style_src :self, \"https://fonts.googleapis.com\", :unsafe_inline\nend\n```\n\n*Figure 6.1: Avo controller configures style-src with :unsafe\\_inline ([rubygems.org/config/initializers/avo.rb#141–143](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/initializers/avo.rb#L141-L143))*\n\nThis allows including arbitrary inline style elements or attributes on elements (e.g., in combination with HTML injection). We are unaware of any vulnerabilities that are associated or could be chained with this functionality. However, privacy concerns or unknown attack vectors may still exist, as style elements may import additional stylesheets.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 6. Avo controller sets Content-Security-Policy unsafe\\_inline\n\n| Severity: Informational                         | Diffi culty: High     |\n|----------------------------------------------------|-----------------------------|\n| Type: Configuration                             | Finding ID: TOB-RGM-6 |\n| Target: rubygems.org/config/initializers/avo.rb |                             |\n\n#### Description\n\nThe Content-Security-Policy HTTP header allows web servers to specify content that the web page will load. It is often used to protect against attacks like XSS and clickjacking. The RubyGems application configures the Avo controller's style-src to include unsafe\\_inline:\n\n```\nAvo::ApplicationController.content_security_policy do |policy|\n  policy.style_src :self, \"https://fonts.googleapis.com\", :unsafe_inline\nend\n```\n\n*Figure 6.1: Avo controller configures style-src with :unsafe\\_inline ([rubygems.org/config/initializers/avo.rb#141–143](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/config/initializers/avo.rb#L141-L143))*\n\nThis allows including arbitrary inline style elements or attributes on elements (e.g., in combination with HTML injection). We are unaware of any vulnerabilities that are associated or could be chained with this functionality. However, privacy concerns or unknown attack vectors may still exist, as style elements may import additional stylesheets.\n\n#### Recommendations\n\nShort term, remove the :unsafe\\_inline directive.\n\nLong term, if the above recommendation is not feasible, consider using style-src nonces (included in the References section below). These nonces allow a web page to verify the integrity of the stylesheet data it is receiving.\n\n#### References\n\n- CSP style-src [unsafe inline styles](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/style-src#unsafe_inline_styles)\n- CSS [Injection](https://vwzq.net/slides/2019-s3_css_injection_attacks.pdf) Attacks\n- [Exfiltration](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d) via CSS Injection\n- Better [Exfiltration](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b) via HTML Injection\n", "severity": "Informational", "difficulty": "High", "type": "Configuration", "finding_id": "TOB-RGM-6", "target": {"path": "rubygems.org/config/initializers/avo.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rails/rails", "org": "rails", "name": "rails", "commit": null, "branch": null, "relative_file": "rubygems.org/config/initializers/avo.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Configuration", "Finding ID": "TOB-RGM-6", "Target": "rubygems.org/config/initializers/avo.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-007", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 7, "page_start": 30, "title": "Any user can fire webhooks for the gemcutter gem", "short_summary": null, "description_md": "#### Description\n\nThe RubyGems service offers web hook functionality for a user's gems. The documentation for this functionality is limited, and appears to be available only in the API [documentation](https://guides.rubygems.org/rubygems-org-api/#webhook-methods). Web hooks have a \"fire\" API endpoint that allows a user to test their web hook:\n\n```\ndef fire\n  webhook = @api_key.user.web_hooks.new(url: @url)\n  @rubygem ||= Rubygem.find_by_name(\"gemcutter\")\n  authorize webhook\n  if webhook.fire(request.protocol.delete(\"://\"), request.host_with_port,\n                  @rubygem.most_recent_version, delayed: false)\n    render plain: webhook.deployed_message(@rubygem)\n  else\n    render_bad_request webhook.failed_message(@rubygem)\n  end\nend\n```\n\n*Figure 7.1: Web hook test fire functionality ([rubygems.org/app/controllers/api/v1/web\\\\_hooks\\\\_controller.rb#32–44](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/web_hooks_controller.rb#L32-L44))*\n\nIf the string \"\\*\" is provided as the gem name, then the application will fire a web hook for the gemcutter gem. Any user can initiate this API call and send the result to a URL of their choosing. We observed the following request sent to a URL of our choosing:\n\n```\nPOST / HTTP/1.1\nUser-Agent: Faraday v2.10.1\nAuthorization: <REDACTED>\nHr_target_url: https://rhcixkbny57mb6prujw4r20nve15pvdk.oastify.com\nHr_max_attempts: 3\nContent-Type: application/json\n...\nHost: rhcixkbny57mb6prujw4r20nve15pvdk.oastify.com\nContent-Length: 1560\n{\"name\":\"gemcutter\",\"downloads\":1546928,\"version\":\"0.7.1\", ...}\n```\n\n*Figure 7.2: Web hook request for gemcutter gem*\n\n\nNote that this finding was originally marked as low severity, but has been changed to informational in the final comprehensive report. Any RubyGems user can configure web hooks for any gem, so an attacker firing web hooks for the gemcutter gem is not an additional privilege.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 7. Any user can fire webhooks for the gemcutter gem\n\n| Severity: Informational                                | Diffi culty: Low      |\n|-----------------------------------------------------------|-----------------------------|\n| Type: Access Controls                               | Finding ID: TOB-RGM-7 |\n| Target: app/controllers/api/v1/web_hooks_controller.rb |                             |\n\n#### Description\n\nThe RubyGems service offers web hook functionality for a user's gems. The documentation for this functionality is limited, and appears to be available only in the API [documentation](https://guides.rubygems.org/rubygems-org-api/#webhook-methods). Web hooks have a \"fire\" API endpoint that allows a user to test their web hook:\n\n```\ndef fire\n  webhook = @api_key.user.web_hooks.new(url: @url)\n  @rubygem ||= Rubygem.find_by_name(\"gemcutter\")\n  authorize webhook\n  if webhook.fire(request.protocol.delete(\"://\"), request.host_with_port,\n                  @rubygem.most_recent_version, delayed: false)\n    render plain: webhook.deployed_message(@rubygem)\n  else\n    render_bad_request webhook.failed_message(@rubygem)\n  end\nend\n```\n\n*Figure 7.1: Web hook test fire functionality ([rubygems.org/app/controllers/api/v1/web\\\\_hooks\\\\_controller.rb#32–44](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/web_hooks_controller.rb#L32-L44))*\n\nIf the string \"\\*\" is provided as the gem name, then the application will fire a web hook for the gemcutter gem. Any user can initiate this API call and send the result to a URL of their choosing. We observed the following request sent to a URL of our choosing:\n\n```\nPOST / HTTP/1.1\nUser-Agent: Faraday v2.10.1\nAuthorization: <REDACTED>\nHr_target_url: https://rhcixkbny57mb6prujw4r20nve15pvdk.oastify.com\nHr_max_attempts: 3\nContent-Type: application/json\n...\nHost: rhcixkbny57mb6prujw4r20nve15pvdk.oastify.com\nContent-Length: 1560\n{\"name\":\"gemcutter\",\"downloads\":1546928,\"version\":\"0.7.1\", ...}\n```\n\n*Figure 7.2: Web hook request for gemcutter gem*\n\n\nNote that this finding was originally marked as low severity, but has been changed to informational in the final comprehensive report. Any RubyGems user can configure web hooks for any gem, so an attacker firing web hooks for the gemcutter gem is not an additional privilege.\n\n#### Recommendations\n\nShort term, remove the gemcutter web hook fire fallback.\n\nLong term, considering documenting the web hook functionality or removing it if it is no longer needed.\n", "severity": "Informational", "difficulty": "Low", "type": "Access Controls", "finding_id": "TOB-RGM-7", "target": {"path": "app/controllers/api/v1/web_hooks_controller.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/stripe/smokescreen", "org": "stripe", "name": "smokescreen", "commit": null, "branch": null, "relative_file": "app/controllers/api/v1/web_hooks_controller.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "Low", "Type": "Access Controls", "Finding ID": "TOB-RGM-7", "Target": "app/controllers/api/v1/web_hooks_controller.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-008", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 8, "page_start": 32, "title": "SSRF to internal URLs in web hook functionality", "short_summary": null, "description_md": "#### Description\n\nWeb hook test \"fire\" functionality allows specifying sensitive hostnames like localhost and IPs like 10.0.0.1. This allows an attacker to perform SSRF attacks against internal hosts. This functionality exists as an Active Job in the following locations:\n\n```\ndef fire(protocol, host_with_port, version, delayed: true)\n  job = NotifyWebHookJob.new(webhook: self, protocol:, host_with_port:, version:)\n  if delayed\n    job.enqueue\n  else\n    job.perform_now\n  end\nend\n```\n\n*Figure 8.1: Active Record model for firing web hooks ([rubygems.org/app/models/web\\\\_hook.rb#23–31](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/models/web_hook.rb#L23-L31))*\n\nThis functionality ultimately makes an HTTP POST request to an attacker-specified URL in the following location:\n\n```\ndef payload\n  rubygem.payload(version, protocol, host_with_port).to_json\nend\n...\ndef post(url)\n  Faraday.new(nil, request: { timeout: TIMEOUT_SEC }) do |f|\n    f.request :json\n    f.response :logger, logger, headers: false, errors: true\n    f.response :raise_error\n  end.post(\n    url, payload,\n    {\n      \"Authorization\" => authorization,\n      \"HR_TARGET_URL\" => webhook.url,\n      \"HR_MAX_ATTEMPTS\" => \"3\"\n    }\n```\n\n\n) end\n\n> *Figure 8.2: HTTP POST request to URL ([rubygems.org/app/jobs/notify\\\\_web\\\\_hook\\\\_job.rb#77–90](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/jobs/notify_web_hook_job.rb#L77-L90))*\n\nTests to most internal URLs seemingly fail, which is not observable to the outside user. However, firing a web hook to http://localhost:3000/api/v1/gems appears to succeed, which indicates that SSRF attacks to internal hosts are possible.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 8. SSRF to internal URLs in web hook functionality\n\n| Severity: Medium                                                                             | Diffi culty: Low      |\n|-------------------------------------------------------------------------------------------------|-----------------------------|\n| Type: Data Validation                                                                     | Finding ID: TOB-RGM-8 |\n| Target: rubygems.org/app/models/web_hook.rb, rubygems.org/app/jobs/notify_web_hook_job.rb |                             |\n\n#### Description\n\nWeb hook test \"fire\" functionality allows specifying sensitive hostnames like localhost and IPs like 10.0.0.1. This allows an attacker to perform SSRF attacks against internal hosts. This functionality exists as an Active Job in the following locations:\n\n```\ndef fire(protocol, host_with_port, version, delayed: true)\n  job = NotifyWebHookJob.new(webhook: self, protocol:, host_with_port:, version:)\n  if delayed\n    job.enqueue\n  else\n    job.perform_now\n  end\nend\n```\n\n*Figure 8.1: Active Record model for firing web hooks ([rubygems.org/app/models/web\\\\_hook.rb#23–31](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/models/web_hook.rb#L23-L31))*\n\nThis functionality ultimately makes an HTTP POST request to an attacker-specified URL in the following location:\n\n```\ndef payload\n  rubygem.payload(version, protocol, host_with_port).to_json\nend\n...\ndef post(url)\n  Faraday.new(nil, request: { timeout: TIMEOUT_SEC }) do |f|\n    f.request :json\n    f.response :logger, logger, headers: false, errors: true\n    f.response :raise_error\n  end.post(\n    url, payload,\n    {\n      \"Authorization\" => authorization,\n      \"HR_TARGET_URL\" => webhook.url,\n      \"HR_MAX_ATTEMPTS\" => \"3\"\n    }\n```\n\n\n) end\n\n> *Figure 8.2: HTTP POST request to URL ([rubygems.org/app/jobs/notify\\\\_web\\\\_hook\\\\_job.rb#77–90](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/jobs/notify_web_hook_job.rb#L77-L90))*\n\nTests to most internal URLs seemingly fail, which is not observable to the outside user. However, firing a web hook to http://localhost:3000/api/v1/gems appears to succeed, which indicates that SSRF attacks to internal hosts are possible.\n\n#### Exploit Scenario\n\nAn attacker discovers an SSRF vulnerability in the web hook functionality. If they can combine this with a CRLF [injection](https://owasp.org/www-community/vulnerabilities/CRLF_Injection) in the underlying HTTP library, and a deserialization vulnerability like [TOB-RGM-3,](#page-24-0) then they may be able to inject arbitrary data into the cache store and later achieve remote code execution. This attack chain is well-documented in A New Era of SSRF, included in the References section below.\n\nSimilarly, an attacker may be able to make POST requests to arbitrary hosts on the internal network. This is often not an exploit in and of itself, but SSRF vulnerabilities can commonly be combined with other issues to achieve higher impact.\n\n#### Recommendations\n\nShort term, proxy web hook HTTP requests through an application like [Smokescreen](https://github.com/stripe/smokescreen). This will prevent requests from reaching internal address space.\n\nLong term, write automated tests to ensure that all web hook requests are proxied and cannot reach internal address space.\n\n#### References\n\n- A New Era of SSRF Exploiting URL Parser in Trending [Programming](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf) Languages!\n- OWASP [Server-Side Request](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html) Forgery Prevention Cheat Sheet\n", "severity": "Medium", "difficulty": "Low", "type": "Data Validation", "finding_id": "TOB-RGM-8", "target": {"path": "rubygems.org/app/models/web_hook.rb, rubygems.org/app/jobs/notify_web_hook_job.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/stripe/smokescreen", "org": "stripe", "name": "smokescreen", "commit": null, "branch": null, "relative_file": "rubygems.org/app/models/web_hook.rb, rubygems.org/app/jobs/notify_web_hook_job.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "Low", "Type": "Data Validation", "Finding ID": "TOB-RGM-8", "Target": "rubygems.org/app/models/web_hook.rb, rubygems.org/app/jobs/notify_web_hook_job.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-009", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 9, "page_start": 34, "title": "Service stores spec Marshal data alongside gem file", "short_summary": null, "description_md": "#### Description\n\nIn Ruby, Marshal data presents a security risk because it can result in deserialization bugs, which can lead to remote code execution. The Marshal module includes the [following](https://ruby-doc.org/3.3.4/Marshal.html#module-Marshal-label-Security+considerations) [warning](https://ruby-doc.org/3.3.4/Marshal.html#module-Marshal-label-Security+considerations):\n\nBy design, Marshal.load can deserialize almost any class loaded into the Ruby process. In many cases this can lead to remote code execution if the Marshal data is loaded from an untrusted source.\n\nAs a result, Marshal.load is not suitable as a general purpose serialization format and you should never unmarshal user supplied input or other untrusted data.\n\nIf you need to deserialize untrusted data, use JSON or another serialization format that is only able to load simple, 'primitive' types such as String, Array, Hash, etc. Never allow user input to specify arbitrary types to deserialize into.\n\nWhen users upload new gems to the RubyGems service, the application stores the gem itself and a Marshaled representation of the spec data in S3:\n\n```\ndef write_gem(body, spec_contents)\n  gem_path = \"gems/#{@version.gem_file_name}\"\n  gem_contents = body.string\n  ...\n  spec_path = \"quick/Marshal.4.8/#{@version.full_name}.gemspec.rz\"\n  ...\n  RubygemFs.instance.store(gem_path, gem_contents, checksum_sha256: version.sha256)\n  RubygemFs.instance.store(spec_path, spec_contents, checksum_sha256: version.spec_sha256)\n  Fastly.purge(path: gem_path)\n  Fastly.purge(path: spec_path)\nend\n```\n\n*Figure 9.1: Marshaled spec data ([rubygems.org/app/models/pusher.rb#246–258](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/models/pusher.rb#L246-L258))*\n\n\nThe RubyGems application never uses this Marshaled spec data in an automated way. However, it is used when executing one-off Rake tasks such as gemcutter:metadata:backfill or gemcutter:required\\_ruby\\_version:backfill:\n\n```\ndef get_spec_attribute(version_full_name, attribute_name)\n  key = \"quick/Marshal.4.8/#{version_full_name}.gemspec.rz\"\n  file = RubygemFs.instance.get(key)\n  return nil unless file\n  spec = Marshal.load(Gem::Util.inflate(file))\n  spec.send(attribute_name)\nrescue StandardError => e\n  Rails.logger.info(\"[gemcutter:required_ruby_version:backfill] could not get\nrequired_ruby_version for version: #{version_full_name} \" \\\n                    \"error: #{e.inspect}\")\n  nil\nend\n```\n\n*Figure 9.2: Marshal load of spec data ([rubygems.org/lib/tasks/helpers/gemcutter\\\\_tasks\\\\_helper.rb#31–41](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/lib/tasks/helpers/gemcutter_tasks_helper.rb#L31-L41))*\n\nThe Marshaled spec data is also used in the [rubygems](https://github.com/rubygems/rubygems) repository (i.e., the gem and bundler commands). Although this project is out of scope, and uses a [SafeMarshal](https://github.com/rubygems/rubygems/blob/v3.5.18/bundler/lib/bundler/safe_marshal.rb) implementation, it is still interesting to consider. The Marshaled spec data is used in the [Gem::Source](https://github.com/rubygems/rubygems/blob/v3.5.18/lib/rubygems/source.rb#L146) and [Bundler::Fetcher](https://github.com/rubygems/rubygems/blob/v3.5.18/bundler/lib/bundler/fetcher.rb#L114) functionality. The former is commonly employed to exploit Ruby Marshal [deserialization](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/) bugs. If an attacker can find a bypass in the SafeMarshal implementation, or otherwise convince a program to load that data, then they could achieve code execution. Additionally, if a client that is not using the SafeMarshal implementation—like the RubyGems Rake tasks—accesses that data, then it is not protected.\n\nWhile this Marshal functionality does not currently appear to be exploitable, removing it and its associated functionality would reduce risk within the Ruby community as a whole; this would remove both the ability to accidentally unmarshal potentially malicious data and a common exploitation pattern for Ruby code.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 9. Service stores spec Marshal data alongside gem file\n\n| Severity: Informational                                                                                                                          | Diffi culty: High     |\n|-----------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------|\n| Type: Data Validation                                                                                                                         | Finding ID: TOB-RGM-9 |\n| Target: rubygems.org/app/models/pusher.rb, rubygems.org/lib/tasks/helpers/gemcutter_tasks_helper.rb, rubygems.org/lib/tasks/gemcutter.rake |                             |\n\n#### Description\n\nIn Ruby, Marshal data presents a security risk because it can result in deserialization bugs, which can lead to remote code execution. The Marshal module includes the [following](https://ruby-doc.org/3.3.4/Marshal.html#module-Marshal-label-Security+considerations) [warning](https://ruby-doc.org/3.3.4/Marshal.html#module-Marshal-label-Security+considerations):\n\nBy design, Marshal.load can deserialize almost any class loaded into the Ruby process. In many cases this can lead to remote code execution if the Marshal data is loaded from an untrusted source.\n\nAs a result, Marshal.load is not suitable as a general purpose serialization format and you should never unmarshal user supplied input or other untrusted data.\n\nIf you need to deserialize untrusted data, use JSON or another serialization format that is only able to load simple, 'primitive' types such as String, Array, Hash, etc. Never allow user input to specify arbitrary types to deserialize into.\n\nWhen users upload new gems to the RubyGems service, the application stores the gem itself and a Marshaled representation of the spec data in S3:\n\n```\ndef write_gem(body, spec_contents)\n  gem_path = \"gems/#{@version.gem_file_name}\"\n  gem_contents = body.string\n  ...\n  spec_path = \"quick/Marshal.4.8/#{@version.full_name}.gemspec.rz\"\n  ...\n  RubygemFs.instance.store(gem_path, gem_contents, checksum_sha256: version.sha256)\n  RubygemFs.instance.store(spec_path, spec_contents, checksum_sha256: version.spec_sha256)\n  Fastly.purge(path: gem_path)\n  Fastly.purge(path: spec_path)\nend\n```\n\n*Figure 9.1: Marshaled spec data ([rubygems.org/app/models/pusher.rb#246–258](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/models/pusher.rb#L246-L258))*\n\n\nThe RubyGems application never uses this Marshaled spec data in an automated way. However, it is used when executing one-off Rake tasks such as gemcutter:metadata:backfill or gemcutter:required\\_ruby\\_version:backfill:\n\n```\ndef get_spec_attribute(version_full_name, attribute_name)\n  key = \"quick/Marshal.4.8/#{version_full_name}.gemspec.rz\"\n  file = RubygemFs.instance.get(key)\n  return nil unless file\n  spec = Marshal.load(Gem::Util.inflate(file))\n  spec.send(attribute_name)\nrescue StandardError => e\n  Rails.logger.info(\"[gemcutter:required_ruby_version:backfill] could not get\nrequired_ruby_version for version: #{version_full_name} \" \\\n                    \"error: #{e.inspect}\")\n  nil\nend\n```\n\n*Figure 9.2: Marshal load of spec data ([rubygems.org/lib/tasks/helpers/gemcutter\\\\_tasks\\\\_helper.rb#31–41](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/lib/tasks/helpers/gemcutter_tasks_helper.rb#L31-L41))*\n\nThe Marshaled spec data is also used in the [rubygems](https://github.com/rubygems/rubygems) repository (i.e., the gem and bundler commands). Although this project is out of scope, and uses a [SafeMarshal](https://github.com/rubygems/rubygems/blob/v3.5.18/bundler/lib/bundler/safe_marshal.rb) implementation, it is still interesting to consider. The Marshaled spec data is used in the [Gem::Source](https://github.com/rubygems/rubygems/blob/v3.5.18/lib/rubygems/source.rb#L146) and [Bundler::Fetcher](https://github.com/rubygems/rubygems/blob/v3.5.18/bundler/lib/bundler/fetcher.rb#L114) functionality. The former is commonly employed to exploit Ruby Marshal [deserialization](https://github.blog/security/vulnerability-research/execute-commands-by-sending-json-learn-how-unsafe-deserialization-vulnerabilities-work-in-ruby-projects/) bugs. If an attacker can find a bypass in the SafeMarshal implementation, or otherwise convince a program to load that data, then they could achieve code execution. Additionally, if a client that is not using the SafeMarshal implementation—like the RubyGems Rake tasks—accesses that data, then it is not protected.\n\nWhile this Marshal functionality does not currently appear to be exploitable, removing it and its associated functionality would reduce risk within the Ruby community as a whole; this would remove both the ability to accidentally unmarshal potentially malicious data and a common exploitation pattern for Ruby code.\n\n#### Exploit Scenario\n\nAn attacker gains access to the S3 bucket storing Marshaled spec data. This could occur via access control misconfiguration, SSRF, data validation issues during the gem upload process, or some other attack vector. The attacker then uploads or modifies Marshaled data such that when it is loaded, it exploits a deserialization bug.\n\n#### Recommendations\n\nShort term, ensure that any clients accessing these Marshaled .rz files under the rubygems GitHub organization are using the SafeMarshal implementation.\n\nLong term, consider removing functionality associated with these .rz files, or moving to a safer serialization format such as JSON. Alternatively, if the RubyGems service needs to\n\n\n\nprovide this information externally, then consider storing this metadata in the production database instead of serialized data files in S3.\n", "severity": "Informational", "difficulty": "High", "type": "Data Validation", "finding_id": "TOB-RGM-9", "target": {"path": "rubygems.org/app/models/pusher.rb, rubygems.org/lib/tasks/helpers/gemcutter_tasks_helper.rb, rubygems.org/lib/tasks/gemcutter.rake", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/stripe/smokescreen", "org": "stripe", "name": "smokescreen", "commit": null, "branch": null, "relative_file": "rubygems.org/app/models/pusher.rb, rubygems.org/lib/tasks/helpers/gemcutter_tasks_helper.rb, rubygems.org/lib/tasks/gemcutter.rake", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Data Validation", "Finding ID": "TOB-RGM-9", "Target": "rubygems.org/app/models/pusher.rb, rubygems.org/lib/tasks/helpers/gemcutter_tasks_helper.rb, rubygems.org/lib/tasks/gemcutter.rake"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-010", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 10, "page_start": 37, "title": "Unhandled exception in trusted publisher exchange token request", "short_summary": null, "description_md": "#### Description\n\nCalling the exchange\\_token action from the\n\nApi::V1::OIDC::TrustedPublisherController controller without any parameters results in a 500 error due to an unhandled exception (figure 10.1). This occurs because the ActionController::ParameterMissing error handler code from ApplicationController (figure 11.2) calls a wrong render\\_bad\\_request function. The handler code is executed in the context of the deriving controller, which overrides the render\\_bad\\_request function (figure 10.3). The overridden function has no arguments, but the error handler calls render\\_bad\\_request with an argument, which causes an ArgumentError to be thrown and an internal server error.\n\n```\ncurl -XPOST https://rubygems.org/api/v1/oidc/trusted_publisher/exchange_token.json\n{\"status\":500,\"error\":\"Internal Server Error\"}\n```\n\n*Figure 10.1: A controller crash triggered by a request without parameters*\n\n```\nrescue_from(ActionController::ParameterMissing) do |e|\n  render_bad_request \"Request is missing param '#{e.param}'\"\nend\n```\n\n*Figure 10.2: Error handler calls render\\_bad\\_request with an argument ([rubygems.org/app/controllers/application\\\\_controller.rb#L54–L56](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/application_controller.rb#L54-L56))*\n\n```\ndef render_bad_request\n  render json: { error: \"Bad Request\" }, status: :bad_request\nend\n```\n\n*Figure 10.3: Overridden render\\_bad\\_request expects no arguments ([rubygems.org/app/controllers/api/v1/oidc/trusted\\\\_publisher\\\\_controller.rb](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L69-L71) [#L69–L71](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L69-L71))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 10. Unhandled exception in trusted publisher exchange token request\n\n| Severity: Informational                                             | Diffi culty: Low       |\n|------------------------------------------------------------------------|------------------------------|\n| Type: Error Reporting                                            | Finding ID: TOB-RGM-10 |\n| app/controllers/api/v1/oidc/trusted_publisher_controller.rb Target: |                              |\n\n#### Description\n\nCalling the exchange\\_token action from the\n\nApi::V1::OIDC::TrustedPublisherController controller without any parameters results in a 500 error due to an unhandled exception (figure 10.1). This occurs because the ActionController::ParameterMissing error handler code from ApplicationController (figure 11.2) calls a wrong render\\_bad\\_request function. The handler code is executed in the context of the deriving controller, which overrides the render\\_bad\\_request function (figure 10.3). The overridden function has no arguments, but the error handler calls render\\_bad\\_request with an argument, which causes an ArgumentError to be thrown and an internal server error.\n\n```\ncurl -XPOST https://rubygems.org/api/v1/oidc/trusted_publisher/exchange_token.json\n{\"status\":500,\"error\":\"Internal Server Error\"}\n```\n\n*Figure 10.1: A controller crash triggered by a request without parameters*\n\n```\nrescue_from(ActionController::ParameterMissing) do |e|\n  render_bad_request \"Request is missing param '#{e.param}'\"\nend\n```\n\n*Figure 10.2: Error handler calls render\\_bad\\_request with an argument ([rubygems.org/app/controllers/application\\\\_controller.rb#L54–L56](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/application_controller.rb#L54-L56))*\n\n```\ndef render_bad_request\n  render json: { error: \"Bad Request\" }, status: :bad_request\nend\n```\n\n*Figure 10.3: Overridden render\\_bad\\_request expects no arguments ([rubygems.org/app/controllers/api/v1/oidc/trusted\\\\_publisher\\\\_controller.rb](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L69-L71) [#L69–L71](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L69-L71))*\n\n## Recommendations\n\nShort term, remove the render\\_bad\\_request override from the Api::V1::OIDC::TrustedPublisherController controller. There is already [an](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/base_controller.rb#L93-L96) equivalent [render\\\\_bad\\\\_request](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/base_controller.rb#L93-L96) in Api::BaseController that will be used by the exception handler.\n\n\n\nLong term, add test cases to cover all error paths in controllers.\n", "severity": "Informational", "difficulty": "Low", "type": "Error Reporting", "finding_id": "TOB-RGM-10", "target": {"path": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/stripe/smokescreen", "org": "stripe", "name": "smokescreen", "commit": null, "branch": null, "relative_file": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "Low", "Type": "Error Reporting", "Finding ID": "TOB-RGM-10", "Target": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-011", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 11, "page_start": 39, "title": "Insufficient JWT validation in trusted publisher exchange token request", "short_summary": null, "description_md": "#### Description\n\nThe JWT claims received from trusted publishers are insufficiently validated and result in triggerable unhandled exceptions. For instance, a missing nbf claim results in a NoMethodError: undefined method `+' for nil exception and nbf containing a string instead of an integer ArgumentError: bad value for range exception.\n\n```\ndef verify_signature\n  raise UnsupportedIssuer, \"Provider is missing jwks\" if @provider.jwks.blank?\n  raise UnverifiedJWT, \"Invalid time\" unless\n(@jwt[\"nbf\"]..@jwt[\"exp\"]).cover?(Time.now.to_i)\n  @jwt.verify!(@provider.jwks)\nend\n```\n\n*Figure 11.1: JWT claims used without any validation ([rubygems.org/app/controllers/api/v1/oidc/trusted\\\\_publisher\\\\_controller.rb](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56) [#L52–L56](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 11. Insufficient JWT validation in trusted publisher exchange token request\n\n| Severity: Informational                                             | Diffi culty: Low       |\n|------------------------------------------------------------------------|------------------------------|\n| Type: Data Validation                                            | Finding ID: TOB-RGM-11 |\n| app/controllers/api/v1/oidc/trusted_publisher_controller.rb Target: |                              |\n\n#### Description\n\nThe JWT claims received from trusted publishers are insufficiently validated and result in triggerable unhandled exceptions. For instance, a missing nbf claim results in a NoMethodError: undefined method `+' for nil exception and nbf containing a string instead of an integer ArgumentError: bad value for range exception.\n\n```\ndef verify_signature\n  raise UnsupportedIssuer, \"Provider is missing jwks\" if @provider.jwks.blank?\n  raise UnverifiedJWT, \"Invalid time\" unless\n(@jwt[\"nbf\"]..@jwt[\"exp\"]).cover?(Time.now.to_i)\n  @jwt.verify!(@provider.jwks)\nend\n```\n\n*Figure 11.1: JWT claims used without any validation ([rubygems.org/app/controllers/api/v1/oidc/trusted\\\\_publisher\\\\_controller.rb](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56) [#L52–L56](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56))*\n\n## Recommendations\n\nShort term, validate all the JWT claims in the controller and add tests exercising missing and incorrect claim values.\n\nLong term, always validate all untrusted data as soon as it arrives into the system.\n", "severity": "Informational", "difficulty": "Low", "type": "Data Validation", "finding_id": "TOB-RGM-11", "target": {"path": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems", "org": "rubygems", "name": "rubygems", "commit": null, "branch": null, "relative_file": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "Low", "Type": "Data Validation", "Finding ID": "TOB-RGM-11", "Target": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-012", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 12, "page_start": 40, "title": "SSRF risk while refreshing OIDC providers", "short_summary": null, "description_md": "#### Description\n\nThe RefreshOIDCProviderJob uses the provider-controlled provider.configuration.jwks\\_uri to perform a GET request (figure 12.1). As a result, an attacker can perform SSRF attacks against internal hosts. The attack vector is limited since it relies on a compromised trusted provider.\n\n```\ndef perform(provider:)\n  connection = Faraday.new(provider.issuer, request: { timeout: 2 }, headers: {\n\"Accept\" => \"application/json\" }) do |f|\n    f.request :json\n    f.response :logger, logger, headers: false, errors: true, bodies: true\n    f.response :raise_error\n    f.response :json, content_type: //\n  end\n  resp = connection.get(\"/.well-known/openid-configuration\")\n  provider.configuration = resp.body\n  provider.configuration.validate!\n  provider.jwks = connection.get(provider.configuration.jwks_uri).body\n  provider.save!\nend\n```\n\n*Figure 12.1: Calling a URL provided by a third party ([rubygems.org/app/jobs/refresh\\\\_oidc\\\\_provider\\\\_job.rb#L7–L21](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/jobs/refresh_oidc_provider_job.rb#L7-L21))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 12. SSRF risk while refreshing OIDC providers\n\n| Severity: Informational                       | Diffi culty: High      |\n|--------------------------------------------------|------------------------------|\n| Type: Data Validation                      | Finding ID: TOB-RGM-12 |\n| Target: app/jobs/refresh_oidc_provider_job.rb |                              |\n\n#### Description\n\nThe RefreshOIDCProviderJob uses the provider-controlled provider.configuration.jwks\\_uri to perform a GET request (figure 12.1). As a result, an attacker can perform SSRF attacks against internal hosts. The attack vector is limited since it relies on a compromised trusted provider.\n\n```\ndef perform(provider:)\n  connection = Faraday.new(provider.issuer, request: { timeout: 2 }, headers: {\n\"Accept\" => \"application/json\" }) do |f|\n    f.request :json\n    f.response :logger, logger, headers: false, errors: true, bodies: true\n    f.response :raise_error\n    f.response :json, content_type: //\n  end\n  resp = connection.get(\"/.well-known/openid-configuration\")\n  provider.configuration = resp.body\n  provider.configuration.validate!\n  provider.jwks = connection.get(provider.configuration.jwks_uri).body\n  provider.save!\nend\n```\n\n*Figure 12.1: Calling a URL provided by a third party ([rubygems.org/app/jobs/refresh\\\\_oidc\\\\_provider\\\\_job.rb#L7–L21](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/jobs/refresh_oidc_provider_job.rb#L7-L21))*\n\n#### Exploit Scenario\n\nAn attacker takes control of the provider's /.well-known/openid-configuration endpoint and sets jwks\\_uri to perform GET requests on the internal network. While this is typically not an exploit on its own, SSRF vulnerabilities can commonly be combined with other issues to achieve higher impact.\n\n#### Recommendations\n\nShort term, proxy web hook HTTP requests through an application like [Smokescreen](https://github.com/stripe/smokescreen). This will prevent requests from reaching internal address space.\n\n\nLong term, write automated tests to ensure that all web hook requests are proxied and cannot reach internal address space.\n", "severity": "Informational", "difficulty": "High", "type": "Data Validation", "finding_id": "TOB-RGM-12", "target": {"path": "app/jobs/refresh_oidc_provider_job.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems", "org": "rubygems", "name": "rubygems", "commit": null, "branch": null, "relative_file": "app/jobs/refresh_oidc_provider_job.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Data Validation", "Finding ID": "TOB-RGM-12", "Target": "app/jobs/refresh_oidc_provider_job.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-013", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 13, "page_start": 42, "title": "The jti claim uniqueness is not enforced by database", "short_summary": null, "description_md": "#### Description\n\nThe jti claim from OIDC ID token is validated for uniqueness (figure 13.1), but this constraint is not enforced by the database (figure 13.2), which makes the application vulnerable to race conditions.\n\n```\ndef jti_uniqueness\n  relation = self.class.where(\"(jwt->>'claims')::jsonb->>'jti' = ?\", jti)\n  relation = relation.provider_id(api_key_role.oidc_provider_id) if api_key_role\n  return unless relation.where.not(id: self).exists?\n  errors.add(\"jwt.claims.jti\", \"must be unique\")\nend\n```\n\n*Figure 13.1: The jti claim uniqueness validation in application code ([rubygems.org/app/jobs/refresh\\\\_oidc\\\\_provider\\\\_job.rb#L7–L21](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/jobs/refresh_oidc_provider_job.rb#L7-L21))*\n\n```\ncreate_table \"oidc_id_tokens\", force: :cascade do |t|\n  t.bigint \"oidc_api_key_role_id\", null: false\n  t.jsonb \"jwt\", null: false\n  t.bigint \"api_key_id\"\n  t.datetime \"created_at\", null: false\n  t.datetime \"updated_at\", null: false\n  t.index [\"api_key_id\"], name: \"index_oidc_id_tokens_on_api_key_id\"\n  t.index [\"oidc_api_key_role_id\"], name:\n\"index_oidc_id_tokens_on_oidc_api_key_role_id\"\nend\n```\n\n*Figure 13.2: Missing constraint ensuring that the jti value is unique ([rubygems.org/db/schema.rb#L360–L368](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/db/schema.rb#L360-L368))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 13. The jti claim uniqueness is not enforced by database\n\n| Severity: Informational             | Diffi culty: Medium    |\n|----------------------------------------|------------------------------|\n| Type: Data Validation            | Finding ID: TOB-RGM-13 |\n| Target: app/models/oidc/id_token.rb |                              |\n\n#### Description\n\nThe jti claim from OIDC ID token is validated for uniqueness (figure 13.1), but this constraint is not enforced by the database (figure 13.2), which makes the application vulnerable to race conditions.\n\n```\ndef jti_uniqueness\n  relation = self.class.where(\"(jwt->>'claims')::jsonb->>'jti' = ?\", jti)\n  relation = relation.provider_id(api_key_role.oidc_provider_id) if api_key_role\n  return unless relation.where.not(id: self).exists?\n  errors.add(\"jwt.claims.jti\", \"must be unique\")\nend\n```\n\n*Figure 13.1: The jti claim uniqueness validation in application code ([rubygems.org/app/jobs/refresh\\\\_oidc\\\\_provider\\\\_job.rb#L7–L21](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/jobs/refresh_oidc_provider_job.rb#L7-L21))*\n\n```\ncreate_table \"oidc_id_tokens\", force: :cascade do |t|\n  t.bigint \"oidc_api_key_role_id\", null: false\n  t.jsonb \"jwt\", null: false\n  t.bigint \"api_key_id\"\n  t.datetime \"created_at\", null: false\n  t.datetime \"updated_at\", null: false\n  t.index [\"api_key_id\"], name: \"index_oidc_id_tokens_on_api_key_id\"\n  t.index [\"oidc_api_key_role_id\"], name:\n\"index_oidc_id_tokens_on_oidc_api_key_role_id\"\nend\n```\n\n*Figure 13.2: Missing constraint ensuring that the jti value is unique ([rubygems.org/db/schema.rb#L360–L368](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/db/schema.rb#L360-L368))*\n\n#### Recommendations\n\nShort term, add a check constraint to the oidc\\_id\\_tokens table to ensure that the jti value is unique even in face of a race condition in the application code.\n\nLong term, always add uniqueness constraints or indexes to the database to ensure data consistency.\n", "severity": "Informational", "difficulty": "Medium", "type": "Data Validation", "finding_id": "TOB-RGM-13", "target": {"path": "app/models/oidc/id_token.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems.org", "org": "rubygems", "name": "rubygems.org", "commit": "21895a522076d15a3cb8d072229e2cfdbdb873e8", "branch": null, "relative_file": "app/models/oidc/id_token.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "Medium", "Type": "Data Validation", "Finding ID": "TOB-RGM-13", "Target": "app/models/oidc/id_token.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-014", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 14, "page_start": 43, "title": "Provider key age not checked", "short_summary": null, "description_md": "#### Description\n\nThe OIDC provider keys are periodically refreshed in a scheduled job. The application code does not check the key age before verifying the signature (figures 14.1, 14.2). If the scheduled refresh job fails for an extended period of time, the JWT signature verification could operate on an outdated, possibly compromised key.\n\n```\ndef verify_signature\n  raise UnsupportedIssuer, \"Provider is missing jwks\" if @provider.jwks.blank?\n  raise UnverifiedJWT, \"Invalid time\" unless\n(@jwt[\"nbf\"]..@jwt[\"exp\"]).cover?(Time.now.to_i)\n  @jwt.verify!(@provider.jwks)\nend\n```\n\n*Figure 14.1: Signature verification without checking the key age ([rubygems.org/app/controllers/api/v1/oidc/trusted\\\\_publisher\\\\_controller.rb](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56) [#L52–L56](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56))*\n\n```\ndef decode_jwt\n  raise UnverifiedJWT, \"Provider missing JWKS\" if @api_key_role.provider.jwks.blank?\n  @jwt = JSON::JWT.decode_compact_serialized(params.permit(:jwt).require(:jwt),\n@api_key_role.provider.jwks)\nrescue JSON::ParserError\n  raise UnverifiedJWT, \"Invalid JSON\"\nend\n```\n\n*Figure 14.2: Signature verification without checking the key age ([rubygems.org/app/controllers/api/v1/oidc/api\\\\_key\\\\_roles\\\\_controller.rb#L72](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/api_key_roles_controller.rb#L72-L77) [–L77](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/api_key_roles_controller.rb#L72-L77))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 14. Provider key age not checked\n\n| Severity: Informational | Diffi culty: High      |\n|----------------------------|------------------------------|\n| Type: Cryptography      | Finding ID: TOB-RGM-14 |\n|                            |                              |\n\nTarget: app/controllers/api/v1/oidc/trusted\\_publisher\\_controller.rb, app/controllers/api/v1/oidc/api\\_key\\_roles\\_controller.rb\n\n#### Description\n\nThe OIDC provider keys are periodically refreshed in a scheduled job. The application code does not check the key age before verifying the signature (figures 14.1, 14.2). If the scheduled refresh job fails for an extended period of time, the JWT signature verification could operate on an outdated, possibly compromised key.\n\n```\ndef verify_signature\n  raise UnsupportedIssuer, \"Provider is missing jwks\" if @provider.jwks.blank?\n  raise UnverifiedJWT, \"Invalid time\" unless\n(@jwt[\"nbf\"]..@jwt[\"exp\"]).cover?(Time.now.to_i)\n  @jwt.verify!(@provider.jwks)\nend\n```\n\n*Figure 14.1: Signature verification without checking the key age ([rubygems.org/app/controllers/api/v1/oidc/trusted\\\\_publisher\\\\_controller.rb](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56) [#L52–L56](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/trusted_publisher_controller.rb#L52-L56))*\n\n```\ndef decode_jwt\n  raise UnverifiedJWT, \"Provider missing JWKS\" if @api_key_role.provider.jwks.blank?\n  @jwt = JSON::JWT.decode_compact_serialized(params.permit(:jwt).require(:jwt),\n@api_key_role.provider.jwks)\nrescue JSON::ParserError\n  raise UnverifiedJWT, \"Invalid JSON\"\nend\n```\n\n*Figure 14.2: Signature verification without checking the key age ([rubygems.org/app/controllers/api/v1/oidc/api\\\\_key\\\\_roles\\\\_controller.rb#L72](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/api_key_roles_controller.rb#L72-L77) [–L77](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/oidc/api_key_roles_controller.rb#L72-L77))*\n\n#### Recommendations\n\nShort term, add a sanity check for the key age before verifying the JWT signature.\n", "severity": "Informational", "difficulty": "High", "type": "Cryptography", "finding_id": "TOB-RGM-14", "target": {"path": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems.org", "org": "rubygems", "name": "rubygems.org", "commit": "21895a522076d15a3cb8d072229e2cfdbdb873e8", "branch": null, "relative_file": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Cryptography", "Finding ID": "TOB-RGM-14", "Target": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-015", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 15, "page_start": 44, "title": "Overly verbose error returned to the user", "short_summary": null, "description_md": "#### Description\n\nThe Pusher::pull\\_spec method contains a rescue clause that catches StandardError, which is almost equivalent to catching all exceptions. The exception message is included in the HTTP response. It is in principle unsafe to share arbitrary exception messages with users, as the message might contain sensitive information.\n\n```\nrescue StandardError => e\n  notify <<~MSG, 422\n    RubyGems.org cannot process this gem.\n    Please try rebuilding it and installing it locally to make sure it's valid.\n    Error:\n    #{e.message}\n  MSG\n```\n\n*Figure 15.1: The exception message is included in error message presented to users ([rubygems.org/app/models/pusher.rb#L87–L93](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/models/pusher.rb#L87-L93))*\n\n```\ngemcutter = Pusher.new(@api_key, request.body, request:)\ngemcutter.process\nrender plain: response_with_mfa_warning(gemcutter.message), status: gemcutter.code\n```\n\n*Figure 15.2: The message from figure 15.1 is rendered in the response ([rubygems.org/app/controllers/api/v1/rubygems\\\\_controller.rb#L37–L39](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/rubygems_controller.rb#L37-L39))*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 15. Overly verbose error returned to the user\n\n| Severity: Informational                                                                                                         | Diffi culty: High      |\n|------------------------------------------------------------------------------------------------------------------------------------|------------------------------|\n| Type: Data Exposure                                                                                                          | Finding ID: TOB-RGM-15 |\n| Target: app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb |                              |\n\n#### Description\n\nThe Pusher::pull\\_spec method contains a rescue clause that catches StandardError, which is almost equivalent to catching all exceptions. The exception message is included in the HTTP response. It is in principle unsafe to share arbitrary exception messages with users, as the message might contain sensitive information.\n\n```\nrescue StandardError => e\n  notify <<~MSG, 422\n    RubyGems.org cannot process this gem.\n    Please try rebuilding it and installing it locally to make sure it's valid.\n    Error:\n    #{e.message}\n  MSG\n```\n\n*Figure 15.1: The exception message is included in error message presented to users ([rubygems.org/app/models/pusher.rb#L87–L93](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/models/pusher.rb#L87-L93))*\n\n```\ngemcutter = Pusher.new(@api_key, request.body, request:)\ngemcutter.process\nrender plain: response_with_mfa_warning(gemcutter.message), status: gemcutter.code\n```\n\n*Figure 15.2: The message from figure 15.1 is rendered in the response ([rubygems.org/app/controllers/api/v1/rubygems\\\\_controller.rb#L37–L39](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/app/controllers/api/v1/rubygems_controller.rb#L37-L39))*\n\n#### Recommendations\n\nShort term, remove the exception message from the StandardError handling in Pusher::pull\\_spec. Alternatively, add more granular exception handling with specialized error messages.\n\nLong term, avoid showing arbitrary error messages to untrusted parties, as they could contain sensitive information.\n", "severity": "Informational", "difficulty": "High", "type": "Data Exposure", "finding_id": "TOB-RGM-15", "target": {"path": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/prowler-cloud/prowler", "org": "prowler-cloud", "name": "prowler", "commit": null, "branch": null, "relative_file": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Data Exposure", "Finding ID": "TOB-RGM-15", "Target": "app/controllers/api/v1/oidc/trusted_publisher_controller.rb, app/controllers/api/v1/oidc/api_key_roles_controller.rb"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-016", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 16, "page_start": 45, "title": "Redundant IAM users and permissions", "short_summary": null, "description_md": "#### Description\n\nThe system contains a few IAM resources that appear not to be used and should be removed. Additionally, a few resources that could be more restricted; while not easily exploitable, these resources do not follow the principle of least privilege.\n\nThe below IAM users appear not to be used:\n\n- chef: this account has some write privileges to EC2 and Route53, does not have any access credentials, has MFA disabled, and has never been used (according to Access Advisor).\n- nick: this account has administrative access, has only one inactive access key configured, has MFA disabled, and has never been used (according to Access Advisor).\n\nThe following IAM users were used long time ago and may be no longer needed:\n\n- evan: this account has administrative access, does not have any access credentials, MFA is disabled, was used 2 years ago last time\n- dwradcliffe: this account has administrative access and was used 2 years ago last time\n- hsbt: this account has privileges for ECS and production S3 buckets, was used 1 year ago for S3 access and never used other privileges\n- marty: this administrative account is actively used, but with an old and unused access key.\n- mux: this account with read-write S3 privileges, MFA is disabled\n  - The account has redundant S3:CreateJob permission for all resources\n  - Other write permissions are insecurely restricted to arn:aws:s3:::\\*videos\\* resources: this gives access to, for example, production gems with \"videos\" in their name\n\nThe following roles appear to have been created for OpsWorks [service that](https://docs.aws.amazon.com/opsworks/latest/userguide/welcome.html) reached end of [life:](https://docs.aws.amazon.com/opsworks/latest/userguide/welcome.html)\n\n\n\n- aws-opsworks-ec2-role\n- aws-opsworks-service-role\n\nPlease note that the chef IAM user could be created for this service as well.\n\nMultiple customer-managed policies do not have any entities attached:\n\n- KarpenterController-2024021715281315410000000b\n- es-staging-app\n- rubyapi-secrets-manager-read-write\n- RubyAPITerraformCloud (not used after fix for [TOB-RGM-20\\)](#page-52-0)\n- aws-load-balancer-controller (may be important for Helm configuration)\n\nAdditionally, we noted the following issues:\n\n- The everything-backup policy (inlined in the dwradcliffe user) grants all privileges on all resources, instead of read-only privileges.\n- The Setup user group has no users assigned, so it can probably be removed.\n- The shipit IAM user is included in the K8s system:masters group, but the IAM user does not exist.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "| 16. Redundant IAM users and permissions |                              |  |\n|--------------------------------------------------------|------------------------------|--|\n| Severity: Medium                                    | Diffi culty: High      |  |\n| Type: Authentication                                | Finding ID: TOB-RGM-16 |  |\n| Target: AWS IAM                                  |                              |  |\n\n#### Description\n\nThe system contains a few IAM resources that appear not to be used and should be removed. Additionally, a few resources that could be more restricted; while not easily exploitable, these resources do not follow the principle of least privilege.\n\nThe below IAM users appear not to be used:\n\n- chef: this account has some write privileges to EC2 and Route53, does not have any access credentials, has MFA disabled, and has never been used (according to Access Advisor).\n- nick: this account has administrative access, has only one inactive access key configured, has MFA disabled, and has never been used (according to Access Advisor).\n\nThe following IAM users were used long time ago and may be no longer needed:\n\n- evan: this account has administrative access, does not have any access credentials, MFA is disabled, was used 2 years ago last time\n- dwradcliffe: this account has administrative access and was used 2 years ago last time\n- hsbt: this account has privileges for ECS and production S3 buckets, was used 1 year ago for S3 access and never used other privileges\n- marty: this administrative account is actively used, but with an old and unused access key.\n- mux: this account with read-write S3 privileges, MFA is disabled\n  - The account has redundant S3:CreateJob permission for all resources\n  - Other write permissions are insecurely restricted to arn:aws:s3:::\\*videos\\* resources: this gives access to, for example, production gems with \"videos\" in their name\n\nThe following roles appear to have been created for OpsWorks [service that](https://docs.aws.amazon.com/opsworks/latest/userguide/welcome.html) reached end of [life:](https://docs.aws.amazon.com/opsworks/latest/userguide/welcome.html)\n\n\n\n- aws-opsworks-ec2-role\n- aws-opsworks-service-role\n\nPlease note that the chef IAM user could be created for this service as well.\n\nMultiple customer-managed policies do not have any entities attached:\n\n- KarpenterController-2024021715281315410000000b\n- es-staging-app\n- rubyapi-secrets-manager-read-write\n- RubyAPITerraformCloud (not used after fix for [TOB-RGM-20\\)](#page-52-0)\n- aws-load-balancer-controller (may be important for Helm configuration)\n\nAdditionally, we noted the following issues:\n\n- The everything-backup policy (inlined in the dwradcliffe user) grants all privileges on all resources, instead of read-only privileges.\n- The Setup user group has no users assigned, so it can probably be removed.\n- The shipit IAM user is included in the K8s system:masters group, but the IAM user does not exist.\n\n#### Exploit Scenario 1\n\nThe evan user reuses his AWS password for another popular service. The other service suffers from data breach, and passwords are leaked. Mallory finds evan's password in the data dump; because MFA is disabled, Mallory successfully logs in as evan with only his password. Mallory has admin access to all rubygems production resources and silently installs backdoors in popular gems.\n\n#### Exploit Scenario 2\n\nThe Mux user becomes malicious and backdoors all 23 gems with \"videos\" in their name.\n\n#### Recommendations\n\nShort term, review the IAM resources pointed out in this finding, remove redundant resources, and restrict privileges of other resources according to the principle of least privilege. The precise actions required to do this depend on the business context that is unknown to Trail of Bits; nevertheless, consider the following actions:\n\n- For IAM users:\n  - Remove the check and nick IAM users.\n  - Enable MFA for the evan and Mux users.\n  - Remove dwradcliffe's everything-backup policy.\n  - Limit hsbt's privileges to S3 buckets.\n\n\n\n- Remove the marty user's access key.\n- Remove Mux's S3:CreateJob permission.\n- Restrict Mux's write permissions to specific S3 buckets and objects (instead of the broad \\*videos\\* pattern).\n- Remove OpsWorks-related roles. Remove unused policies. Remove the Setup user group.\n- Ensure that the root account has MFA enabled.\n- Adjust EKS' kubernetes\\_config\\_map (in eks.tf file) and kubernetes\\_role\\_binding resources (k8s-rbac.tf file) to match current IAM resources. Add a step to the development and PR review processes that would require review of K8s configurations whenever IAM resources are changed (and vice versa).\n- Long term, periodically review IAM resources and remove redundant ones.\n- Move away from manual management of IAM resources. Migrate the management to Terraform. Once the migration is complete, limit users and roles with write access to production resources; ideally, only CI/CD pipeline and a break-glass user should have access.\n- When creating or updating IAM resources, ask for peer review of the new configurations. This review should be made a required step in GitHub, and should check if the new permissions are minimal.\n- Whenever possible, migrate inlined and attached policies to groups and roles. This will reduce the possibility of granting over-privileged accesses.\n- Add AWS Config rules that would automate maintenance: remove inactive IAM resources and disallow insecure configurations. Review [asecurecloud's](https://asecure.cloud/l/p_conformance_packs/) conformance [packs](https://asecure.cloud/l/p_conformance_packs/) for additional rules.\n", "severity": "Medium", "difficulty": "High", "type": "Authentication", "finding_id": "TOB-RGM-16", "target": {"path": "AWS IAM", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/prowler-cloud/prowler", "org": "prowler-cloud", "name": "prowler", "commit": null, "branch": null, "relative_file": "AWS IAM", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "High", "Type": "Authentication", "Finding ID": "TOB-RGM-16", "Target": "AWS IAM"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-017", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 17, "page_start": 48, "title": "MFA is not enforced for IAM user", "short_summary": null, "description_md": "#### Description\n\nMFA is not enforced on the account or organization level. IAM users are allowed to perform actions in AWS without MFA enabled.\n\nWhile all active users currently have MFA configured, a global enforcement of MFA is strongly recommended.\n\nPlease note that the Force\\_MFA policy exists, but it does not serve the purpose of global enforcement: it is attached only to the SRE user group. Moreover, it contains a bug: the s3:ListBuckets permission is incorrect (should be s3:ListBucket).\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 17. MFA is not enforced for IAM user\n\n| Severity: Medium                                                   | Diffi culty: High      |\n|-----------------------------------------------------------------------|------------------------------|\n| Type: Authentication                                               | Finding ID: TOB-RGM-17 |\n| Target: AWS IAM, AWS Config, AWS Identity Center |                              |\n\n#### Description\n\nMFA is not enforced on the account or organization level. IAM users are allowed to perform actions in AWS without MFA enabled.\n\nWhile all active users currently have MFA configured, a global enforcement of MFA is strongly recommended.\n\nPlease note that the Force\\_MFA policy exists, but it does not serve the purpose of global enforcement: it is attached only to the SRE user group. Moreover, it contains a bug: the s3:ListBuckets permission is incorrect (should be s3:ListBucket).\n\n#### Exploit Scenario\n\nA new user is added to the AWS IAM. The user forgets to configure MFA. Some time later, Mallory compromises the user's password via phishing. Mallory logs in to AWS.\n\n#### Recommendations\n\nShort term, create a AWS Config check to [enforce MFA](https://docs.aws.amazon.com/config/latest/developerguide/iam-user-mfa-enabled.html) or enable [IAM Identity](https://docs.aws.amazon.com/singlesignon/latest/userguide/how-to-configure-mfa-device-enforcement.html) Center and [enable enforcement.](https://docs.aws.amazon.com/singlesignon/latest/userguide/how-to-configure-mfa-device-enforcement.html) Ensure that root accounts have strong MFA enabled.\n\nLong term, use only hardware security keys for MFA, as these types of authenticators provide the strongest security. Administrators especially should use this MFA option. Configure at least two keys: one for day-to-day use and one as a backup.\n", "severity": "Medium", "difficulty": "High", "type": "Authentication", "finding_id": "TOB-RGM-17", "target": {"path": "AWS IAM, AWS Config, AWS Identity Center", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/prowler-cloud/prowler", "org": "prowler-cloud", "name": "prowler", "commit": null, "branch": null, "relative_file": "AWS IAM, AWS Config, AWS Identity Center", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "High", "Type": "Authentication", "Finding ID": "TOB-RGM-17", "Target": "AWS IAM, AWS Config, AWS Identity Center"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-018", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 18, "page_start": 49, "title": "Lack of policy conditions leading to cross-service confused deputy attacks", "short_summary": null, "description_md": "#### Description\n\nSome AWS services are granted sts:AssumeRole permission without any policy condition, and are potentially vulnerable to [cross-service confused](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html#cross-service-confused-deputy-prevention) deputy attacks.\n\nIt is not clear if the issues are really exploitable, and if other services with the sts:AssumeRole permission are not vulnerable; AWS [documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn) states that only [some services](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn) support mitigations for this attack vector. For the three services indicated below, we found explicit documentation for mitigating the confused deputy attack.\n\n- [arn:aws:iam::048268392960:role/rds-monitoring-role](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Monitoring.OS.Enabling.html#USER_Monitoring.OS.confused-deputy)\n- [arn:aws:iam::048268392960:role/vpc-flow-log-role-20240501052116925800000002](https://docs.aws.amazon.com/vpc/latest/tgw/flow-logs-cwl.html)\n- [arn:aws:iam::048268392960:role/aws-opsworks-service-role](https://docs.aws.amazon.com/opsworks/latest/userguide/cross-service-confused-deputy-prevention-stacks.html)\n\nOther services are also missing policy conditions, but we found no similar AWS recommendations and therefore assume that no steps are needed. We still recommend mitigating the attack for extra safety, although implementing mitigations in some services may break the system and should be preceded by careful investigation.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 18. Lack of policy conditions leading to cross-service confused deputy attacks\n\n| Severity: Low            | Diffi culty: Medium    |\n|-----------------------------|------------------------------|\n| Type: Access Controls | Finding ID: TOB-RGM-18 |\n| Target: AWS IAM roles |                              |\n\n#### Description\n\nSome AWS services are granted sts:AssumeRole permission without any policy condition, and are potentially vulnerable to [cross-service confused](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html#cross-service-confused-deputy-prevention) deputy attacks.\n\nIt is not clear if the issues are really exploitable, and if other services with the sts:AssumeRole permission are not vulnerable; AWS [documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn) states that only [some services](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn) support mitigations for this attack vector. For the three services indicated below, we found explicit documentation for mitigating the confused deputy attack.\n\n- [arn:aws:iam::048268392960:role/rds-monitoring-role](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_Monitoring.OS.Enabling.html#USER_Monitoring.OS.confused-deputy)\n- [arn:aws:iam::048268392960:role/vpc-flow-log-role-20240501052116925800000002](https://docs.aws.amazon.com/vpc/latest/tgw/flow-logs-cwl.html)\n- [arn:aws:iam::048268392960:role/aws-opsworks-service-role](https://docs.aws.amazon.com/opsworks/latest/userguide/cross-service-confused-deputy-prevention-stacks.html)\n\nOther services are also missing policy conditions, but we found no similar AWS recommendations and therefore assume that no steps are needed. We still recommend mitigating the attack for extra safety, although implementing mitigations in some services may break the system and should be preceded by careful investigation.\n\n#### Exploit Scenario\n\nAn attacker creates a new AWS account and configures a RDS service to write logs to RubyGems' RDS logs.\n\n#### Recommendations\n\nShort term, mitigate the confused deputy attacks by adding relevant aws: conditions to the policies of roles listed in the Description section above.\n\nConsider implementing mitigations for the following lambda roles. (Note that mitigations for lambda service may be not necessary and are not documented by AWS, but [should](https://github.com/prowler-cloud/prowler/issues/2810#issuecomment-1795492940) still [work.](https://github.com/prowler-cloud/prowler/issues/2810#issuecomment-1795492940))\n\n● arn:aws:iam::048268392960:role/lambda\\_s3\\_exec\\_role\n\n\n\n- arn:aws:iam::048268392960:role/lambda-basic-exec-role\n- arn:aws:iam::048268392960:role/SlackNotifier-LambdaFunctionRole-1 2R6ZJ2BX3B1W\n- arn:aws:iam::048268392960:role/SlackNotifier-LambdaFunctionRole-1 941TUMK699WF\n\nLong term, review security documentation for AWS services that will be enabled for RubyGems. Some important configuration options may be specific to the service and \"hidden\" inside its documentation.\n\n#### References\n\n- [aws:SourceArn](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn) documentation\n- Summit Route, 2019.04.03, [\"Advanced](https://summitroute.com/blog/2019/04/03/advanced_aws_policy_auditing_confused_deputies_with_aws_services/) AWS policy auditing Confused deputies with AWS [services\"](https://summitroute.com/blog/2019/04/03/advanced_aws_policy_auditing_confused_deputies_with_aws_services/)\n", "severity": "Low", "difficulty": "Medium", "type": "Access Controls", "finding_id": "TOB-RGM-18", "target": {"path": "AWS IAM roles", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/prowler-cloud/prowler", "org": "prowler-cloud", "name": "prowler", "commit": null, "branch": null, "relative_file": "AWS IAM roles", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "Medium", "Type": "Access Controls", "Finding ID": "TOB-RGM-18", "Target": "AWS IAM roles"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-019", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 19, "page_start": 51, "title": "External GitHub CI actions are not pinned", "short_summary": null, "description_md": "#### Description\n\nThe rubygems.org GitHub Action pipeline uses a third-party kubeconform action. This action is part of the supply chain for CI/CD and can execute arbitrary code in the CI/CD pipelines. The action is pinned by version, and not by commit hash.\n\n```\n- name: kubeconform\n  uses: docker://ghcr.io/yannh/kubeconform:v0.6.3\n  with:\n    entrypoint: \"/kubeconform\"\n    args: \"-strict -summary -output json --kubernetes-version ${{\nmatrix.kubernetes_version }} config/deploy/${{ matrix.environment }}.rendered.yaml\"\n```\n\n*Figure 19.1: The action pinned by version ([rubygems.org/.github/workflows/lint.yml#67–71](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/.github/workflows/lint.yml#L67-L71))*\n\nMoreover, no third-party actions in rubygems-terraform configuration are pinned by hash, although all of these actions are trusted.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 19. External GitHub CI actions are not pinned\n\n| Severity: Low                                                                      | Diffi culty: High      |\n|---------------------------------------------------------------------------------------|------------------------------|\n| Type: Patching                                                                     | Finding ID: TOB-RGM-19 |\n| Target: rubygems.org lint.yml and rubygems-terraform GitHub Actions |                              |\n\n#### Description\n\nThe rubygems.org GitHub Action pipeline uses a third-party kubeconform action. This action is part of the supply chain for CI/CD and can execute arbitrary code in the CI/CD pipelines. The action is pinned by version, and not by commit hash.\n\n```\n- name: kubeconform\n  uses: docker://ghcr.io/yannh/kubeconform:v0.6.3\n  with:\n    entrypoint: \"/kubeconform\"\n    args: \"-strict -summary -output json --kubernetes-version ${{\nmatrix.kubernetes_version }} config/deploy/${{ matrix.environment }}.rendered.yaml\"\n```\n\n*Figure 19.1: The action pinned by version ([rubygems.org/.github/workflows/lint.yml#67–71](https://github.com/rubygems/rubygems.org/blob/21895a522076d15a3cb8d072229e2cfdbdb873e8/.github/workflows/lint.yml#L67-L71))*\n\nMoreover, no third-party actions in rubygems-terraform configuration are pinned by hash, although all of these actions are trusted.\n\n#### Exploit Scenario\n\nAn attacker uses social engineering to take over a private GitHub account with write permissions for one of the untrusted GitHub actions. For example, a user uses an already-leaked password and is convinced to send a 2FA code to the attacker. The attacker updates the GitHub action to include code to exfiltrate all secrets in CI/CD pipelines that use the action.\n\n#### Recommendations\n\nShort term, pin all external and [third-party](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions#using-third-party-actions) actions to a Git commit hash. Avoid pinning to a Git tag, as these can be changed after creation. We also recommend using the [pin-github-action](https://www.npmjs.com/package/pin-github-action) or [frizbee](https://github.com/stacklok/frizbee) tool to manage pinned actions. GitHub [dependabot](https://github.com/dependabot) is capable of updating GitHub Actions that use commit hashes.\n\nLong term, audit all pinned actions or replace them with a custom implementation.\n", "severity": "Low", "difficulty": "High", "type": "Patching", "finding_id": "TOB-RGM-19", "target": {"path": "rubygems.org lint.yml and rubygems-terraform GitHub Actions", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "rubygems.org lint.yml and rubygems-terraform GitHub Actions", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Patching", "Finding ID": "TOB-RGM-19", "Target": "rubygems.org lint.yml and rubygems-terraform GitHub Actions"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-020", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 20, "page_start": 52, "title": "Terraform OIDC provider has insecure configuration", "short_summary": null, "description_md": "#### Description\n\nTwo Terraform OIDC configurations are insecure: they do not validate the sub fields of authentication tokens:\n\n- [arn:aws:iam::048268392960:role/RubyAPITerraformProvisioner](https://us-east-1.console.aws.amazon.com/iam/home?region=eu-north-1#/roles/details/RubyAPITerraformProvisioner?section=trust_relationships)\n- [arn:aws:iam::048268392960:role/RubyAPITerraformCloud](https://us-east-1.console.aws.amazon.com/iam/home?region=eu-north-1#/roles/details/RubyAPITerraformCloud?section=trust_relationships)\n\n```\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"Federated\":\n\"arn:aws:iam::048268392960:oidc-provider/app.terraform.io\"\n            },\n            \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n            \"Condition\": {\n                \"StringEquals\": {\n                    \"app.terraform.io:aud\": \"aws.workload.identity\"\n                }\n            }\n        }\n    ]\n}\n```\n\n*Figure 20.1: Insecure role configuration*\n\nThe RubyAPITerraformCloud role has no permission attached, but the RubyAPITerraformProvisioner has the RubyAPITerraformCloud permission policy attached. It gives the role partial read-only access to EC2 and EKS resources, as well as the ec2:createVpc permission. More importantly, write permissions are given to EC2 and EKS resources tagged as \"rubyapi\".\n\nThe severity of this finding is low because the rubyapi project is out of this audit's scope; for that project, the severity is high.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 20. Terraform OIDC provider has insecure configuration\n\n| Severity: Low               | Diffi culty: Medium    |\n|--------------------------------|------------------------------|\n| Type: Access Controls    | Finding ID: TOB-RGM-20 |\n| Target: AWS IAM roles |                              |\n\n#### Description\n\nTwo Terraform OIDC configurations are insecure: they do not validate the sub fields of authentication tokens:\n\n- [arn:aws:iam::048268392960:role/RubyAPITerraformProvisioner](https://us-east-1.console.aws.amazon.com/iam/home?region=eu-north-1#/roles/details/RubyAPITerraformProvisioner?section=trust_relationships)\n- [arn:aws:iam::048268392960:role/RubyAPITerraformCloud](https://us-east-1.console.aws.amazon.com/iam/home?region=eu-north-1#/roles/details/RubyAPITerraformCloud?section=trust_relationships)\n\n```\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"Federated\":\n\"arn:aws:iam::048268392960:oidc-provider/app.terraform.io\"\n            },\n            \"Action\": \"sts:AssumeRoleWithWebIdentity\",\n            \"Condition\": {\n                \"StringEquals\": {\n                    \"app.terraform.io:aud\": \"aws.workload.identity\"\n                }\n            }\n        }\n    ]\n}\n```\n\n*Figure 20.1: Insecure role configuration*\n\nThe RubyAPITerraformCloud role has no permission attached, but the RubyAPITerraformProvisioner has the RubyAPITerraformCloud permission policy attached. It gives the role partial read-only access to EC2 and EKS resources, as well as the ec2:createVpc permission. More importantly, write permissions are given to EC2 and EKS resources tagged as \"rubyapi\".\n\nThe severity of this finding is low because the rubyapi project is out of this audit's scope; for that project, the severity is high.\n\n\n#### Exploit Scenario\n\nMallory creates a new account in HashiCorp. Due to the lack of sub claim validation, her HashiCorp account is able to configure the OIDC to assume RubyGems' RubyAPITerraformProvisioner role.\n\nMallory creates a new VPC configuration that later is incidentally attached to production EC2 instances. The new VPC enables public access to private, internal services.\n\n#### Recommendations\n\nShort term, remove the two insecure OIDC configurations.\n\nLong term, migrate all configurations to Terraform and do not manually create or update AWS resources. Doing so will enforce that all changes go through GitHub code-update workflows like peer reviews and approvals.\n\n#### References\n\n- Eduard Agavriloae, Aug 15, 2024, \"[Addressed](https://hacktodef.com/addressed-aws-defaults-risks-oidc-terraform-and-anonymous-to-administratoraccess) AWS defaults risks: OIDC, Terraform and Anonymous to [AdministratorAccess](https://hacktodef.com/addressed-aws-defaults-risks-oidc-terraform-and-anonymous-to-administratoraccess)\"\n- HashiCorp documentation, \"Dynamic [Credentials](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/aws-configuration#configure-a-role-and-trust-policy) with the AWS Provider\"\n", "severity": "Low", "difficulty": "Medium", "type": "Access Controls", "finding_id": "TOB-RGM-20", "target": {"path": "AWS IAM roles", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "AWS IAM roles", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "Medium", "Type": "Access Controls", "Finding ID": "TOB-RGM-20", "Target": "AWS IAM roles"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-021", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 21, "page_start": 54, "title": "RubyGems and RubyAPI projects are under a single AWS account but different Terraform configurations", "short_summary": null, "description_md": "#### Description\n\nAWS resources for the RubyGems project are managed with Terraform. Another project, rubyapi, is not managed via Terraform (or its configurations are stored in a different GitHub repository), but is deployed within the same AWS account as RubyGems. This design does not follow the principle of least privilege and creates risks of lateral movement: bugs in one project may be used to compromise the other one.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 21. RubyGems and RubyAPI projects are under a single AWS account but different Terraform configurations\n\n| Severity: Medium         | Diffi culty: High      |\n|-----------------------------|------------------------------|\n| Type: Access Controls | Finding ID: TOB-RGM-21 |\n| Target: AWS account   |                              |\n\n#### Description\n\nAWS resources for the RubyGems project are managed with Terraform. Another project, rubyapi, is not managed via Terraform (or its configurations are stored in a different GitHub repository), but is deployed within the same AWS account as RubyGems. This design does not follow the principle of least privilege and creates risks of lateral movement: bugs in one project may be used to compromise the other one.\n\n#### Exploit Scenario\n\nA vulnerability in rubyapi's AWS configuration enables attackers to modify all EC2 resources. The attacker exploits this bug to make malicious changes in RubyGems' EC2 instances.\n\n#### Recommendations\n\nShort term, implement one of the following recommendations:\n\n- 1. Migrate all projects that use the single AWS account to Terraform.\n- 2. Move rubyapi (and possibly other projects) to a separate AWS account.\n\nThe decision of which solution to choose depends mostly on business context like the structure of the Ruby Central team. However, we recommend the second option, as it provides stronger isolation and will help prevent not only attacks but also configuration issues.\n\nIf the second option is chosen, then disable unused AWS Regions after projects are separated. Unused but enabled regions may be used by attackers for stealth. Resources assigned to regions can be found with, for example, AWS Tag [Editor.](https://us-east-1.console.aws.amazon.com/resource-groups/tag-editor/find-resources)\n\nLong term, list and review all Ruby Central projects and AWS accounts in the organization, and ensure that every project is either centrally managed or in a separate AWS account. When creating new projects, move them to new AWS accounts from the beginning.\n", "severity": "Medium", "difficulty": "High", "type": "Access Controls", "finding_id": "TOB-RGM-21", "target": {"path": "AWS account", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "AWS account", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "High", "Type": "Access Controls", "Finding ID": "TOB-RGM-21", "Target": "AWS account"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-022", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 22, "page_start": 55, "title": "SQS policy has S3-based policy without account", "short_summary": null, "description_md": "#### Description\n\nThe fastly\\_logs\\_production (and staging) SQS allows the rubygems-fastly-downloads-production S3 bucket to send messages to the SQS. The bucket is not limited by the aws:sourceAccount condition. If the bucket is removed and claimed by an attacker in any AWS account, the attacker will be able to send messages to the queue.\n\n```\n{\n  \"Version\": \"2008-10-17\",\n  \"Id\": \"policy-allow-from-s3\",\n  \"Statement\": [\n    {\n      \"Sid\": \"sid-allow-from-S3\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"SQS:SendMessage\",\n      \"Resource\": \"${sqs_arn}\",\n      \"Condition\": {\n        \"ArnLike\": {\n          \"aws:SourceArn\": \"${bucket_arn}\"\n        }\n      }\n    }\n  ]\n}\n```\n\n*Figure 22.1: SQS configuration, aws:SourceArn condition does not contain AWS account ([rubygems-terraform/modules/rubygems-org-app/policies/fastly\\\\_logs\\\\_sqs\\\\_pol](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/policies/fastly_logs_sqs_policy.tpl) [icy.tpl#1–21](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/policies/fastly_logs_sqs_policy.tpl))*\n\nPlease note that Fastly is permanently vulnerable to similar attacks, since this service does not validate the account of an S3 owner before reading data or writing logs. That is, if a S3 bucket is removed by Ruby Central and claimed by an attacker while the Fastly configuration remains unchanged, then the attacker could control data exposed on Ruby\n\n\nCentral HTTP domains. We are not aware of any mitigations that could be configured in Fastly.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 22. SQS policy has S3-based policy without account\n\n| Severity: Low                | Diffi culty: High      |\n|---------------------------------|------------------------------|\n| Type: Access Controls     | Finding ID: TOB-RGM-22 |\n| Target: AWS SQS policy |                              |\n\n#### Description\n\nThe fastly\\_logs\\_production (and staging) SQS allows the rubygems-fastly-downloads-production S3 bucket to send messages to the SQS. The bucket is not limited by the aws:sourceAccount condition. If the bucket is removed and claimed by an attacker in any AWS account, the attacker will be able to send messages to the queue.\n\n```\n{\n  \"Version\": \"2008-10-17\",\n  \"Id\": \"policy-allow-from-s3\",\n  \"Statement\": [\n    {\n      \"Sid\": \"sid-allow-from-S3\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"*\"\n      },\n      \"Action\": \"SQS:SendMessage\",\n      \"Resource\": \"${sqs_arn}\",\n      \"Condition\": {\n        \"ArnLike\": {\n          \"aws:SourceArn\": \"${bucket_arn}\"\n        }\n      }\n    }\n  ]\n}\n```\n\n*Figure 22.1: SQS configuration, aws:SourceArn condition does not contain AWS account ([rubygems-terraform/modules/rubygems-org-app/policies/fastly\\\\_logs\\\\_sqs\\\\_pol](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/policies/fastly_logs_sqs_policy.tpl) [icy.tpl#1–21](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/policies/fastly_logs_sqs_policy.tpl))*\n\nPlease note that Fastly is permanently vulnerable to similar attacks, since this service does not validate the account of an S3 owner before reading data or writing logs. That is, if a S3 bucket is removed by Ruby Central and claimed by an attacker while the Fastly configuration remains unchanged, then the attacker could control data exposed on Ruby\n\n\nCentral HTTP domains. We are not aware of any mitigations that could be configured in Fastly.\n\n#### Exploit Scenario\n\nThe Ruby Central team changes the bucket allowed to write to SQS but forgets to create the new bucket. An attacker notices the issue and claims the bucket. The attacker can write Fastly logs.\n\n#### Recommendations\n\nShort term, add the [aws:SourceAccount](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount) condition to the policy-allow-from-s3 policy. Change the Principal field of the policy to be equal to bucket\\_arn as a defense-in-depth protection.\n\nLong term, create a GitHub workflow that lists S3 buckets referenced in the Fastly configuration, and check if the owner of all the buckets is the expected AWS account (see also [TOB-RGM-29](#page-68-0)). Alternatively, reference all S3 buckets by variables and not with hard-coded names in the Fastly configuration; this change should prevent usage of buckets not managed via Terraform.\n", "severity": "Low", "difficulty": "High", "type": "Access Controls", "finding_id": "TOB-RGM-22", "target": {"path": "AWS SQS policy", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "AWS SQS policy", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Access Controls", "Finding ID": "TOB-RGM-22", "Target": "AWS SQS policy"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-023", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 23, "page_start": 57, "title": "GitHub Action Terraform policy is overly broad", "short_summary": null, "description_md": "#### Description\n\nGitHub Actions for rubygems-terraform repository (master branch) are granted all permissions to all AWS resources. The permissions should not include full access to some services, including:\n\n- Logging services like VPC [Flow](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_vpc.html#example_vpc_1) Logs and [CloudWatch](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_cloudwatch.html#example_cloudwatch_1). Compromise of the repository should not enable attackers to remove all logs.\n- Monitoring and alerting services like [GuardDuty](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_guardduty.html#example_guardduty_1). Compromise of the repository should not enable attackers to prevent the Ruby Central team from detecting the incident in a timely manner.\n- Global [configurations](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_config.html#example_config_1) like AWS Config. Compromise of the repository should not enable an attacker to disable global security configurations like the MFA requirement.\n- Creation of unexpected AWS services should not be possible. If a new service is used, then permissions to it should be explicitly granted through a change to the github-actions-terraform-policy. While not a strict security boundary, this recommendation should help detect malicious code changes in the repository.\n\nMoreover, management of other projects in the account (like RubyAPI) should not be possible from the repository (see also [TOB-RGM-21\\)](#page-54-0).\n\n```\ndata \"aws_iam_policy_document\" \"github-actions-terraform-policy\" {\n statement {\n   effect = \"Allow\"\n   condition {\n     test = \"ForAnyValue:StringLike\"\n     variable = \"token.actions.githubusercontent.com:sub\"\n     values = [\"repo:rubygems/rubygems-terraform:ref:refs/heads/master\"]\n   }\n   resources = [\"*\"]\n   actions = [\"*\"]\n }\n```\n\n\n```\nstatement {\n   effect = \"Allow\"\n   resources = [\"arn:aws:secretsmanager:us-west-2:048268392960:secret:terraform/*\"]\n   actions = [\"secretsmanager:GetSecretValue\"]\n }\n}\n```\n\n*Figure 23.1: Overly broad permissions for GitHub Actions ([rubygems-terraform/iam.tf#132–148](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/iam.tf#L132-L148))*\n\nTo prevent GitHub Actions for rubygems-terraform repository from abusing IAM permissions for privilege escalation, there are two possible solutions:\n\n- Access policies [boundaries](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html): IAM resources created via Terraform would be restricted with the same allowlist/denylist used to restrict the github-actions-terraform-policy.\n- Separate repository for IAM management: if changes to IAM are expected to be less frequent and less urgent than changes to other services, then having a separate code control repository with higher AWS privileges (to manage IAM resources), but with stricter GitHub security configuration (like strict branch protection enabled), would help to mitigate the privilege escalation attacks.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 23. GitHub Action Terraform policy is overly broad\n\n| Severity: Low                     | Diffi culty: High      |\n|--------------------------------------|------------------------------|\n| Type: Access Controls          | Finding ID: TOB-RGM-23 |\n| rubygems-terraform/iam.tf Target: |                              |\n\n#### Description\n\nGitHub Actions for rubygems-terraform repository (master branch) are granted all permissions to all AWS resources. The permissions should not include full access to some services, including:\n\n- Logging services like VPC [Flow](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_vpc.html#example_vpc_1) Logs and [CloudWatch](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_cloudwatch.html#example_cloudwatch_1). Compromise of the repository should not enable attackers to remove all logs.\n- Monitoring and alerting services like [GuardDuty](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_guardduty.html#example_guardduty_1). Compromise of the repository should not enable attackers to prevent the Ruby Central team from detecting the incident in a timely manner.\n- Global [configurations](https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps_examples_config.html#example_config_1) like AWS Config. Compromise of the repository should not enable an attacker to disable global security configurations like the MFA requirement.\n- Creation of unexpected AWS services should not be possible. If a new service is used, then permissions to it should be explicitly granted through a change to the github-actions-terraform-policy. While not a strict security boundary, this recommendation should help detect malicious code changes in the repository.\n\nMoreover, management of other projects in the account (like RubyAPI) should not be possible from the repository (see also [TOB-RGM-21\\)](#page-54-0).\n\n```\ndata \"aws_iam_policy_document\" \"github-actions-terraform-policy\" {\n statement {\n   effect = \"Allow\"\n   condition {\n     test = \"ForAnyValue:StringLike\"\n     variable = \"token.actions.githubusercontent.com:sub\"\n     values = [\"repo:rubygems/rubygems-terraform:ref:refs/heads/master\"]\n   }\n   resources = [\"*\"]\n   actions = [\"*\"]\n }\n```\n\n\n```\nstatement {\n   effect = \"Allow\"\n   resources = [\"arn:aws:secretsmanager:us-west-2:048268392960:secret:terraform/*\"]\n   actions = [\"secretsmanager:GetSecretValue\"]\n }\n}\n```\n\n*Figure 23.1: Overly broad permissions for GitHub Actions ([rubygems-terraform/iam.tf#132–148](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/iam.tf#L132-L148))*\n\nTo prevent GitHub Actions for rubygems-terraform repository from abusing IAM permissions for privilege escalation, there are two possible solutions:\n\n- Access policies [boundaries](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_boundaries.html): IAM resources created via Terraform would be restricted with the same allowlist/denylist used to restrict the github-actions-terraform-policy.\n- Separate repository for IAM management: if changes to IAM are expected to be less frequent and less urgent than changes to other services, then having a separate code control repository with higher AWS privileges (to manage IAM resources), but with stricter GitHub security configuration (like strict branch protection enabled), would help to mitigate the privilege escalation attacks.\n\n#### Exploit Scenario\n\nMallory compromises the rubygems-terraform repository. She turns off monitoring and alerting AWS services, and then installs backdoors in a few gems. Later, when the attack is detected, she uses the repository to purge all AWS data, including all logs. It is much harder to perform incident response and investigate the attack.\n\n#### Recommendations\n\nShort term, limit permissions in the github-actions-terraform-policy policy:\n\n- Only allow access to services that are actually managed via Terraform.\n- Deny destructive access to logging, monitoring, alerting, and configuration services. These services generally should be set up once and not disabled or modified afterwards. For examples of access denylists, see the links in the Description section above.\n\nAdditionally, restrict resources created/managed via Terraform with the same restrictions as stated above. To do this, either use access policy boundaries or remove IAM permissions from the policy and create a separate, more hardened GitHub Terraform repository and role for only IAM management.\n\nLong term, periodically review existing policies and roles and minimize privileges to the necessary ones. Trim other full-access policies according to the recommendations above.\n", "severity": "Low", "difficulty": "High", "type": "Access Controls", "finding_id": "TOB-RGM-23", "target": {"path": "rubygems-terraform/iam.tf", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "rubygems-terraform/iam.tf", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Access Controls", "Finding ID": "TOB-RGM-23", "Target": "rubygems-terraform/iam.tf"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-024", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 24, "page_start": 59, "title": "Networking security concerns", "short_summary": null, "description_md": "#### Description\n\nThere are a few insecure configurations related to networking. While none are currently exploitable, they may result in severe vulnerabilities in the future.\n\nIngress SSH access on port 22 is enabled for CIDR blocks 0.0.0.0/0 in the following security groups:\n\n- [rubygems-common-all](https://us-west-2.console.aws.amazon.com/vpcconsole/home?region=us-west-2#SecurityGroup:groupId=sg-9a6ddaff)\n  - This group is used by the arn:aws:elasticache:us-west-2:048268392960:cluster:shipit2 cluster. The cluster is not exposed outside of VPC, but opening port 22 is redundant, or at least the CIDR block is too open.\n- [rubygems-common-chef](https://us-west-2.console.aws.amazon.com/vpcconsole/home?region=us-west-2#SecurityGroup:groupId=sg-dec74dbb)\n  - This group is not used and appears to be a leftover.\n\nThe Amazon EKS (K8s) API endpoint is reachable through the public internet. The endpoint\\_public\\_access should be set to false to limit access to K8s admin endpoint.\n\n```\nvpc_config {\n security_group_ids = [aws_security_group.eks-cluster.id]\n endpoint_private_access = true\n endpoint_public_access = true\n```\n\n*Figure 24.1: Configuration enabling public K8s endpoint ([rubygems-terraform/eks.tf#57–60](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/eks.tf#L57-L60C5))*\n\nEKS-managed nodes have the associate\\_public\\_ip\\_address flag set to true. This results in public IPs being assigned to the nodes. The issue is not exploitable, as the external access is blocked by security groups; however, public IPs increase the chance of exploitable misconfigurations.\n\n```\nresource \"aws_launch_template\" \"eks-managed-nodes\" {\n  name = \"eks-managed-nodes\"\n```\n\n\n```\nnetwork_interfaces {\n  associate_public_ip_address = true\n  security_groups = [\n    aws_security_group.eks-node.id\n  ]\n}\n```\n\n*Figure 24.2: Configuration enabling automatic association of public IP addresses ([rubygems-terraform/eks.tf#416–424](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/eks.tf#L416-L424))*\n\nAll three subnets configured via Terraform have the map\\_public\\_ip\\_on\\_launch flag set to true. This configuration makes the AWS assign public IP addresses to new resources, which may unintentionally expose them to the internet. Please note that this flag and the associate\\_public\\_ip\\_address flag may [overwrite each](https://github.com/hashicorp/terraform/issues/10568) other.\n\n```\nresource \"aws_subnet\" \"main-a\" {\n vpc_id = aws_vpc.rubygems.id\n cidr_block = \"172.30.0.0/24\"\n availability_zone = \"us-west-2a\"\n map_public_ip_on_launch = true\n```\n\n*Figure 24.3: Configuration enabling automatic mapping of public IP addresses ([rubygems-terraform/subnets.tf#1–5](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/subnets.tf#L1-L5))*\n\nCurrently all resources with public IPs are protected by security groups and are not remotely reachable. For example, IP 52.38.177.176 (network interface eni-0bdca602657463234) has a security group that blocks any internet access.\n\nFinally, network ACLs are not used. These should be configured and should [correspond](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html) to [security](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html) groups of the VPC as a defense-in-depth mechanism.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "| 24. Networking security concerns |                              |\n|-------------------------------------------|------------------------------|\n| Severity: Low                          | Diffi culty: High      |\n| Type: Access Controls               | Finding ID: TOB-RGM-24 |\n| Target: AWS networking              |                              |\n\n#### Description\n\nThere are a few insecure configurations related to networking. While none are currently exploitable, they may result in severe vulnerabilities in the future.\n\nIngress SSH access on port 22 is enabled for CIDR blocks 0.0.0.0/0 in the following security groups:\n\n- [rubygems-common-all](https://us-west-2.console.aws.amazon.com/vpcconsole/home?region=us-west-2#SecurityGroup:groupId=sg-9a6ddaff)\n  - This group is used by the arn:aws:elasticache:us-west-2:048268392960:cluster:shipit2 cluster. The cluster is not exposed outside of VPC, but opening port 22 is redundant, or at least the CIDR block is too open.\n- [rubygems-common-chef](https://us-west-2.console.aws.amazon.com/vpcconsole/home?region=us-west-2#SecurityGroup:groupId=sg-dec74dbb)\n  - This group is not used and appears to be a leftover.\n\nThe Amazon EKS (K8s) API endpoint is reachable through the public internet. The endpoint\\_public\\_access should be set to false to limit access to K8s admin endpoint.\n\n```\nvpc_config {\n security_group_ids = [aws_security_group.eks-cluster.id]\n endpoint_private_access = true\n endpoint_public_access = true\n```\n\n*Figure 24.1: Configuration enabling public K8s endpoint ([rubygems-terraform/eks.tf#57–60](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/eks.tf#L57-L60C5))*\n\nEKS-managed nodes have the associate\\_public\\_ip\\_address flag set to true. This results in public IPs being assigned to the nodes. The issue is not exploitable, as the external access is blocked by security groups; however, public IPs increase the chance of exploitable misconfigurations.\n\n```\nresource \"aws_launch_template\" \"eks-managed-nodes\" {\n  name = \"eks-managed-nodes\"\n```\n\n\n```\nnetwork_interfaces {\n  associate_public_ip_address = true\n  security_groups = [\n    aws_security_group.eks-node.id\n  ]\n}\n```\n\n*Figure 24.2: Configuration enabling automatic association of public IP addresses ([rubygems-terraform/eks.tf#416–424](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/eks.tf#L416-L424))*\n\nAll three subnets configured via Terraform have the map\\_public\\_ip\\_on\\_launch flag set to true. This configuration makes the AWS assign public IP addresses to new resources, which may unintentionally expose them to the internet. Please note that this flag and the associate\\_public\\_ip\\_address flag may [overwrite each](https://github.com/hashicorp/terraform/issues/10568) other.\n\n```\nresource \"aws_subnet\" \"main-a\" {\n vpc_id = aws_vpc.rubygems.id\n cidr_block = \"172.30.0.0/24\"\n availability_zone = \"us-west-2a\"\n map_public_ip_on_launch = true\n```\n\n*Figure 24.3: Configuration enabling automatic mapping of public IP addresses ([rubygems-terraform/subnets.tf#1–5](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/subnets.tf#L1-L5))*\n\nCurrently all resources with public IPs are protected by security groups and are not remotely reachable. For example, IP 52.38.177.176 (network interface eni-0bdca602657463234) has a security group that blocks any internet access.\n\nFinally, network ACLs are not used. These should be configured and should [correspond](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html) to [security](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-security-best-practices.html) groups of the VPC as a defense-in-depth mechanism.\n\n#### Exploit Scenario\n\nA vulnerability in Kubernetes is exploited by a third party by directly accessing the EKS K8s management endpoint. The attacker takes control of the cluster and installs backdoors into popular gems.\n\n#### Recommendations\n\nShort term, harden the network configuration by implementing the following recommendations:\n\n- Remove ingress port 22 from rubygems-common-all security group, or at least restrict the CIDR block to a few IP addresses. Remove the rubygems-common-chef security group.\n- [Disable public](https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html#modify-endpoint-access) access to EKS management endpoint. See this EKS [control](https://docs.aws.amazon.com/securityhub/latest/userguide/eks-controls.html#eks-1) for more information.\n\n\n- Set the associate\\_public\\_ip\\_address flag to false in the EKS configuration. See this [CodeGuru](https://docs.aws.amazon.com/codeguru/detector-library/terraform/restrict-public-ip-ec2-terraform/) detector for more information.\n- Set the map\\_public\\_ip\\_on\\_launch flag to false for all subnets. See this [EC2](https://docs.aws.amazon.com/securityhub/latest/userguide/ec2-controls.html#ec2-15) [control](https://docs.aws.amazon.com/securityhub/latest/userguide/ec2-controls.html#ec2-15) for more information. For Load Balancers (that must have public IPs), either make the IP map explicit or move them to a separate subnet with the flag set to true.\n- Review public IP addresses assigned to AWS resources and remove them if they are not needed.\n\nLong term, add network ACLs that would create an additional layer of defense in case of misconfigurations.\n", "severity": "Low", "difficulty": "High", "type": "Access Controls", "finding_id": "TOB-RGM-24", "target": {"path": "AWS networking", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "AWS networking", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "High", "Type": "Access Controls", "Finding ID": "TOB-RGM-24", "Target": "AWS networking"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-025", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 25, "page_start": 62, "title": "GitHub token may be exposed in packed data in a release-gem action", "short_summary": null, "description_md": "#### Description\n\nThe release-gem GitHub Action stores GitHub authentication tokens in the filesystem in the .git/config file. This may result in the tokens being leaked if action's user creates an artifact from the repository's root.\n\n```\nsteps:\n  - name: Set remote URL\n    run: |\n      # Attribute commits to the last committer on HEAD\n      git config --global user.email \"$(git log -1 --pretty=format:'%ae')\"\n      git config --global user.name \"$(git log -1 --pretty=format:'%an')\"\n      git remote set-url origin \"https://x-access-token:${{ github.token\n}}@github.com/$GITHUB_REPOSITORY\"\n```\n\n*Figure 25.1: Action saving GitHub token in the filesystem ([release-gem/action.yml#18–24](https://github.com/rubygems/release-gem/blob/612653d273a73bdae1df8453e090060bb4db5f31/action.yml#L18-L24))*\n\nThe severity of this finding is only informational, as a breaking [change was](https://github.com/actions/upload-artifact/issues/602) recently [introduced](https://github.com/actions/upload-artifact/issues/602) in the upload-artifact action that prevents uploads of hidden folders.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 25. GitHub token may be exposed in packed data in a release-gem action\n\n| Severity: Informational        | Diffi culty: High      |\n|-----------------------------------|------------------------------|\n| Type: Data Exposure         | Finding ID: TOB-RGM-25 |\n| Target: release-gem/action.yml |                              |\n\n#### Description\n\nThe release-gem GitHub Action stores GitHub authentication tokens in the filesystem in the .git/config file. This may result in the tokens being leaked if action's user creates an artifact from the repository's root.\n\n```\nsteps:\n  - name: Set remote URL\n    run: |\n      # Attribute commits to the last committer on HEAD\n      git config --global user.email \"$(git log -1 --pretty=format:'%ae')\"\n      git config --global user.name \"$(git log -1 --pretty=format:'%an')\"\n      git remote set-url origin \"https://x-access-token:${{ github.token\n}}@github.com/$GITHUB_REPOSITORY\"\n```\n\n*Figure 25.1: Action saving GitHub token in the filesystem ([release-gem/action.yml#18–24](https://github.com/rubygems/release-gem/blob/612653d273a73bdae1df8453e090060bb4db5f31/action.yml#L18-L24))*\n\nThe severity of this finding is only informational, as a breaking [change was](https://github.com/actions/upload-artifact/issues/602) recently [introduced](https://github.com/actions/upload-artifact/issues/602) in the upload-artifact action that prevents uploads of hidden folders.\n\n#### Exploit Scenario\n\nAlice has a GitHub workflow for publishing her gem. Her workflow uses the release-gem action, and it produces an artifact after the action but before the workflow finishes. Mallory, an unprivileged user, steals GitHub tokens during workflow runs and uses them to install backdoors in Alice's gem.\n\n#### Recommendations\n\nShort term, remove the GitHub token from the \"Set remote URL\" step. If the token is necessary for some further steps, then insert the credentials explicitly in those steps in a way that will not make them persist in the filesystem (e.g., via the step's environment variables).\n\n#### References\n\n● Yaron Avital, 13 August, 2024, [\"ArtiPACKED:](https://unit42.paloaltonetworks.com/github-repo-artifacts-leak-tokens/) Hacking Giants Through a Race\n\n\n\n#### [Condition](https://unit42.paloaltonetworks.com/github-repo-artifacts-leak-tokens/) in GitHub Actions Artifacts\"\n\n● GitHub documentation, \"Automatic token [authentication\"](https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication)\n", "severity": "Informational", "difficulty": "High", "type": "Data Exposure", "finding_id": "TOB-RGM-25", "target": {"path": "release-gem/action.yml", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/release-gem", "org": "rubygems", "name": "release-gem", "commit": "612653d273a73bdae1df8453e090060bb4db5f31", "branch": null, "relative_file": "release-gem/action.yml", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Data Exposure", "Finding ID": "TOB-RGM-25", "Target": "release-gem/action.yml"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-026", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 26, "page_start": 64, "title": "GitHub Action redundant persist-credentials", "short_summary": null, "description_md": "#### Description\n\nAll workflows (except the scorecards) in the rubygems.org and rubygems-terraform repositories use the default configuration for the actions/checkout action. The default configuration for the persist-credentials flag is true. This makes the action persist GitHub tokens in a filesystem.\n\nWhile this issue is not exploitable since the filesystem is never publicly exposed, the tokens' persistence seems to be not required by subsequent steps.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 26. GitHub Action redundant persist-credentials\n\n| Severity: Informational                                                | Diffi culty: High      |\n|---------------------------------------------------------------------------|------------------------------|\n| Type: Data Exposure                                                 | Finding ID: TOB-RGM-26 |\n| Target: rubygems.org and rubygems-terraform GitHub Actions |                              |\n\n#### Description\n\nAll workflows (except the scorecards) in the rubygems.org and rubygems-terraform repositories use the default configuration for the actions/checkout action. The default configuration for the persist-credentials flag is true. This makes the action persist GitHub tokens in a filesystem.\n\nWhile this issue is not exploitable since the filesystem is never publicly exposed, the tokens' persistence seems to be not required by subsequent steps.\n\n#### Recommendations\n\nShort term, add explicit persist-credentials flags with false values to all actions/checkout actions used in workflows. If some steps need the GitHub credentials, then plumb them explicitly. Add the flag to the [releasing-gem](https://guides.rubygems.org/trusted-publishing/releasing-gems/) documentation so that users who are copy-pasting the code use the more secure configuration.\n\n# References\n\n● [The actions/checkout](https://github.com/actions/checkout/issues/485) Issue #485\n", "severity": "Informational", "difficulty": "High", "type": "Data Exposure", "finding_id": "TOB-RGM-26", "target": {"path": "rubygems.org and rubygems-terraform GitHub Actions", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/release-gem", "org": "rubygems", "name": "release-gem", "commit": "612653d273a73bdae1df8453e090060bb4db5f31", "branch": null, "relative_file": "rubygems.org and rubygems-terraform GitHub Actions", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Data Exposure", "Finding ID": "TOB-RGM-26", "Target": "rubygems.org and rubygems-terraform GitHub Actions"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-027", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 27, "page_start": 65, "title": "Fastly uses long-lived credentials instead of OIDC", "short_summary": null, "description_md": "#### Description\n\nTerraform configures the Fastly service to use long-lived AWS credentials for logging. OIDC is the recommended way of authenticating Fastly to AWS. In other words, a new AWS role should be created for Fastly, instead of an AWS user.\n\n```\nlogging_s3 {\n name = \"downloads\"\n format = \"%h now req.url %>s req.http.User-Agent\"\n format_version = 1\n bucket_name = var.downloads_bucket_name\n s3_access_key = var.downloads_s3_access_key\n s3_secret_key = var.downloads_s3_secret_key\n```\n\n*Figure 27.1: Configuration using long-lived AWS credentials for Fastly logging ([rubygems-terraform/fastly/modules/main.tf#279–285](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/modules/main.tf#L279-L285))*\n\nUnfortunately, Fastly does not allow OIDC-like authentication for accessing private S3 buckets as data sources (origins). Using long-lived AWS credentials is non-avoidable.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 27. Fastly uses long-lived credentials instead of OIDC Severity: **Informational** Difficulty: **High** Type: Authentication Finding ID: TOB-RGM-27 Target: rubygems-terraform/fastly\n\n#### Description\n\nTerraform configures the Fastly service to use long-lived AWS credentials for logging. OIDC is the recommended way of authenticating Fastly to AWS. In other words, a new AWS role should be created for Fastly, instead of an AWS user.\n\n```\nlogging_s3 {\n name = \"downloads\"\n format = \"%h now req.url %>s req.http.User-Agent\"\n format_version = 1\n bucket_name = var.downloads_bucket_name\n s3_access_key = var.downloads_s3_access_key\n s3_secret_key = var.downloads_s3_secret_key\n```\n\n*Figure 27.1: Configuration using long-lived AWS credentials for Fastly logging ([rubygems-terraform/fastly/modules/main.tf#279–285](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/modules/main.tf#L279-L285))*\n\nUnfortunately, Fastly does not allow OIDC-like authentication for accessing private S3 buckets as data sources (origins). Using long-lived AWS credentials is non-avoidable.\n\n#### Recommendations\n\nShort term, consider implementing authentication for Fastly logs using AWS roles. This change should slightly improve security. However, this change requires creating both user and roles for Fastly, which would increase overall complexity.\n\n#### References\n\n● Fastly documentation, \"Log [streaming:](https://docs.fastly.com/en/guides/log-streaming-amazon-s3) Amazon S3\"\n", "severity": "Informational", "difficulty": "High", "type": "Authentication", "finding_id": "TOB-RGM-27", "target": {"path": "rubygems-terraform/fastly", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/rubygems-terraform", "org": "rubygems", "name": "rubygems-terraform", "commit": "9c22354c60ac59de9a2cad32c3f061e196350c29", "branch": null, "relative_file": "rubygems-terraform/fastly", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Authentication", "Finding ID": "TOB-RGM-27", "Target": "rubygems-terraform/fastly"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-028", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 28, "page_start": 66, "title": "Stored XSS in gems.rubygemsusercontent.org", "short_summary": null, "description_md": "#### Description\n\nThe gems.rubygemsusercontent.org domain serves user-controlled files with either user-controlled or automatically deduced content types. This behavior enables users to create persistent XSS exploits in the domain.\n\nThe domain is different from the more important RubyGems.org, so the severity of this issue is very limited. However, users may trust the domain (as it belongs to Ruby Central), and instances of XSS inside it may be unexpected. Moreover, there seems to be no business value in serving user files with insecure content types.\n\nThe gems.rubygemsusercontent.org domain serves files from the contents.oregon.production.s3.rubygems.org S3 bucket (figures 28.1–2). The bucket holds objects created from gems source files (controlled by gems creators). The files are served with the HTTP response Content-Type header taken from the object's metadata (figure 28.3).\n\n```\ncontents = {\n host = \"gems.rubygemsusercontent.org\"\n bucket_name = \"contents.oregon.production.s3.rubygems.org\",\n}\n```\n\n*Figure 28.1: Part of the Fastly configuration ([rubygems-terraform/fastly/main.tf#126–129](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/main.tf#L126-L129))*\n\n```\ncondition {\n name = \"is_contents_s3_request\"\n priority = 9\n statement = \"req.http.host == \\\"${var.contents.host}\\\"\"\n type = \"REQUEST\"\n}\n```\n\n*Figure 28.2: Part of the Fastly configuration ([rubygems-terraform/fastly/modules/main.tf#185–190](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/modules/main.tf#L185-L190))*\n\n\n\n\n*Figure 28.3: Example AWS metadata entries*\n\nThe metadata is either controlled by gems owners or set automatically by AWS. In either case, publishing a gem with an HTML file is sufficient to create an XSS payload.\n\nAs an example, the [sogilis/csv\\\\_fast\\\\_importer](https://github.com/sogilis/csv_fast_importer/blob/7343092dca117d7d85c2885b90edcabae7195f5f/sample-app/public/422.html) repository stores a 422.html file. The file's reference can be found with [this](https://gems.rubygemsusercontent.org/gems/csv_fast_importer/paths/1.2.0/sample-app/public/422.html) link. Then, if opened with this [URL,](https://gems.rubygemsusercontent.org/gems/csv_fast_importer/contents/a699bce0b9481ae5ac7e8121cca1ded3573e369502d56c353311fe263a3569e7) the HTML file is served with the HTML content type.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 28. Stored XSS in gems.rubygemsusercontent.org Severity: **Low** Difficulty: **Low** Type: Data Validation Finding ID: TOB-RGM-28 Target: AWS S3 buckets and Fastly\n\n#### Description\n\nThe gems.rubygemsusercontent.org domain serves user-controlled files with either user-controlled or automatically deduced content types. This behavior enables users to create persistent XSS exploits in the domain.\n\nThe domain is different from the more important RubyGems.org, so the severity of this issue is very limited. However, users may trust the domain (as it belongs to Ruby Central), and instances of XSS inside it may be unexpected. Moreover, there seems to be no business value in serving user files with insecure content types.\n\nThe gems.rubygemsusercontent.org domain serves files from the contents.oregon.production.s3.rubygems.org S3 bucket (figures 28.1–2). The bucket holds objects created from gems source files (controlled by gems creators). The files are served with the HTTP response Content-Type header taken from the object's metadata (figure 28.3).\n\n```\ncontents = {\n host = \"gems.rubygemsusercontent.org\"\n bucket_name = \"contents.oregon.production.s3.rubygems.org\",\n}\n```\n\n*Figure 28.1: Part of the Fastly configuration ([rubygems-terraform/fastly/main.tf#126–129](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/main.tf#L126-L129))*\n\n```\ncondition {\n name = \"is_contents_s3_request\"\n priority = 9\n statement = \"req.http.host == \\\"${var.contents.host}\\\"\"\n type = \"REQUEST\"\n}\n```\n\n*Figure 28.2: Part of the Fastly configuration ([rubygems-terraform/fastly/modules/main.tf#185–190](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/modules/main.tf#L185-L190))*\n\n\n\n\n*Figure 28.3: Example AWS metadata entries*\n\nThe metadata is either controlled by gems owners or set automatically by AWS. In either case, publishing a gem with an HTML file is sufficient to create an XSS payload.\n\nAs an example, the [sogilis/csv\\\\_fast\\\\_importer](https://github.com/sogilis/csv_fast_importer/blob/7343092dca117d7d85c2885b90edcabae7195f5f/sample-app/public/422.html) repository stores a 422.html file. The file's reference can be found with [this](https://gems.rubygemsusercontent.org/gems/csv_fast_importer/paths/1.2.0/sample-app/public/422.html) link. Then, if opened with this [URL,](https://gems.rubygemsusercontent.org/gems/csv_fast_importer/contents/a699bce0b9481ae5ac7e8121cca1ded3573e369502d56c353311fe263a3569e7) the HTML file is served with the HTML content type.\n\n#### Exploit Scenario\n\nMallory publishes a gem with a malicious HTML file. The file contains JavaScript payload for [BeEF](https://beefproject.com/). Mallory easily phishes users to visit the website, as the users believe the domain to be trusted.\n\n#### Recommendations\n\nShort term, find how the Content-Type metadata is created when uploading objects to S3 buckets. If the metadata is user-provided, then create an allowlist of content types. If the metadata is automatically deduced, then add an automatic request (sent after object creation) that would update the Content-Type metadata to text/plain or octet/stream.\n\nIn either case, configure Fastly to overwrite content types of HTTP responses when serving files from S3 buckets with text/plain and octet/stream.\n", "severity": "Low", "difficulty": "Low", "type": "Data Validation", "finding_id": "TOB-RGM-28", "target": {"path": "AWS S3 buckets and Fastly", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/rubygems/release-gem", "org": "rubygems", "name": "release-gem", "commit": "612653d273a73bdae1df8453e090060bb4db5f31", "branch": null, "relative_file": "AWS S3 buckets and Fastly", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Low", "Difficulty": "Low", "Type": "Data Validation", "Finding ID": "TOB-RGM-28", "Target": "AWS S3 buckets and Fastly"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-029", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 29, "page_start": 68, "title": "OIDC S3 buckets are not claimed but are configured in Fastly", "short_summary": null, "description_md": "#### Description\n\nThe Fastly configuration (figure 29.1) exposes a few subdomains of RubyGems.org with S3 buckets as data sources. The buckets are not claimed by anybody. An attacker can claim them, effectively taking control over the subdomains.\n\n```\ncontents = {\n host = \"gems.oidc-api-token.rubygemsusercontent.org\"\n bucket_name = \"contents.oregon.oidc-api-token.s3.rubygems.org\",\n}\ncompact_index = {\n bucket_name = \"compact-index.oregon.oidc-api-token.s3.rubygems.org\"\n}\ncompact_index_host = \"oidc-api-token.rubygems.org\"\n```\n\n*Figure 29.1: Vulnerable S3 buckets and subdomains ([rubygems-terraform/fastly/oidc-api-tokens.tf#34–42](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/oidc-api-tokens.tf#L34-L42))*\n\nThe issue can be observed [here.](https://oidc-api-token.rubygems.org/gems/tob.gem)\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 29. OIDC S3 buckets are not claimed but are configured in Fastly\n\n| Severity: Medium                                     | Diffi culty: High      |\n|---------------------------------------------------------|------------------------------|\n| Type: Configuration                                  | Finding ID: TOB-RGM-29 |\n| Target: rubygems-terraform/fastly/oidc-api-tokens.tf |                              |\n\n#### Description\n\nThe Fastly configuration (figure 29.1) exposes a few subdomains of RubyGems.org with S3 buckets as data sources. The buckets are not claimed by anybody. An attacker can claim them, effectively taking control over the subdomains.\n\n```\ncontents = {\n host = \"gems.oidc-api-token.rubygemsusercontent.org\"\n bucket_name = \"contents.oregon.oidc-api-token.s3.rubygems.org\",\n}\ncompact_index = {\n bucket_name = \"compact-index.oregon.oidc-api-token.s3.rubygems.org\"\n}\ncompact_index_host = \"oidc-api-token.rubygems.org\"\n```\n\n*Figure 29.1: Vulnerable S3 buckets and subdomains ([rubygems-terraform/fastly/oidc-api-tokens.tf#34–42](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/fastly/oidc-api-tokens.tf#L34-L42))*\n\nThe issue can be observed [here.](https://oidc-api-token.rubygems.org/gems/tob.gem)\n\n#### Exploit Scenario\n\nMallory finds out that the\n\ncompact-index.oregon.oidc-api-token.s3.rubygems.org S3 bucket is not registered. She registers it and stores malicious JavaScript payloads there. Mallory can conduct XSS-like attacks, try to circumvent CSRF protections, and exploit possible misconfigurations of the RubyGems.org application.\n\n#### Recommendations\n\nShort term, either claim the OIDC-related S3 buckets or remove relevant Fastly configurations.\n\nLong term, create a GitHub workflow that lists the S3 buckets referenced in the Fastly configuration. Check if the buckets are registered and if the owner of all the buckets is the expected AWS account.\n\n\nFor the first task (list S3 buckets), the terraform command can be used (the command is already used in the terraform.yml workflow). The second task requires AWS credentials; however, the terraform.yml workflow already has the github-actions-terraform AWS role, so it has necessary permissions for ownership checks.\n\nAlternatively, manage all S3 buckets exclusively through Terraform. With this change, all buckets will have to be referenced via variables (and not hard-coded ARN names), and if a bucket is deleted, it would not be possible to reference it.\n", "severity": "Medium", "difficulty": "High", "type": "Configuration", "finding_id": "TOB-RGM-29", "target": {"path": "rubygems-terraform/fastly/oidc-api-tokens.tf", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/sogilis/csv_fast_importer", "org": "sogilis", "name": "csv_fast_importer", "commit": "7343092dca117d7d85c2885b90edcabae7195f5f", "branch": null, "relative_file": "rubygems-terraform/fastly/oidc-api-tokens.tf", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "High", "Type": "Configuration", "Finding ID": "TOB-RGM-29", "Target": "rubygems-terraform/fastly/oidc-api-tokens.tf"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-030", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 30, "page_start": 70, "title": "IAM fastly user cannot list S3 objects", "short_summary": null, "description_md": "#### Description\n\nThe AWS fastly user does not have the s3:ListBucket permission for contents and compact-index buckets (in production and staging). As a result, an error is returned when opening, for example, the <https://gems.rubygemsusercontent.org/> URL. Moreover, the error is verbose and returns potentially sensitive information like AWS account ID and bucket name.\n\n*Figure 30.1: The error returned by Fastly for some websites*\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "| 30. IAM fastly user cannot list S3 objects |                              |\n|-----------------------------------------------------------------|------------------------------|\n| Severity: Informational                                      | Diffi culty: Low       |\n| Type: Error Reporting                                     | Finding ID: TOB-RGM-30 |\n| Target: AWS IAM, Fastly                                |                              |\n\n#### Description\n\nThe AWS fastly user does not have the s3:ListBucket permission for contents and compact-index buckets (in production and staging). As a result, an error is returned when opening, for example, the <https://gems.rubygemsusercontent.org/> URL. Moreover, the error is verbose and returns potentially sensitive information like AWS account ID and bucket name.\n\n*Figure 30.1: The error returned by Fastly for some websites*\n\n## Recommendations\n\nShort term, either add the s3:ListBucket permission to the fastly user or add a configuration to Fastly that would make the returned error less explicit.\n", "severity": "Informational", "difficulty": "Low", "type": "Error Reporting", "finding_id": "TOB-RGM-30", "target": {"path": "AWS IAM, Fastly", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/sogilis/csv_fast_importer", "org": "sogilis", "name": "csv_fast_importer", "commit": "7343092dca117d7d85c2885b90edcabae7195f5f", "branch": null, "relative_file": "AWS IAM, Fastly", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "Low", "Type": "Error Reporting", "Finding ID": "TOB-RGM-30", "Target": "AWS IAM, Fastly"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-031", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 31, "page_start": 71, "title": "No dual approval requirement for production deployments", "short_summary": null, "description_md": "#### Description\n\nThe RubyGems system is deployed in AWS based on Terraform files stored in the rubygems-terraform GitHub repository. Changes to the repository do not require dual approval (confirmation of changes by at least two people).\n\nMoreover, as the Wiki/Deploys [page informs](https://github.com/rubygems/rubygems-terraform/wiki/Deploys), application deployments to the EKS via the Shipit application also do not require dual approval.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "| 31. No dual approval requirement for production deployments |                              |\n|-------------------------------------------------------------------------------|------------------------------|\n| Severity: Medium                                                           | Diffi culty: High      |\n| Type: Access Controls                                                   | Finding ID: TOB-RGM-31 |\n| Target: AWS IAM, Fastly                                              |                              |\n\n#### Description\n\nThe RubyGems system is deployed in AWS based on Terraform files stored in the rubygems-terraform GitHub repository. Changes to the repository do not require dual approval (confirmation of changes by at least two people).\n\nMoreover, as the Wiki/Deploys [page informs](https://github.com/rubygems/rubygems-terraform/wiki/Deploys), application deployments to the EKS via the Shipit application also do not require dual approval.\n\n#### Exploit Scenario 1\n\nA GitHub user with access to the rubygems-terraform repository is compromised. The attacker makes changes to the Terraform files and pushes them to master. The GitHub Actions run the workflow that automatically updates AWS production resources. The attack goes unnoticed for a few days.\n\n#### Exploit Scenario 2\n\nAn honest user with access to the Shipit application makes a mistake and chooses a wrong commit for production deployment. A broken application is deployed. The RubyGems application is down for a few hours.\n\n#### Recommendations\n\nShort term, ensure that all users with access to the rubygems-terraform repository and Shipit application have 2FA enabled and follow GitHub's other security [recommendations.](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure) Ideally, developers should use only security keys/WebAuthn 2FA (instead of TOTP), and should manage their SSH keys with hardware security keys.\n\nImplement branch [protection](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule) rules for rubygems-terraform. At a minimum, require pull requests and an approval before merging, e.g.:\n\n- Require a pull request before merging\n  - At least one approval\n  - Dismiss stale pull request approvals when new commits are pushed\n\n\n\n- Require approval of the most recent reviewable push\n- Block force pushes\n\nBecause of the small size of the Ruby Central team, the above recommendation may not be viable: emergency changes would be paused until other team members—likely living in different time zones—would come online. On the other hand, emergency events should be rare.\n\nFor a more balanced solution, we recommend configuring the protections above and enabling \"break-glass\" access. The break-glass would allow bypassing branch protections, but in a noisy way: alerts to out-of-band services (like Slack or emails) would be sent, and other team members would be asked to review the PRs merged without approval when they come online. These notifications should be more visible than normal events (like regular PR merging).\n\nThis recommendation would not prevent attacks in case of GitHub account compromise, but would help the team to detect and respond to such incidents.\n\nA possible drawback is a user fatigue problem: if noisy alerts are sent too often, developers will start ignoring them. Therefore, this recommendation is only useful if the emergency PRs would be rare. If that is not currently the case, these recommendations should be reviewed again once the development process becomes more stable.\n\nAs for possible implementation, the [emergency-pull-request-probot-app](https://github.com/github/emergency-pull-request-probot-app) application could be used. Its security posture is undetermined, but since it is GitHub's application, it should be fine to use.\n\nFinally, there is the problem of a compromised GitHub account changing branch protection rules. If all developers are given full administrative rights to the repository, then all recommendations given above are effectively not useful: an attacker can first disable the protections, then introduce malicious changes, and then re-enable protections. We were unaware of the specific structure of the Ruby Central team during the audit, more consideration is required to determine the viability of the above recommendations. If the rubygems-terraform repository has too few maintainers, it is possible that [organization-level rulesets](https://docs.github.com/en/enterprise-server@3.11/organizations/managing-organization-settings/creating-rulesets-for-repositories-in-your-organization) can be used to protect the repository while making the \"break-glass\" solution useful.\n\nIf possible, configure dual approval requirements in the Shipit application, possibly with a similar \"break-glass\" mechanism.\n", "severity": "Medium", "difficulty": "High", "type": "Access Controls", "finding_id": "TOB-RGM-31", "target": {"path": "AWS IAM, Fastly", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/sogilis/csv_fast_importer", "org": "sogilis", "name": "csv_fast_importer", "commit": "7343092dca117d7d85c2885b90edcabae7195f5f", "branch": null, "relative_file": "AWS IAM, Fastly", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "High", "Type": "Access Controls", "Finding ID": "TOB-RGM-31", "Target": "AWS IAM, Fastly"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-032", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 32, "page_start": 73, "title": "The app-production user's API key has not been rotated for a long time", "short_summary": null, "description_md": "#### Description\n\nThe AWS access keys for the app-production and app-staging users were created about six years ago. These keys give write access to production/staging S3 buckets. Keys are mounted in K8s pods. The keys should be rotated as soon as possible. Moreover, the key should be rotated regularly at least once every two years.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "## 32. The app-production user's API key has not been rotated for a long time\n\n| Severity: Medium   | Diffi culty: High      |\n|-----------------------|------------------------------|\n| Type: Cryptography | Finding ID: TOB-RGM-32 |\n| Target: AWS IAM |                              |\n\n#### Description\n\nThe AWS access keys for the app-production and app-staging users were created about six years ago. These keys give write access to production/staging S3 buckets. Keys are mounted in K8s pods. The keys should be rotated as soon as possible. Moreover, the key should be rotated regularly at least once every two years.\n\n#### Exploit Scenario\n\nThe app-production user's API key was compromised a few years ago via undisclosed vulnerabilities in old versions of the RubyGems Rails application. An attacker kept the key unused until now. The attacker backdoors a few popular gems by manipulating S3 buckets' content.\n\n#### Recommendations\n\nShort term, manually rotate the API keys as soon as possible. Create a process for rotating the keys regularly, at least once every two years. Ideally, key rotation should be automated and done during every new deployment. Such automation will mitigate the risk of not rotating the key after a vulnerability fix.\n", "severity": "Medium", "difficulty": "High", "type": "Cryptography", "finding_id": "TOB-RGM-32", "target": {"path": "AWS IAM", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/github/emergency-pull-request-probot-app", "org": "github", "name": "emergency-pull-request-probot-app", "commit": null, "branch": null, "relative_file": "AWS IAM", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Medium", "Difficulty": "High", "Type": "Cryptography", "Finding ID": "TOB-RGM-32", "Target": "AWS IAM"}}
{"schema_version": "0.1", "scvd_id": "SCVD-trailofbits_2024-12-rubycentral-rubygemsorg-securityreview-033", "doc_id": "trailofbits_2024-12-rubycentral-rubygemsorg-securityreview", "finding_index": 33, "page_start": 74, "title": "Staging deployments are performed with a highly privileged K8s role", "short_summary": null, "description_md": "#### Description\n\nThe Shipit deployment application uses the shipit ServiceAccount to manage K8s deployments. The account is in the [cluster-admin](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/k8s-rbac.tf#L66-L83) groups of both staging and production [namespaces.](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/k8s-rbac.tf#L66-L83) The staging GitHub branch is [automatically](https://github.com/rubygems/rubygems-terraform/wiki/Deploys) deployed to the K8s staging environment. If a buggy configuration is pushed to the branch, it may impact production K8s resources.\n", "impact_md": null, "mitigation_md": null, "poc_md": null, "other_md": null, "full_markdown": "# 33. Staging deployments are performed with a highly privileged K8s role\n\n| Severity: Informational       | Diffi culty: High      |\n|----------------------------------|------------------------------|\n| Type: Access Controls      | Finding ID: TOB-RGM-33 |\n| Target: AWS EKS, shipit |                              |\n\n#### Description\n\nThe Shipit deployment application uses the shipit ServiceAccount to manage K8s deployments. The account is in the [cluster-admin](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/k8s-rbac.tf#L66-L83) groups of both staging and production [namespaces.](https://github.com/rubygems/rubygems-terraform/blob/9c22354c60ac59de9a2cad32c3f061e196350c29/modules/rubygems-org-app/k8s-rbac.tf#L66-L83) The staging GitHub branch is [automatically](https://github.com/rubygems/rubygems-terraform/wiki/Deploys) deployed to the K8s staging environment. If a buggy configuration is pushed to the branch, it may impact production K8s resources.\n\n#### Exploit Scenario 1\n\nA buggy K8s configuration is pushed to the staging branch. Shipit automatically deploys the changes. Production resources are accidentally impacted, and rubygems is down for a few hours.\n\n#### Recommendations\n\nShort term, create separate K8s accounts for staging and production environments. Make the staging deployments use the lower-privileged account. Details of the implementation depend on the Shipit features and the available configuration options.\n", "severity": "Informational", "difficulty": "High", "type": "Access Controls", "finding_id": "TOB-RGM-33", "target": {"path": "AWS EKS, shipit", "language": null, "chain": null, "contract_name": null, "contract_address": null, "function": null, "bytecode_hash": null, "caip_id": null}, "repo": {"url": "https://github.com/github/emergency-pull-request-probot-app", "org": "github", "name": "emergency-pull-request-probot-app", "commit": null, "branch": null, "relative_file": "AWS EKS, shipit", "lines": null}, "taxonomy": {"swc": [], "cwe": [], "tags": []}, "status": {"fix_status": null, "fixed_in_commit": null, "fixed_in_pr": [], "exploited_in_the_wild": null, "cvss": null, "bounty_reference": null}, "references": [], "provenance": {"source_pdf": "2024-12-rubycentral-rubygemsorg-securityreview.pdf", "source_mtime": "2025-11-01T12:04:44+00:00", "report_extracted_at": "2025-11-14T13:54:44.369250+00:00", "report_extractor_version": "poc-0.4", "report_extraction_tool": "marker+qwen3:8b", "scvd_normalized_at": "2025-11-14T13:54:44.380804+00:00", "scvd_normalizer_version": "poc-0.1"}, "metadata_raw": {"Severity": "Informational", "Difficulty": "High", "Type": "Access Controls", "Finding ID": "TOB-RGM-33", "Target": "AWS EKS, shipit"}}
